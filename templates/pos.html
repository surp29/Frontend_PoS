{% extends "base.html" %}

{% block title %}Bán hàng - PhanMemKeToan{% endblock %}

{% block page_title %}
<i class="fas fa-cash-register"></i> Bán hàng
{% endblock %}

{% block page_description %}
Hệ thống bán hàng - Point of Sale
{% endblock %}

{% block content %}
<div class="pos-container">
    <!-- Left Panel: Products Selection -->
    <div class="pos-left-panel">
        <!-- Filter Bar -->
        <div class="filter-bar">
            <div class="filter-row">
                <div class="form-group">
                    <label class="form-label">Tìm kiếm</label>
                    <div class="search-input">
                        <i class="fas fa-search"></i>
                        <input type="text" class="form-input" id="productSearch" placeholder="Tìm kiếm sản phẩm...">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Nhóm sản phẩm</label>
                    <select class="form-select" id="productGroupFilter">
                        <option value="">Tất cả nhóm</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <button class="btn btn-secondary" onclick="clearFilters()">
                        <i class="fas fa-times"></i>
                        Xóa bộ lọc
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Products Grid -->
        <div class="pos-products-grid" id="productsGrid">
            <!-- Products will be loaded here -->
        </div>
    </div>
    
    <!-- Right Panel: Cart and Payment -->
    <div class="pos-right-panel">
        <!-- Customer Info -->
        <div class="pos-customer-info">
            <h3><i class="fas fa-user"></i> Thông tin khách hàng</h3>
            <div class="customer-search-container">
                <div class="search-input">
                    <i class="fas fa-search"></i>
                    <input type="text" id="customerName" class="form-input" placeholder="Tìm kiếm hoặc nhập tên khách hàng" autocomplete="off" onkeypress="handleCustomerKeypress(event)">
                </div>
                <!-- Custom dropdown list -->
                <div class="customer-dropdown-list" id="customerDropdownList" style="display: none;">
                    <!-- Options will be populated dynamically -->
                </div>
            </div>
        </div>
        
        <!-- Cart -->
        <div class="pos-cart">
            <h3><i class="fas fa-shopping-cart"></i> Giỏ hàng</h3>
            <div class="cart-items" id="cartItems">
                <p class="empty-cart">Chưa có sản phẩm</p>
            </div>
            
            <div class="cart-totals">
                <div class="cart-total-line">
                    <span>Tổng tiền:</span>
                    <span id="cartSubtotal">0 VNĐ</span>
                </div>
                <div class="cart-total-line">
                    <span>Giảm giá:</span>
                    <div class="discount-section">
                        <button class="btn btn-sm btn-outline" onclick="toggleDiscountDropdown()">
                            <i class="fas fa-tags"></i>
                            Chọn mã giảm giá
                        </button>
                        <div class="discount-dropdown" id="discountDropdown" style="display: none;">
                            <!-- Discount codes will be loaded here -->
                        </div>
                        <div class="selected-discounts" id="selectedDiscounts">
                            <!-- Selected discount tags will be shown here -->
                        </div>
                        <span id="cartDiscount">0 VNĐ</span>
                    </div>
                </div>
                <div class="cart-total-line total">
                    <span>Thanh toán:</span>
                    <span id="cartTotal">0 VNĐ</span>
                </div>
            </div>
        </div>
        
        <!-- Payment Buttons -->
        <div class="pos-actions">
            <button class="btn btn-secondary" onclick="clearCart()">
                <i class="fas fa-trash"></i>
                Xóa giỏ hàng
            </button>
            <button class="btn btn-primary" onclick="processPayment()">
                <i class="fas fa-check"></i>
                Thanh toán
            </button>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal-overlay" id="paymentModal" style="display: none;">
    <div class="modal modal-large">
        <div class="modal-header">
            <h3><i class="fas fa-money-bill-wave"></i> Thanh toán</h3>
            <button class="modal-close" onclick="closePaymentModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <!-- Customer Info Section -->
            <div class="customer-info-section" style="margin-bottom: var(--spacing-6); padding-bottom: var(--spacing-4); border-bottom: 2px solid var(--gray-200);">
                <h4 style="margin-bottom: var(--spacing-3); color: var(--gray-700); display: flex; align-items: center; gap: var(--spacing-2);">
                    <i class="fas fa-user-circle" style="color: var(--primary-color);"></i>
                    Thông tin khách hàng
                </h4>
                <div class="customer-info-details">
                    <div class="customer-info-row">
                        <span class="info-label"><i class="fas fa-user"></i> Tên khách hàng:</span>
                        <span id="customerInfoName" class="info-value">-</span>
                    </div>
                    <div class="customer-info-row">
                        <span class="info-label"><i class="fas fa-phone"></i> Số điện thoại:</span>
                        <span id="customerInfoPhone" class="info-value">-</span>
                    </div>
                    <div class="customer-info-row">
                        <span class="info-label"><i class="fas fa-envelope"></i> Email:</span>
                        <span id="customerInfoEmail" class="info-value">-</span>
                    </div>
                </div>
            </div>
            
            <div class="payment-info">
                <div class="payment-row">
                    <span>Tổng tiền:</span>
                    <span id="paymentSubtotal" style="font-size: 1.1em; font-weight: 600; color: var(--gray-700);">0 VNĐ</span>
                </div>
                <div class="payment-row">
                    <span>Mã giảm giá:</span>
                    <div class="discount-info-payment">
                        <span id="paymentDiscountAmount" style="font-size: 1.1em; font-weight: 600; color: var(--success-color);">0 VNĐ</span>
                        <div id="paymentDiscountCodes" class="discount-codes-list" style="font-size: 0.9em; color: var(--gray-600); margin-top: 4px;">
                            <!-- Selected discount codes will be shown here -->
                        </div>
                    </div>
                </div>
                <div class="payment-row total-payment">
                    <span>Tổng thanh toán:</span>
                    <span id="paymentTotal" style="font-size: 1.3em; font-weight: 700; color: var(--primary-color);">0 VNĐ</span>
                </div>
                <div class="payment-row">
                    <span>Khách đưa:</span>
                    <div class="money-input-container">
                        <input type="text" id="amountReceived" class="form-input large-input" placeholder="0" 
                               oninput="formatMoneyInput(this)" 
                               onkeypress="return isNumberKey(event)">
                        <span class="currency-unit">VNĐ</span>
                    </div>
                </div>
                <div class="payment-row">
                    <span>Tiền thừa:</span>
                    <span id="changeAmount" class="change-amount" style="font-size: 1.2em;">0 VNĐ</span>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closePaymentModal()">Hủy</button>
            <button type="button" class="btn btn-primary" onclick="confirmPayment()">Xác nhận</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.pos-container {
    display: flex;
    gap: var(--spacing-4);
    height: calc(100vh - 120px);
}

.pos-left-panel {
    flex: 2;
    background: white;
    border-radius: var(--radius-lg);
    padding: var(--spacing-4);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* Filter bar styles are inherited from base.css */

.pos-products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: var(--spacing-3);
    overflow-y: auto;
    flex: 1;
}

.product-card {
    background: white;
    border: 2px solid var(--gray-200);
    border-radius: var(--radius-lg);
    padding: var(--spacing-3);
    cursor: pointer;
    transition: all var(--transition-normal);
    text-align: center;
    display: flex;
    flex-direction: column;
    aspect-ratio: 1;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.product-card:hover {
    border-color: var(--primary-color);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transform: translateY(-4px);
}

.product-image {
    width: 100%;
    height: 100px;
    object-fit: cover;
    border-radius: var(--radius);
    margin-bottom: var(--spacing-2);
    background: var(--gray-100);
    display: block;
    flex-shrink: 0;
}

.product-name {
    font-weight: 600;
    font-size: 13px;
    margin-bottom: var(--spacing-2);
    color: var(--gray-900);
    line-height: 1.4;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    min-height: 36px;
    flex-grow: 1;
}

.product-price {
    color: var(--primary-color);
    font-weight: 700;
    font-size: 13px;
    margin-bottom: var(--spacing-1);
}

.product-stock {
    font-size: 11px;
    color: var(--gray-600);
    padding: 4px 8px;
    background: var(--gray-100);
    border-radius: var(--radius);
    display: inline-block;
}

.pos-right-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: var(--spacing-4);
}

.pos-customer-info {
    background: white;
    border-radius: var(--radius-lg);
    padding: var(--spacing-4);
}

.pos-customer-info h3 {
    margin-bottom: var(--spacing-3);
    color: var(--gray-900);
}

.customer-search-container {
    position: relative;
}

.customer-dropdown-list {
    position: absolute;
    top: calc(100% + var(--spacing-1));
    left: 0;
    right: 0;
    background: white;
    border: 1px solid var(--gray-300);
    border-radius: var(--radius-md);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
    margin-top: var(--spacing-1);
}

.customer-dropdown-item {
    padding: var(--spacing-4);
    cursor: pointer;
    border-bottom: 1px solid var(--gray-200);
    transition: all var(--transition-normal);
}

.customer-dropdown-item:hover {
    background: var(--gray-50);
    border-left: 3px solid var(--primary-color);
}

.customer-dropdown-item:last-child {
    border-bottom: none;
}

.customer-dropdown-item.selected {
    background: var(--primary-50);
    border-left: 3px solid var(--primary-color);
}

.customer-dropdown-item strong {
    color: var(--gray-900);
    display: block;
    margin-bottom: var(--spacing-1);
}

.customer-dropdown-item small {
    color: var(--gray-600);
    font-size: var(--font-size-sm);
    display: block;
}

.customer-dropdown-item[data-value]:not([data-value="Khách vãng lai"]) {
    border-left: 3px solid var(--success-color);
}

.customer-dropdown-item[data-value]:not([data-value="Khách vãng lai"]):hover {
    background: var(--success-50);
}

.pos-cart {
    background: white;
    border-radius: var(--radius-lg);
    padding: var(--spacing-4);
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.pos-cart h3 {
    margin-bottom: var(--spacing-3);
    color: var(--gray-900);
}

.cart-items {
    flex: 1;
    overflow-y: auto;
    margin-bottom: var(--spacing-4);
}

.empty-cart {
    text-align: center;
    color: var(--gray-500);
    padding: var(--spacing-4);
}

.cart-item {
    display: flex;
    align-items: center;
    padding: var(--spacing-3);
    border-bottom: 1px solid var(--gray-200);
}

.cart-item-details {
    flex: 1;
}

.cart-item-name {
    font-weight: 600;
    color: var(--gray-900);
}

.cart-item-price {
    color: var(--gray-600);
    font-size: var(--font-size-sm);
}

.cart-item-actions {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
}

.cart-item-quantity {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
}

.quantity-btn {
    width: 30px;
    height: 30px;
    border: 1px solid var(--gray-300);
    background: white;
    border-radius: var(--radius);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.quantity-btn:hover {
    background: var(--gray-100);
}

.quantity-input {
    width: 40px;
    text-align: center;
    border: 1px solid var(--gray-300);
    border-radius: var(--radius);
    padding: var(--spacing-1);
}

.cart-totals {
    border-top: 2px solid var(--gray-300);
    padding-top: var(--spacing-3);
}

.cart-total-line {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--spacing-2);
    color: var(--gray-700);
    flex-wrap: wrap;
    gap: var(--spacing-2);
    min-height: 40px;
}

.cart-total-line.total {
    font-weight: 700;
    font-size: var(--font-size-lg);
    color: var(--primary-color);
    margin-top: var(--spacing-2);
    padding-top: var(--spacing-2);
    border-top: 1px solid var(--gray-300);
}

.pos-actions {
    display: flex;
    gap: var(--spacing-3);
}

.pos-actions .btn {
    flex: 1;
}

.payment-info {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-3);
}

.payment-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-2) 0;
}

.payment-row span:first-child {
    font-weight: 600;
    color: var(--gray-700);
}

.change-amount {
    font-weight: 700;
    color: var(--success-color);
}

.currency-unit {
    font-weight: 600;
    color: var(--gray-600);
    font-size: var(--font-size-sm);
}

/* Modal large for payment */
.modal-large {
    max-width: 600px;
    width: 90%;
}

.large-input {
    font-size: 1.5em;
    padding: var(--spacing-4);
    text-align: right;
    font-weight: 600;
}

.money-input-container {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
}

.money-input-container input {
    flex: 1;
}

.money-input-container .currency-unit {
    font-size: 1.2em;
    font-weight: 700;
    color: var(--primary-color);
}

/* Customer Info in Payment Modal */
.customer-info-section {
    background: var(--gray-50);
    border-radius: var(--radius-md);
    padding: var(--spacing-4);
}

.customer-info-details {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-2);
}

.customer-info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-2) 0;
}

.info-label {
    font-weight: 600;
    color: var(--gray-700);
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
}

.info-label i {
    width: 20px;
    color: var(--primary-color);
}

.info-value {
    font-weight: 500;
    color: var(--gray-900);
    text-align: right;
}

/* Payment modal discount info */
.discount-info-payment {
    text-align: right;
}

.discount-codes-list {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    justify-content: flex-end;
    margin-top: 4px;
}

.discount-code-tag {
    background: var(--success-color);
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.8em;
    font-weight: 500;
}

.payment-row.total-payment {
    border-top: 2px solid var(--primary-color);
    padding-top: var(--spacing-3);
    margin-top: var(--spacing-2);
    font-size: 1.1em;
}

/* Price list table in POS */
.pos-products-grid .table {
    border-collapse: collapse;
    width: 100%;
}

.pos-products-grid .table th,
.pos-products-grid .table td {
    padding: var(--spacing-3);
    text-align: left;
    border-bottom: 1px solid var(--gray-200);
}

.pos-products-grid .table th {
    background: var(--gray-50);
    font-weight: 600;
    color: var(--gray-900);
    position: sticky;
    top: 0;
}

.pos-products-grid .table tbody tr:hover {
    background: var(--gray-50);
}

/* Discount section styles */
.discount-section {
    display: flex;
    align-items: flex-start;
    gap: var(--spacing-2);
    position: relative;
    flex-wrap: wrap;
    width: 100%;
}

.discount-section > span:last-child {
    margin-left: auto;
    white-space: nowrap;
}


.discount-dropdown {
    position: absolute;
    bottom: calc(100% + var(--spacing-2));
    right: 0;
    background: white;
    border: 1px solid var(--gray-300);
    border-radius: var(--radius-md);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    max-height: 300px;
    overflow-y: auto;
    z-index: 10000;
    min-width: 350px;
    max-width: 500px;
}

.discount-item {
    padding: var(--spacing-3);
    border-bottom: 1px solid var(--gray-200);
    cursor: pointer;
    transition: all var(--transition-normal);
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
    position: relative;
}

.discount-item:hover {
    background: var(--gray-50);
}

.discount-item:last-child {
    border-bottom: none;
}

.discount-item.selected {
    background: var(--primary-50);
    border-left: 3px solid var(--primary-color);
}

.discount-item.selected::before {
    content: "✓";
    position: absolute;
    right: var(--spacing-3);
    top: 50%;
    transform: translateY(-50%);
    color: var(--primary-color);
    font-weight: bold;
    font-size: 16px;
}

.discount-info {
    flex: 1;
}

.discount-code {
    font-weight: 600;
    color: var(--primary-color);
    font-size: var(--font-size-sm);
}

.discount-name {
    font-size: var(--font-size-xs);
    color: var(--gray-600);
    margin-top: 2px;
}

.discount-value {
    font-weight: 600;
    color: var(--success-color);
    font-size: var(--font-size-sm);
}

.discount-conditions {
    font-size: var(--font-size-xs);
    color: var(--gray-500);
    margin-top: 2px;
}

.selected-discounts {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-1);
    width: 100%;
    order: 2;
    margin-top: var(--spacing-2);
}

.selected-discount-tag {
    background: var(--primary-color);
    color: white;
    padding: 4px 8px;
    border-radius: var(--radius);
    font-size: var(--font-size-xs);
    display: flex;
    align-items: center;
    gap: 4px;
}

.selected-discount-tag .remove-btn {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    padding: 0;
    margin-left: 4px;
}

.btn-outline {
    background: transparent;
    border: 1px solid var(--primary-color);
    color: var(--primary-color);
    padding: 6px 12px;
    border-radius: var(--radius);
    font-size: var(--font-size-sm);
    cursor: pointer;
    transition: all var(--transition-normal);
}

.btn-outline:hover {
    background: var(--primary-color);
    color: white;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function formatCurrency(amount) {
    if (!amount && amount !== 0) return '0 VNĐ';
    return new Intl.NumberFormat('vi-VN', {
        style: 'currency',
        currency: 'VND'
    }).format(amount);
}

// Global variables
let productsData = [];
let cart = [];
let currentCategory = 'all';
let productGroups = [];
let customersData = [];
let discountCodes = [];
let selectedDiscounts = [];

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadProducts();
    loadCustomers();
    loadDiscountCodes();
    // Setup dropdown events after a short delay to ensure elements are loaded
    setTimeout(setupCustomerDropdownEvents, 500);
});

// Load products
async function loadProducts() {
    try {
        const response = await fetch('{{ BACKEND_URL }}/api/products/');
        if (response.ok) {
            const result = await response.json();
            productsData = result.products || [];
            
            // Load product groups after products are loaded
            loadProductGroups();
            
            renderProducts();
        }
    } catch (error) {
        console.error('Error loading products:', error);
    }
}

// Load customers
async function loadCustomers() {
    try {
        const response = await fetch('{{ BACKEND_URL }}/api/accounts/');
        if (response.ok) {
            customersData = await response.json();
            populateCustomerList();
        }
    } catch (error) {
        console.error('Error loading customers:', error);
    }
}

// Load discount codes
async function loadDiscountCodes() {
    try {
        const response = await fetch('{{ BACKEND_URL }}/api/discount-codes/');
        if (response.ok) {
            discountCodes = await response.json();
        }
    } catch (error) {
        console.error('Error loading discount codes:', error);
    }
}

// Populate customer dropdown
function populateCustomerList(searchTerm = '') {
    const dropdownList = document.getElementById('customerDropdownList');
    const customerInput = document.getElementById('customerName');
    
    dropdownList.innerHTML = '';
    
    // Get filtered active customers
    let activeCustomers = customersData.filter(c => c.trang_thai === true || c.trang_thai === 'true');
    
    // Filter by search term if provided
    if (searchTerm) {
        const searchLower = searchTerm.toLowerCase();
        activeCustomers = activeCustomers.filter(c => {
            const name = (c.ten_tk || '').toLowerCase();
            const email = (c.email || '').toLowerCase();
            const phone = (c.so_dt || '').toLowerCase();
            return name.includes(searchLower) || email.includes(searchLower) || phone.includes(searchLower);
        });
    }
    
    // Add "Khách vãng lai" first (always show)
    const walkInDiv = document.createElement('div');
    walkInDiv.className = 'customer-dropdown-item';
    walkInDiv.dataset.value = 'Khách vãng lai';
    walkInDiv.innerHTML = '<strong>Khách vãng lai</strong>';
    walkInDiv.onclick = function() {
        selectCustomer('Khách vãng lai');
        toggleDropdown();
    };
    dropdownList.appendChild(walkInDiv);
    
    // Add active customers
    if (activeCustomers.length === 0 && searchTerm) {
        // Show option to use typed name as customer name
        const customCustomerDiv = document.createElement('div');
        customCustomerDiv.className = 'customer-dropdown-item';
        customCustomerDiv.dataset.value = searchTerm;
        customCustomerDiv.innerHTML = `<strong>Thêm khách hàng: "${searchTerm}"</strong><small>Nhấn Enter để sử dụng</small>`;
        customCustomerDiv.onclick = function() {
            selectCustomer(searchTerm);
            toggleDropdown();
        };
        dropdownList.appendChild(customCustomerDiv);
        
        const noResult = document.createElement('div');
        noResult.className = 'customer-dropdown-item';
        noResult.innerHTML = '<small style="color: var(--gray-500);">Không tìm thấy khách hàng có sẵn</small>';
        dropdownList.appendChild(noResult);
    } else {
        activeCustomers.forEach(customer => {
            const name = customer.ten_tk || '';
            const email = customer.email || '';
            const phone = customer.so_dt || '';
            
            const item = document.createElement('div');
            item.className = 'customer-dropdown-item';
            item.dataset.value = name;
            
            let displayText = `<strong>${name}</strong>`;
            if (email) {
                displayText += `<small>${email}</small>`;
            } else if (phone) {
                displayText += `<small>${phone}</small>`;
            }
            
            item.innerHTML = displayText;
            item.onclick = function() {
                selectCustomer(name);
                toggleDropdown();
            };
            
            dropdownList.appendChild(item);
        });
        
        // If user is typing and there are results, also show option to use typed name
        if (searchTerm && activeCustomers.length > 0) {
            const customCustomerDiv = document.createElement('div');
            customCustomerDiv.className = 'customer-dropdown-item';
            customCustomerDiv.dataset.value = searchTerm;
            customCustomerDiv.innerHTML = `<strong>Thêm khách hàng: "${searchTerm}"</strong><small>Nhấn Enter để sử dụng</small>`;
            customCustomerDiv.onclick = function() {
                selectCustomer(searchTerm);
                toggleDropdown();
            };
            dropdownList.appendChild(customCustomerDiv);
        }
    }
}

// Handle customer input keypress
function handleCustomerKeypress(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        const customerInput = document.getElementById('customerName');
        const searchTerm = customerInput.value.trim();
        
        if (searchTerm) {
            // If user typed something, use that as customer name
            selectCustomer(searchTerm);
            toggleDropdown();
        } else {
            // If empty, select "Khách vãng lai"
            selectCustomer('Khách vãng lai');
            toggleDropdown();
        }
    }
}

// Toggle dropdown
function toggleDropdown() {
    const dropdown = document.getElementById('customerDropdownList');
    if (dropdown) {
        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
    }
}

// Select customer
function selectCustomer(customerName) {
    const customerInput = document.getElementById('customerName');
    
    if (customerInput) {
        customerInput.value = customerName;
    }
    
    // Repopulate dropdown to show all customers again
    populateCustomerList();
}

// Setup customer input events after load
function setupCustomerDropdownEvents() {
    const customerInput = document.getElementById('customerName');
    const dropdown = document.getElementById('customerDropdownList');
    
    if (customerInput && dropdown) {
        // Click on input to show dropdown
        customerInput.addEventListener('click', function() {
            const searchTerm = customerInput.value;
            populateCustomerList(searchTerm);
            dropdown.style.display = 'block';
            highlightMatchedCustomer(searchTerm);
        });
        
        // Focus on input to show dropdown and all customers
        customerInput.addEventListener('focus', function() {
            const searchTerm = customerInput.value;
            populateCustomerList(searchTerm);
            dropdown.style.display = 'block';
            highlightMatchedCustomer(searchTerm);
        });
        
        // Real-time search as user types - always show dropdown when typing
        customerInput.addEventListener('input', function() {
            const searchTerm = customerInput.value;
            populateCustomerList(searchTerm);
            dropdown.style.display = 'block';
            highlightMatchedCustomer(searchTerm);
        });
        
        // Handle keydown for better UX
        customerInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                dropdown.style.display = 'none';
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                // Focus first item in dropdown
                const firstItem = dropdown.querySelector('.customer-dropdown-item');
                if (firstItem) {
                    firstItem.focus();
                }
            }
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!customerInput.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
            }
            
            // Close discount dropdown when clicking outside
            const discountDropdown = document.getElementById('discountDropdown');
            const discountButton = document.querySelector('[onclick="toggleDiscountDropdown()"]');
            if (discountDropdown && discountButton && 
                !discountDropdown.contains(e.target) && 
                !discountButton.contains(e.target)) {
                discountDropdown.style.display = 'none';
            }
        });
    }
}

// Function to highlight matched customer
function highlightMatchedCustomer(searchTerm) {
    if (!searchTerm || searchTerm.trim() === '') {
        return; // Don't highlight anything if search term is empty
    }
    
    const dropdown = document.getElementById('customerDropdownList');
    if (!dropdown) return;
    
    // Clear all highlights
    const items = dropdown.querySelectorAll('.customer-dropdown-item');
    items.forEach(item => item.classList.remove('selected'));
    
    // Find and highlight matching customer
    searchTerm = searchTerm.trim().toLowerCase();
    const matchingItem = Array.from(items).find(item => {
        const value = (item.dataset.value || '').toLowerCase();
        return value === searchTerm || value.includes(searchTerm);
    });
    
    if (matchingItem) {
        matchingItem.classList.add('selected');
    }
}

// Load product groups from products data
function loadProductGroups() {
    // Get unique groups from products
    const groupsSet = new Set();
    productsData.forEach(product => {
        if (product.nhom_sp && product.nhom_sp.trim()) {
            groupsSet.add(product.nhom_sp);
        }
    });
    
    productGroups = Array.from(groupsSet).sort();
    
    // Create filter buttons dynamically
    renderCategoryFilters();
}

// Populate category filter dropdown
function renderCategoryFilters() {
    const groupFilter = document.getElementById('productGroupFilter');
    
    // Clear existing options except "Tất cả nhóm"
    groupFilter.innerHTML = '<option value="">Tất cả nhóm</option>';
    
    // Add product group options
    productGroups.forEach(group => {
        const option = document.createElement('option');
        option.value = group;
        option.textContent = group;
        groupFilter.appendChild(option);
    });
    
    // Add "Bảng giá" option
    const priceOption = document.createElement('option');
    priceOption.value = 'prices';
    priceOption.textContent = 'Bảng giá';
    groupFilter.appendChild(priceOption);
    
    // Add event listener for filter changes
    groupFilter.addEventListener('change', function() {
        const selectedValue = this.value;
        if (selectedValue) {
            filterByCategory(selectedValue);
        } else {
            filterByCategory('all');
        }
    });
}

// Render products
async function renderProducts() {
    const grid = document.getElementById('productsGrid');
    
    // If "prices" category, show price list
    if (currentCategory === 'prices') {
        await renderPriceList();
        return;
    }
    
    const filteredProducts = currentCategory === 'all' 
        ? productsData.filter(p => (p.so_luong || 0) > 0)
        : productsData.filter(p => (p.so_luong || 0) > 0 && p.nhom_sp === currentCategory);
    
    if (filteredProducts.length === 0) {
        grid.innerHTML = '<p class="empty-cart">Không có sản phẩm</p>';
        return;
    }
    
    grid.innerHTML = filteredProducts.map(product => {
        // Escape HTML to prevent XSS
        const name = product.ten_sp || 'N/A';
        const price = formatCurrency(product.gia_ban);
        const stock = product.so_luong || 0;
        
        // Construct full image URL from backend
        let imageUrl = '/static/images/products/default.png';
        if (product.image_url) {
            // If image_url is already full URL, use it; otherwise construct from backend
            if (product.image_url.startsWith('http://') || product.image_url.startsWith('https://')) {
                imageUrl = product.image_url;
            } else {
                imageUrl = `http://localhost:5001${product.image_url}`;
            }
        }
        
        return `
        <div class="product-card" data-product-id="${product.id}">
            <img src="${imageUrl}" 
                 alt="${name.replace(/"/g, '&quot;')}" 
                 class="product-image"
                 onerror="this.src='/static/images/products/default.png'; this.style.display='block';">
            <div class="product-name">${name}</div>
            <div class="product-price">${price}</div>
            <div class="product-stock">Còn: ${stock}</div>
        </div>
        `;
    }).join('');
    
    // Add click event listeners to prevent multiple handlers
    document.querySelectorAll('.product-card').forEach(card => {
        card.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const productId = parseInt(this.getAttribute('data-product-id'));
            if (productId) {
                addToCart(productId);
            }
        });
    });
}

// Render price list
async function renderPriceList() {
    const grid = document.getElementById('productsGrid');
    
    try {
        const response = await fetch('{{ BACKEND_URL }}/api/prices/');
        if (response.ok) {
            const data = await response.json();
            
            // Handle different response formats
            let prices = [];
            if (Array.isArray(data)) {
                prices = data;
            } else if (data.prices && Array.isArray(data.prices)) {
                prices = data.prices;
            } else if (data.success && Array.isArray(data)) {
                prices = data;
            }
            
            console.log('Prices data:', prices);
            
            if (!prices || prices.length === 0) {
                grid.innerHTML = '<p class="empty-cart">Chưa có bảng giá</p>';
                return;
            }
            
            grid.innerHTML = `
                <div style="width: 100%; overflow-x: auto;">
                    <table class="table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Mã SP</th>
                                <th>Tên SP</th>
                                <th>Giá chung</th>
                                <th>Ghi chú</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${prices.map((price, index) => `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td><strong>${price.ma_sp || '-'}</strong></td>
                                    <td>${price.ten_sp || '-'}</td>
                                    <td><strong>${(price.gia_chung || 0).toLocaleString()} VNĐ</strong></td>
                                    <td>${price.ghi_chu || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        } else {
            grid.innerHTML = '<p class="empty-cart">Không thể tải bảng giá</p>';
        }
    } catch (error) {
        console.error('Error loading prices:', error);
        grid.innerHTML = '<p class="empty-cart">Không thể tải bảng giá</p>';
    }
}

// Add to cart
function addToCart(productId) {
    const product = productsData.find(p => p.id === productId);
    if (!product) return;
    
    const existingItem = cart.find(item => item.id === productId);
    if (existingItem) {
        if (existingItem.quantity < product.so_luong) {
            existingItem.quantity++;
        }
    } else {
        cart.push({
            id: product.id,
            name: product.ten_sp,
            code: product.ma_sp || '',
            price: product.gia_ban,
            quantity: 1,
            stock: product.so_luong
        });
    }
    
    renderCart();
}

// Remove from cart
function removeFromCart(productId) {
    cart = cart.filter(item => item.id !== productId);
    renderCart();
}

// Update quantity
function updateQuantity(productId, delta) {
    const item = cart.find(item => item.id === productId);
    if (!item) return;
    
    const newQuantity = item.quantity + delta;
    if (newQuantity <= 0) {
        removeFromCart(productId);
    } else if (newQuantity <= item.stock) {
        item.quantity = newQuantity;
    }
    
    renderCart();
}

// Render cart
function renderCart() {
    const cartItems = document.getElementById('cartItems');
    
    if (cart.length === 0) {
        cartItems.innerHTML = '<p class="empty-cart">Chưa có sản phẩm</p>';
        document.getElementById('cartSubtotal').textContent = '0 VNĐ';
        document.getElementById('cartDiscount').textContent = '0 VNĐ';
        document.getElementById('cartTotal').textContent = '0 VNĐ';
        return;
    }
    
    let subtotal = 0;
    cartItems.innerHTML = cart.map(item => {
        const itemTotal = item.price * item.quantity;
        subtotal += itemTotal;
        
        return `
            <div class="cart-item">
                <div class="cart-item-details">
                    <div class="cart-item-name">${item.name}</div>
                    <div class="cart-item-price">${formatCurrency(item.price)} x ${item.quantity}</div>
                </div>
                <div class="cart-item-actions">
                    <div class="cart-item-quantity">
                        <button class="quantity-btn" onclick="updateQuantity(${item.id}, -1)">-</button>
                        <input type="number" class="quantity-input" value="${item.quantity}" 
                               onchange="setQuantity(${item.id}, this.value)">
                        <button class="quantity-btn" onclick="updateQuantity(${item.id}, 1)">+</button>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="removeFromCart(${item.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    const totalDiscount = selectedDiscounts.reduce((sum, discount) => sum + discount.amount, 0);
    const total = Math.max(0, subtotal - totalDiscount);
    
    document.getElementById('cartSubtotal').textContent = formatCurrency(subtotal);
    document.getElementById('cartDiscount').textContent = formatCurrency(totalDiscount);
    document.getElementById('cartTotal').textContent = formatCurrency(total);
}

// Set quantity
function setQuantity(productId, value) {
    const item = cart.find(item => item.id === productId);
    if (!item) return;
    
    const quantity = parseInt(value);
    if (quantity <= 0) {
        removeFromCart(productId);
    } else if (quantity <= item.stock) {
        item.quantity = quantity;
    }
    
    renderCart();
}

// Clear cart
function clearCart() {
    showConfirm('Xác nhận', 'Bạn có chắc chắn muốn xóa giỏ hàng?', function() {
        cart = [];
        renderCart();
    });
}

// Search products
function searchProducts() {
    const searchTerm = document.getElementById('productSearch').value.toLowerCase();
    
    const grid = document.getElementById('productsGrid');
    
    // If searching in price list, show price list
    if (currentCategory === 'prices') {
        renderPriceList();
        return;
    }
    
    // Filter products by search term
    let filteredProducts = currentCategory === 'all' 
        ? productsData.filter(p => (p.so_luong || 0) > 0)
        : productsData.filter(p => (p.so_luong || 0) > 0 && p.nhom_sp === currentCategory);
    
    // Apply search filter
    if (searchTerm) {
        filteredProducts = filteredProducts.filter(p => 
            (p.ten_sp && p.ten_sp.toLowerCase().includes(searchTerm)) ||
            (p.ma_sp && p.ma_sp.toLowerCase().includes(searchTerm))
        );
    }
    
    if (filteredProducts.length === 0) {
        grid.innerHTML = '<p class="empty-cart">Không tìm thấy sản phẩm</p>';
        return;
    }
    
    // Render filtered products
    grid.innerHTML = filteredProducts.map(product => {
        const name = product.ten_sp || 'N/A';
        const price = formatCurrency(product.gia_ban);
        const stock = product.so_luong || 0;
        
        let imageUrl = '/static/images/products/default.png';
        if (product.image_url) {
            if (product.image_url.startsWith('http://') || product.image_url.startsWith('https://')) {
                imageUrl = product.image_url;
            } else {
                imageUrl = `http://localhost:5001${product.image_url}`;
            }
        }
        
        return `
        <div class="product-card" data-product-id="${product.id}">
            <img src="${imageUrl}" 
                 alt="${name.replace(/"/g, '&quot;')}" 
                 class="product-image"
                 onerror="this.src='/static/images/products/default.png'; this.style.display='block';">
            <div class="product-name">${name}</div>
            <div class="product-price">${price}</div>
            <div class="product-stock">Còn: ${stock}</div>
        </div>
        `;
    }).join('');
    
    // Add click event listeners
    document.querySelectorAll('.product-card').forEach(card => {
        card.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const productId = parseInt(this.getAttribute('data-product-id'));
            if (productId) {
                addToCart(productId);
            }
        });
    });
}

// Clear filters
function clearFilters() {
    document.getElementById('productSearch').value = '';
    document.getElementById('productGroupFilter').value = '';
    currentCategory = 'all';
    renderProducts();
}

// Filter by category
function filterByCategory(category) {
    currentCategory = category;
    
    // Update dropdown selection
    const groupFilter = document.getElementById('productGroupFilter');
    if (groupFilter) {
        groupFilter.value = category === 'all' ? '' : category;
    }
    
    renderProducts();
}

// Process payment
function processPayment() {
    if (cart.length === 0) {
        showErrorModal('Lỗi', 'Giỏ hàng trống');
        return;
    }
    
    // Get customer info
    const customerName = document.getElementById('customerName').value || 'Khách vãng lai';
    const selectedCustomer = customersData.find(c => c.ten_tk === customerName);
    
    // Display customer info in modal
    document.getElementById('customerInfoName').textContent = customerName;
    
    if (selectedCustomer) {
        document.getElementById('customerInfoPhone').textContent = selectedCustomer.so_dt || '-';
        document.getElementById('customerInfoEmail').textContent = selectedCustomer.email || '-';
    } else {
        document.getElementById('customerInfoPhone').textContent = '-';
        document.getElementById('customerInfoEmail').textContent = '-';
    }
    
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const totalDiscount = selectedDiscounts.reduce((sum, discount) => sum + discount.amount, 0);
    const total = Math.max(0, subtotal - totalDiscount);
    
    // Update payment modal with discount info
    document.getElementById('paymentSubtotal').textContent = formatCurrency(subtotal);
    document.getElementById('paymentDiscountAmount').textContent = formatCurrency(totalDiscount);
    document.getElementById('paymentTotal').textContent = formatCurrency(total);
    
    // Show selected discount codes
    const discountCodesContainer = document.getElementById('paymentDiscountCodes');
    if (selectedDiscounts.length > 0) {
        discountCodesContainer.innerHTML = selectedDiscounts.map(discount => 
            `<span class="discount-code-tag">${discount.code}</span>`
        ).join('');
    } else {
        discountCodesContainer.innerHTML = '<span style="color: var(--gray-500);">Không có mã giảm giá</span>';
    }
    
    document.getElementById('amountReceived').value = '';
    document.getElementById('changeAmount').textContent = '0 VNĐ';
    
    document.getElementById('paymentModal').style.display = 'flex';
}

// Close payment modal
function closePaymentModal() {
    document.getElementById('paymentModal').style.display = 'none';
}

// Confirm payment
async function confirmPayment() {
    const received = parseInt(document.getElementById('amountReceived').value.replace(/,/g, '')) || 0;
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const totalDiscount = selectedDiscounts.reduce((sum, discount) => sum + discount.amount, 0);
    const total = Math.max(0, subtotal - totalDiscount);
    
    if (received < total) {
        showErrorModal('Lỗi', 'Số tiền nhận không đủ');
        return;
    }
    
    try {
        const customerName = document.getElementById('customerName').value || 'Khách vãng lai';

        // ONLY fetch, hiển thị UI payment modal, submit cho backend API. Không phép tính business, chỉ nhận json trả ra và render.
        const paymentPayload = {
            customer_name: customerName,
            total: total,
            discount_codes: selectedDiscounts.map(d => d.code) // Assuming discount_codes is an array of code strings
        };

        const response = await fetch('{{ BACKEND_URL }}/api/invoices/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`
            },
            body: JSON.stringify(paymentPayload)
        });

        if (response.ok) {
            const result = await response.json();
            console.log('Payment successful:', result);
            showSuccessModal('Thanh toán thành công', 'Hóa đơn đã được phát hành.');
            
            // Clear cart and close modal
            cart = [];
            renderCart();
            closePaymentModal();
            
            // Refresh data (if needed, e.g., update stock)
            // loadProducts(); 
            // loadCustomers(); 
            
        } else {
            const errorText = await response.text();
            console.error('Payment failed:', errorText);
            showErrorModal('Lỗi', `Thanh toán thất bại: ${errorText}`);
        }
    } catch (error) {
        console.error('Lỗi xử lý thanh toán:', error);
        showErrorModal('Lỗi', 'Đã xảy ra lỗi trong quá trình thanh toán. Vui lòng thử lại.');
    }
}

// Discount code functions
function toggleDiscountDropdown() {
    const dropdown = document.getElementById('discountDropdown');
    if (dropdown.style.display === 'none') {
        loadDiscountDropdown();
        dropdown.style.display = 'block';
    } else {
        dropdown.style.display = 'none';
    }
}

function loadDiscountDropdown() {
    const dropdown = document.getElementById('discountDropdown');
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    
    if (discountCodes.length === 0) {
        dropdown.innerHTML = '<div class="discount-item"><div class="discount-info">Không có mã giảm giá nào</div></div>';
        return;
    }
    
    // Filter applicable discount codes
    const applicableCodes = discountCodes.filter(code => {
        const now = new Date();
        const startDate = new Date(code.start_date);
        const endDate = new Date(code.end_date);
        
        // Check if code is active and within date range
        if (code.status !== 'active' || now < startDate || now > endDate) {
            return false;
        }
        
        // Check minimum order value
        if (code.min_order_value && subtotal < code.min_order_value) {
            return false;
        }
        
        // Check max uses
        if (code.max_uses && code.used_count >= code.max_uses) {
            return false;
        }
        
        return true;
    });
    
    if (applicableCodes.length === 0) {
        dropdown.innerHTML = '<div class="discount-item"><div class="discount-info">Không có mã giảm giá phù hợp</div></div>';
        return;
    }
    
    dropdown.innerHTML = applicableCodes.map(code => {
        const isSelected = selectedDiscounts.some(d => d.id === code.id);
        const discountAmount = calculateDiscountAmount(code, subtotal);
        
        return `
            <div class="discount-item ${isSelected ? 'selected' : ''}" onclick="toggleDiscountCode(${code.id})">
                <div class="discount-info">
                    <div class="discount-code">${code.code}</div>
                    <div class="discount-name">${code.name}</div>
                    <div class="discount-conditions">
                        ${code.min_order_value ? `Từ ${code.min_order_value.toLocaleString()} VNĐ` : ''}
                        ${code.max_uses ? ` • Còn ${code.max_uses - code.used_count} lượt` : ''}
                    </div>
                </div>
                <div class="discount-value">
                    ${formatDiscountValue(code, discountAmount)}
                </div>
            </div>
        `;
    }).join('');
}

function toggleDiscountCode(codeId) {
    const code = discountCodes.find(c => c.id === codeId);
    if (!code) return;
    
    const existingIndex = selectedDiscounts.findIndex(d => d.id === codeId);
    
    if (existingIndex >= 0) {
        // Remove from selected
        selectedDiscounts.splice(existingIndex, 1);
    } else {
        // Add to selected
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const discountAmount = calculateDiscountAmount(code, subtotal);
        selectedDiscounts.push({
            id: code.id,
            code: code.code,
            name: code.name,
            discount_type: code.discount_type,
            discount_value: code.discount_value,
            amount: discountAmount
        });
    }
    
    updateDiscountDisplay();
    renderCart();
}

function calculateDiscountAmount(code, subtotal) {
    if (code.discount_type === 'percentage') {
        return (subtotal * code.discount_value) / 100;
    } else {
        return Math.min(code.discount_value, subtotal);
    }
}

function formatDiscountValue(code, amount) {
    if (code.discount_type === 'percentage') {
        return `-${code.discount_value}% (${formatCurrency(amount)})`;
    } else {
        return `-${formatCurrency(amount)}`;
    }
}

function updateDiscountDisplay() {
    const totalDiscount = selectedDiscounts.reduce((sum, discount) => sum + discount.amount, 0);
    document.getElementById('cartDiscount').textContent = formatCurrency(totalDiscount);
    
    // Update selected discounts display
    const selectedContainer = document.getElementById('selectedDiscounts');
    if (selectedContainer) {
        if (selectedDiscounts.length === 0) {
            selectedContainer.innerHTML = '';
        } else {
            selectedContainer.innerHTML = selectedDiscounts.map(discount => `
                <div class="selected-discount-tag">
                    ${discount.code}
                    <button class="remove-btn" onclick="removeDiscount(${discount.id})">×</button>
                </div>
            `).join('');
        }
    }
}

function removeDiscount(codeId) {
    selectedDiscounts = selectedDiscounts.filter(d => d.id !== codeId);
    updateDiscountDisplay();
    renderCart();
}
</script>
{% endblock %}
