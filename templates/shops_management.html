{% extends "base.html" %}

{% block title %}Qu·∫£n l√Ω shop - PhanMemKeToan{% endblock %}

{% block page_title %}
<i class="fas fa-store"></i> Qu·∫£n l√Ω shop
{% endblock %}

{% block page_description %}
T·∫°o v√† qu·∫£n l√Ω c√°c shop, theo d√µi th√¥ng tin chi ti·∫øt t·ª´ng shop
{% endblock %}

{% block content %}
<!-- Statistics Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-store"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="totalShops">0</div>
            <div class="stat-label">T·ªïng shop</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-map-marker-alt"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="activeShops">0</div>
            <div class="stat-label">ƒêang ho·∫°t ƒë·ªông</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-city"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="cityShops">0</div>
            <div class="stat-label">Th√†nh ph·ªë</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-users"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="totalManagers">0</div>
            <div class="stat-label">Ng∆∞·ªùi qu·∫£n l√Ω</div>
        </div>
    </div>
</div>

<!-- Create Shop Form -->
<div class="card">
    <div class="card-header">
        <h3><i class="fas fa-plus-circle"></i> T·∫°o shop m·ªõi</h3>
    </div>
    <div class="card-body">
        <form id="createShopForm">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">T√™n shop *</label>
                    <input type="text" class="form-input" name="name" required placeholder="Nh·∫≠p t√™n shop">
                </div>
                <div class="form-group">
                    <label class="form-label">M√£ shop *</label>
                    <input type="text" class="form-input" name="code" required placeholder="Nh·∫≠p m√£ shop">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Khu v·ª±c *</label>
                    <select class="form-select" name="area_id" required>
                        <option value="">Ch·ªçn khu v·ª±c</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">ƒê·ªãa ch·ªâ *</label>
                <textarea class="form-textarea" name="address" rows="3" required placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ shop"></textarea>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                    <input type="tel" class="form-input" data-phone name="phone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" name="email" placeholder="Nh·∫≠p email">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Ng∆∞·ªùi qu·∫£n l√Ω</label>
                    <input type="text" class="form-input" name="manager" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi qu·∫£n l√Ω">
                </div>
                <div class="form-group">
                    <label class="form-label">Tr·∫°ng th√°i</label>
                    <select class="form-select" name="status">
                        <option value="active">Ho·∫°t ƒë·ªông</option>
                        <option value="inactive">Kh√¥ng ho·∫°t ƒë·ªông</option>
                        <option value="maintenance">B·∫£o tr√¨</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">M√¥ t·∫£</label>
                <textarea class="form-textarea" name="description" rows="3" placeholder="M√¥ t·∫£ shop"></textarea>
            </div>
            
            <div class="form-group">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-plus"></i>
                    T·∫°o shop
                </button>
                <button type="button" class="btn btn-secondary" onclick="resetForm()">
                    <i class="fas fa-undo"></i>
                    L√†m m·ªõi
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Filter Bar -->
<div class="filter-bar">
    <div class="filter-row">
        <div class="form-group">
            <label class="form-label">T√¨m ki·∫øm</label>
            <div class="search-input">
                <i class="fas fa-search"></i>
                <input type="text" class="form-input" id="searchShop" placeholder="T√¨m theo t√™n, m√£, ƒë·ªãa ch·ªâ...">
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Khu v·ª±c</label>
            <select class="form-select" id="areaFilter">
                <option value="">T·∫•t c·∫£ khu v·ª±c</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">Tr·∫°ng th√°i</label>
            <select class="form-select" id="statusFilter">
                <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                <option value="active">Ho·∫°t ƒë·ªông</option>
                <option value="inactive">Kh√¥ng ho·∫°t ƒë·ªông</option>
                <option value="maintenance">B·∫£o tr√¨</option>
            </select>
        </div>
        
        <div class="form-group">
            <button class="btn btn-secondary" onclick="clearFilters()">
                <i class="fas fa-times"></i>
                X√≥a b·ªô l·ªçc
            </button>
        </div>
    </div>
</div>

<!-- Shops Table -->
<div class="table-container">
    <div class="card">
        <div class="card-header">
            <h3>Danh s√°ch shop</h3>
        </div>
        <div class="card-body p-0">
            <table class="table" id="shopsTable">
                <thead>
                    <tr>
                        <th>M√£ shop</th>
                        <th>T√™n shop</th>
                        <th>Khu v·ª±c</th>
                        <th>ƒê·ªãa ch·ªâ</th>
                        <th>SƒêT</th>
                        <th>Email</th>
                        <th>Qu·∫£n l√Ω</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>Thao t√°c</th>
                    </tr>
                </thead>
                <tbody id="shopsTableBody">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Pagination -->
<div class="pagination" id="pagination">
    <!-- Pagination will be generated here -->
</div>

<!-- View Shop Modal -->
<div class="modal-overlay" id="viewShopModal" style="display: none;">
    <div class="modal modal-large">
        <div class="modal-header">
            <h3><i class="fas fa-eye"></i> Chi ti·∫øt shop</h3>
            <button class="modal-close" onclick="closeViewShopModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div id="shopDetails">
                <!-- Shop details will be loaded here -->
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeViewShopModal()">ƒê√≥ng</button>
        </div>
    </div>
</div>

<!-- Edit Shop Modal -->
<div class="modal-overlay" id="editShopModal" style="display: none;">
    <div class="modal modal-horizontal">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Ch·ªânh s·ª≠a shop</h3>
            <button class="modal-close" onclick="closeEditShopModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="editShopForm">
                <input type="hidden" name="id">
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">T√™n shop *</label>
                        <input type="text" class="form-input" name="name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">M√£ shop *</label>
                        <input type="text" class="form-input" name="code" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Khu v·ª±c *</label>
                        <select class="form-select" name="area_id" required>
                            <option value="">Ch·ªçn khu v·ª±c</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                        <input type="tel" class="form-input" data-phone name="phone">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" name="email">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Ng∆∞·ªùi qu·∫£n l√Ω</label>
                        <input type="text" class="form-input" name="manager">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tr·∫°ng th√°i</label>
                        <select class="form-select" name="status">
                            <option value="active">Ho·∫°t ƒë·ªông</option>
                            <option value="inactive">Kh√¥ng ho·∫°t ƒë·ªông</option>
                            <option value="maintenance">B·∫£o tr√¨</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ƒê·ªãa ch·ªâ *</label>
                    <textarea class="form-textarea" name="address" rows="3" required></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">M√¥ t·∫£</label>
                    <textarea class="form-textarea" name="description" rows="3"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeEditShopModal()">H·ªßy</button>
            <button type="button" class="btn btn-primary" onclick="updateShop()">C·∫≠p nh·∫≠t</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" id="deleteShopModal" style="display: none;">
    <div class="modal modal-small">
        <div class="modal-header">
            <h3><i class="fas fa-exclamation-triangle"></i> X√°c nh·∫≠n x√≥a</h3>
            <button class="modal-close" onclick="closeDeleteShopModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a shop n√†y kh√¥ng?</p>
            <p class="text-gray-600">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeDeleteShopModal()">H·ªßy</button>
            <button type="button" class="btn btn-danger" onclick="confirmDeleteShop()">X√≥a</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--spacing-4);
    margin-bottom: var(--spacing-6);
}

.stat-card {
    background: white;
    border-radius: var(--radius-lg);
    padding: var(--spacing-6);
    box-shadow: var(--shadow-md);
    border: 1px solid var(--gray-200);
    display: flex;
    align-items: center;
    transition: all var(--transition-normal);
}

.stat-card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-2px);
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: var(--radius-lg);
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: var(--spacing-4);
}

.stat-icon i {
    font-size: var(--font-size-xl);
    color: white;
}

.stat-content {
    flex: 1;
}

.stat-number {
    font-size: var(--font-size-2xl);
    font-weight: 700;
    color: var(--gray-900);
    margin-bottom: var(--spacing-1);
}

.stat-label {
    font-size: var(--font-size-sm);
    color: var(--gray-600);
    font-weight: 500;
}

.shop-details {
    display: grid;
    gap: var(--spacing-4);
}

.detail-row {
    display: flex;
    justify-content: space-between;
    padding: var(--spacing-3);
    background: var(--gray-50);
    border-radius: var(--radius-md);
}

.detail-label {
    font-weight: 600;
    color: var(--gray-700);
}

.detail-value {
    color: var(--gray-600);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let shopsData = [];
let areasData = [];
let filteredShops = [];
let currentPage = 1;
const itemsPerPage = 10;
let deleteShopId = null;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadAreasData();
    loadShopsData();
    setupEventListeners();
});

// Setup event listeners
function setupEventListeners() {
    // Form submission
    document.getElementById('createShopForm').addEventListener('submit', createShop);
    
    // Filter inputs
    document.getElementById('searchShop').addEventListener('input', debounce(filterShops, 300));
    document.getElementById('areaFilter').addEventListener('change', filterShops);
    document.getElementById('statusFilter').addEventListener('change', filterShops);
}

// Load areas data
async function loadAreasData() {
    try {
        const response = await fetch('{{ BACKEND_URL }}/api/areas/');
        if (response.ok) {
            areasData = await response.json();
            updateAreaSelects();
        } else {
            console.error('Failed to load areas');
        }
    } catch (error) {
        console.error('Error loading areas:', error);
    }
}

// Load shops data
async function loadShopsData() {
    try {
        const response = await fetch('{{ BACKEND_URL }}/api/shops/');
        if (response.ok) {
            shopsData = await response.json();
            filteredShops = [...shopsData];
            updateStatistics();
            updateShopsTable();
            updatePagination();
        } else {
            console.error('Failed to load shops');
        }
    } catch (error) {
        console.error('Error loading shops:', error);
    }
}

// Update area selects
function updateAreaSelects() {
    const selects = [
        document.querySelector('#createShopForm select[name="area_id"]'),
        document.querySelector('#editShopForm select[name="area_id"]'),
        document.getElementById('areaFilter')
    ];
    
    selects.forEach(select => {
        if (select) {
            const currentValue = select.value;
            select.innerHTML = '<option value="">Ch·ªçn khu v·ª±c</option>';
            
            areasData.forEach(area => {
                const option = document.createElement('option');
                option.value = area.id;
                option.textContent = area.name || area.code || `Area ${area.id}`;
                select.appendChild(option);
            });
            
            if (currentValue) {
                select.value = currentValue;
            }
        }
    });
}

// Update statistics
function updateStatistics() {
    const totalShops = shopsData.length;
    const activeShops = shopsData.filter(s => s.status === 'active').length;
    const cityShops = shopsData.filter(s => {
        const area = areasData.find(a => a.id === s.area_id);
        return area && area.type === 'city';
    }).length;
    const totalManagers = new Set(shopsData.map(s => s.manager).filter(Boolean)).size;
    
    document.getElementById('totalShops').textContent = totalShops;
    document.getElementById('activeShops').textContent = activeShops;
    document.getElementById('cityShops').textContent = cityShops;
    document.getElementById('totalManagers').textContent = totalManagers;
}

// Create shop
async function createShop(e) {
    e.preventDefault();
    
    const form = document.getElementById('createShopForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    // Get phone value using phone component
    const phoneEl = form.querySelector('input[data-phone][name="phone"]');
    if (phoneEl && window.getPhoneValue) {
        data.phone = window.getPhoneValue(phoneEl) || '';
    }
    
    try {
        const response = await fetch('{{ BACKEND_URL }}/api/shops/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            document.getElementById('createShopForm').reset();
            clearModalState('createShopForm');
            storeModalState('createShopForm', document.getElementById('createShopForm'));
            loadShopsData();
            showSuccessMessage('T·∫°o shop th√†nh c√¥ng!');
        } else {
            const error = await response.json();
            showErrorMessage(error.detail || 'C√≥ l·ªói x·∫£y ra khi t·∫°o shop');
        }
    } catch (error) {
        showErrorMessage('C√≥ l·ªói x·∫£y ra khi t·∫°o shop');
    }
}

// Reset form
function resetForm() {
    document.getElementById('createShopForm').reset();
}

// Filter shops
function filterShops() {
    const searchTerm = document.getElementById('searchShop').value.toLowerCase();
    const areaFilter = document.getElementById('areaFilter').value;
    const typeFilter = document.getElementById('typeFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    
    filteredShops = shopsData.filter(shop => {
        const matchesSearch = !searchTerm || 
                             (shop.name && shop.name.toLowerCase().includes(searchTerm)) ||
                             (shop.code && shop.code.toLowerCase().includes(searchTerm)) ||
                             (shop.address && shop.address.toLowerCase().includes(searchTerm));
        const matchesArea = !areaFilter || shop.area_id == areaFilter;
        const matchesType = !typeFilter; // Shop model kh√¥ng c√≥ field type
        const matchesStatus = !statusFilter || shop.status === statusFilter;
        
        return matchesSearch && matchesArea && matchesType && matchesStatus;
    });
    
    currentPage = 1;
    updateShopsTable();
    updatePagination();
}

// Clear filters
function clearFilters() {
    document.getElementById('searchShop').value = '';
    document.getElementById('areaFilter').value = '';
    document.getElementById('statusFilter').value = '';
    
    filteredShops = [...shopsData];
    currentPage = 1;
    updateShopsTable();
    updatePagination();
}

// Update shops table
function updateShopsTable() {
    const tbody = document.getElementById('shopsTableBody');
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageShops = filteredShops.slice(startIndex, endIndex);
    
    tbody.innerHTML = pageShops.map(shop => {
        const area = areasData.find(a => a.id === shop.area_id);
        return `
            <tr>
                <td><strong>${shop.code || '-'}</strong></td>
                <td>${shop.name || '-'}</td>
                <td>${area ? (area.name || '-') : '-'}</td>
                <td>${shop.address || '-'}</td>
                <td>${shop.phone || '-'}</td>
                <td>${shop.email || '-'}</td>
                <td>${shop.manager || '-'}</td>
                <td>${getStatusBadge(shop.status)}</td>
                <td>
                    <div class="table-actions">
                        <button class="btn btn-sm btn-secondary" onclick="viewShop(${shop.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="editShop(${shop.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteShop(${shop.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

// Update pagination
function updatePagination() {
    const totalPages = Math.ceil(filteredShops.length / itemsPerPage);
    const pagination = document.getElementById('pagination');
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let paginationHTML = '';
    
    // Previous button
    paginationHTML += `
        <button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">
            <i class="fas fa-chevron-left"></i>
        </button>
    `;
    
    // Page numbers
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        paginationHTML += `<button class="pagination-btn" onclick="goToPage(1)">1</button>`;
        if (startPage > 2) {
            paginationHTML += `<span class="text-gray-500">...</span>`;
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
            <button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">
                ${i}
            </button>
        `;
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            paginationHTML += `<span class="text-gray-500">...</span>`;
        }
        paginationHTML += `<button class="pagination-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
    }
    
    // Next button
    paginationHTML += `
        <button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">
            <i class="fas fa-chevron-right"></i>
        </button>
    `;
    
    pagination.innerHTML = paginationHTML;
}

// Go to page
function goToPage(page) {
    const totalPages = Math.ceil(filteredShops.length / itemsPerPage);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        updateShopsTable();
        updatePagination();
    }
}

// Modal functions
function viewShop(id) {
    const shop = shopsData.find(s => s.id === id);
    if (shop) {
        const area = areasData.find(a => a.id === shop.area_id);
        const details = document.getElementById('shopDetails');
        details.innerHTML = `
            <div class="shop-details">
                <div class="detail-row">
                    <span class="detail-label">T√™n shop:</span>
                    <span class="detail-value">${shop.name || '-'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">M√£ shop:</span>
                    <span class="detail-value">${shop.code || '-'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Khu v·ª±c:</span>
                    <span class="detail-value">${area ? (area.name || '-') : '-'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">ƒê·ªãa ch·ªâ:</span>
                    <span class="detail-value">${shop.address || '-'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">S·ªë ƒëi·ªán tho·∫°i:</span>
                    <span class="detail-value">${shop.phone || '-'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Email:</span>
                    <span class="detail-value">${shop.email || '-'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Ng∆∞·ªùi qu·∫£n l√Ω:</span>
                    <span class="detail-value">${shop.manager || '-'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Tr·∫°ng th√°i:</span>
                    <span class="detail-value">${getStatusBadge(shop.status)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">M√¥ t·∫£:</span>
                    <span class="detail-value">${shop.description || '-'}</span>
                </div>
            </div>
        `;
        
        document.getElementById('viewShopModal').style.display = 'flex';
    }
}

function closeViewShopModal() {
    closeModalWithConfirmation('viewShopModal');
}

function editShop(id) {
    const shop = shopsData.find(s => s.id === id);
    if (!shop) {
        console.error('Shop not found:', id);
        return;
    }
    
    console.log('Editing shop:', shop);
    console.log('Shop phone from data:', shop.phone);
    
    const form = document.getElementById('editShopForm');
    const modal = document.getElementById('editShopModal');
    
    if (!form || !modal) {
        console.error('Form or modal not found');
        return;
    }
    
    // Fill basic fields
    form.querySelector('input[name="id"]').value = shop.id;
    form.querySelector('input[name="name"]').value = shop.name || '';
    form.querySelector('input[name="code"]').value = shop.code || '';
    form.querySelector('select[name="area_id"]').value = shop.area_id || '';
    form.querySelector('textarea[name="address"]').value = shop.address || '';
    form.querySelector('input[name="email"]').value = shop.email || '';
    form.querySelector('input[name="manager"]').value = shop.manager || '';
    form.querySelector('select[name="status"]').value = shop.status || 'active';
    form.querySelector('textarea[name="description"]').value = shop.description || '';
    
    // Update area select options
    updateAreaSelects();
    
    // Show modal first
    modal.style.display = 'flex';
    
    // Set phone value after modal is visible and phone component is ready
    const phoneInput = form.querySelector('input[data-phone][name="phone"]');
    console.log('Phone input found:', !!phoneInput);
    
    if (!phoneInput) {
        console.warn('Phone input not found in edit form');
        // Store initial state even if no phone input
        storeModalState('editShopModal', form);
        return;
    }
    
    // Store initial state (will be updated after phone value is set if phone exists)
    storeModalState('editShopModal', form);
    
    if (!shop.phone) {
        console.warn('No phone value in shop data');
        return;
    }
    
    console.log('Setting phone value:', shop.phone);
    
    // Force initialize phone component for this specific input
    // Wait for modal to be fully visible first
    setTimeout(() => {
        // Check if phone input is already wrapped
        let container = phoneInput.closest('.phone-input-container');
        console.log('Phone container found (before init):', !!container);
        
        // If not wrapped, force wrap it
        if (!container) {
            console.log('Phone input not wrapped, forcing initialization...');
            
            // Try to use wrapPhoneInput directly first
            if (window.wrapPhoneInput) {
                console.log('Using wrapPhoneInput directly...');
                try {
                    // Check if there are any existing containers first and remove them
                    const formGroup = phoneInput.closest('.form-group');
                    if (formGroup) {
                        const existingContainers = formGroup.querySelectorAll('.phone-input-container');
                        if (existingContainers.length > 0) {
                            console.log('Removing existing phone containers before wrapping');
                            existingContainers.forEach(container => container.remove());
                        }
                    }
                    
                    window.wrapPhoneInput(phoneInput);
                    // Wait a bit for wrapping to complete
                    setTimeout(() => {
                        container = phoneInput.closest('.phone-input-container');
                        if (container) {
                            console.log('Successfully wrapped with wrapPhoneInput');
                            if (window.setPhoneValue) {
                                window.setPhoneValue(phoneInput, shop.phone);
                                // Store initial state after phone value is set
                                setTimeout(() => {
                                    storeModalState('editShopModal', form);
                                }, 100);
                            } else {
                                setPhoneValueManually(container, shop.phone);
                                // Store initial state after phone value is set
                                setTimeout(() => {
                                    storeModalState('editShopModal', form);
                                }, 100);
                            }
                        } else {
                            console.warn('wrapPhoneInput failed, trying manual wrap...');
                            manuallyWrapPhoneInput(phoneInput, shop.phone);
                        }
                    }, 100);
                } catch (error) {
                    console.error('Error wrapping phone input:', error);
                    manuallyWrapPhoneInput(phoneInput, shop.phone);
                }
            } else {
                // Fallback to initializePhoneInputs
                console.log('wrapPhoneInput not available, using initializePhoneInputs...');
                if (window.initializePhoneInputs) {
                    window.initializePhoneInputs();
                    setTimeout(() => {
                        container = phoneInput.closest('.phone-input-container');
                        if (container) {
                            console.log('Successfully wrapped with initializePhoneInputs');
                            if (window.setPhoneValue) {
                                window.setPhoneValue(phoneInput, shop.phone);
                                // Store initial state after phone value is set
                                setTimeout(() => {
                                    storeModalState('editShopModal', form);
                                }, 100);
                            } else {
                                setPhoneValueManually(container, shop.phone);
                                // Store initial state after phone value is set
                                setTimeout(() => {
                                    storeModalState('editShopModal', form);
                                }, 100);
                            }
                        } else {
                            console.warn('initializePhoneInputs failed, trying manual wrap...');
                            manuallyWrapPhoneInput(phoneInput, shop.phone);
                        }
                    }, 200);
                } else {
                    console.error('No phone wrapping function available, using manual wrap...');
                    manuallyWrapPhoneInput(phoneInput, shop.phone);
                }
            }
        } else {
            // Already wrapped, just set the value
            console.log('Phone container already exists, setting value');
            if (window.setPhoneValue) {
                window.setPhoneValue(phoneInput, shop.phone);
                // Store initial state after phone value is set
                setTimeout(() => {
                    storeModalState('editShopModal', form);
                }, 100);
            } else {
                setPhoneValueManually(container, shop.phone);
                // Store initial state after phone value is set
                setTimeout(() => {
                    storeModalState('editShopModal', form);
                }, 100);
            }
        }
    }, 150); // Slightly increased timeout to ensure modal is fully rendered
}

function closeEditShopModal() {
    const modal = document.getElementById('editShopModal');
    if (!modal) return;
    
    const form = document.getElementById('editShopForm');
    if (!form) {
        modal.style.display = 'none';
        clearModalState('editShopModal');
        return;
    }
    
    // Get current form data including phone value
    const formData = new FormData(form);
    const currentData = Object.fromEntries(formData);
    
    // Get phone value from phone component
    const phoneEl = form.querySelector('input[data-phone][name="phone"]');
    if (phoneEl && window.getPhoneValue) {
        currentData.phone = window.getPhoneValue(phoneEl) || '';
    }
    
    // Get original data
    const originalData = modalStates.get('editShopModal');
    
    // Compare data
    let hasChanges = false;
    if (!originalData) {
        // If no original data, check if form has any data
        hasChanges = Object.values(currentData).some(val => val && val.toString().trim() !== '');
    } else {
        // Compare current with original
        const keys = new Set([...Object.keys(currentData), ...Object.keys(originalData)]);
        for (const key of keys) {
            const currentVal = (currentData[key] || '').toString().trim();
            const originalVal = (originalData[key] || '').toString().trim();
            if (currentVal !== originalVal) {
                hasChanges = true;
                break;
            }
        }
    }
    
    // Only ask for confirmation if there are changes
    if (hasChanges) {
        closeModalWithConfirmation('editShopModal');
    } else {
        modal.style.display = 'none';
        clearModalState('editShopModal');
    }
}

async function updateShop() {
    const form = document.getElementById('editShopForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    const id = data.id;
    delete data.id;
    
    // Get phone value using phone component
    const phoneEl = form.querySelector('input[data-phone][name="phone"]');
    if (phoneEl && window.getPhoneValue) {
        data.phone = window.getPhoneValue(phoneEl) || '';
    }
    
    try {
        const response = await fetch(`{{ BACKEND_URL }}/api/shops/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            document.getElementById('editShopModal').style.display = 'none';
            clearModalState('editShopModal');
            loadShopsData();
            showSuccessMessage('C·∫≠p nh·∫≠t th√†nh c√¥ng!');
        } else {
            const error = await response.json();
            showErrorMessage(error.detail || 'C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t shop');
        }
    } catch (error) {
        showErrorMessage('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t shop');
    }
}

function deleteShop(id) {
    deleteShopId = id;
    document.getElementById('deleteShopModal').style.display = 'flex';
}

function closeDeleteShopModal() {
    document.getElementById('deleteShopModal').style.display = 'none';
    deleteShopId = null;
}

async function confirmDeleteShop() {
    if (!deleteShopId) return;
    
    try {
        const response = await fetch(`{{ BACKEND_URL }}/api/shops/${deleteShopId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`
            }
        });
        
        if (response.ok) {
            document.getElementById('deleteShopModal').style.display = 'none';
            clearModalState('deleteShopModal');
            loadShopsData();
            showSuccessMessage('X√≥a shop th√†nh c√¥ng!');
        } else {
            const error = await response.json();
            showErrorMessage(error.detail || 'C√≥ l·ªói x·∫£y ra khi x√≥a shop');
        }
    } catch (error) {
        showErrorMessage('C√≥ l·ªói x·∫£y ra khi x√≥a shop');
    }
}

// Utility functions
function getStatusBadge(status) {
    const badges = {
        'active': '<span class="badge badge-success">Ho·∫°t ƒë·ªông</span>',
        'inactive': '<span class="badge badge-danger">Kh√¥ng ho·∫°t ƒë·ªông</span>',
        'maintenance': '<span class="badge badge-warning">B·∫£o tr√¨</span>'
    };
    return badges[status] || '<span class="badge badge-secondary">Kh√¥ng x√°c ƒë·ªãnh</span>';
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function showSuccessMessage(message) {
    showSuccessModal('Th√†nh c√¥ng', message);
}

function showErrorMessage(message) {
    showErrorModal('L·ªói', message);
}

// Helper function to manually wrap phone input (same as areas_management.html)
function manuallyWrapPhoneInput(input, phoneValue) {
    if (!input) return;
    
    const formGroup = input.closest('.form-group');
    if (!formGroup) {
        console.error('Form group not found');
        return;
    }
    
    // Check if already wrapped
    if (input.closest('.phone-input-container')) {
        console.log('Input already wrapped, skipping manual wrap');
        return;
    }
    
    // Remove any existing phone containers in this form group to avoid duplicates
    const existingContainers = formGroup.querySelectorAll('.phone-input-container');
    existingContainers.forEach(container => {
        console.log('Removing duplicate phone container');
        container.remove();
    });
    
    console.log('Manually wrapping phone input...');
    
    // Hide the original input completely (same as phone.js does)
    input.style.display = 'none';
    input.style.visibility = 'hidden';
    input.style.position = 'absolute';
    input.style.width = '0';
    input.style.height = '0';
    input.style.opacity = '0';
    input.setAttribute('data-phone-hidden', 'true');
    
    // Hide the label associated with the original input if it exists
    const labels = formGroup.querySelectorAll('label.form-label');
    labels.forEach(label => {
        if (label.getAttribute('for') === input.id) {
            // Label is linked via 'for' attribute
            label.style.display = 'none';
        } else if (label.textContent.trim().includes('S·ªë ƒëi·ªán tho·∫°i')) {
            // Check if this is the original label (before any phone containers)
            const phoneContainers = formGroup.querySelectorAll('.phone-input-container');
            if (phoneContainers.length > 0) {
                // If there are phone containers, hide labels that come before them
                const labelIndex = Array.from(formGroup.children).indexOf(label);
                const firstContainerIndex = Array.from(formGroup.children).indexOf(phoneContainers[0]);
                if (labelIndex < firstContainerIndex) {
                    label.style.display = 'none';
                }
            }
        }
    });
    
    // Create container
    const container = document.createElement('div');
    container.className = 'phone-input-container';
    
    // Create country select
    const countrySelect = document.createElement('select');
    countrySelect.className = 'form-select phone-country-select';
    countrySelect.setAttribute('data-country-select', 'true');
    
    // Add country options (Vietnam first) - use same countries as phone.js
    const countries = [
        { code: 'VN', name: 'Vi·ªát Nam', dialCode: '+84', flag: 'üáªüá≥', pattern: /^0\d{9}$/, length: 10, placeholder: '0XXXXXXXXX', prefix: '0' },
        { code: 'US', name: 'United States', dialCode: '+1', flag: 'üá∫üá∏', pattern: /^\d{10}$/, length: 10, placeholder: 'XXXXXXXXXX', prefix: '' },
        { code: 'GB', name: 'United Kingdom', dialCode: '+44', flag: 'üá¨üáß', pattern: /^[1-9]\d{9,10}$/, length: 10, placeholder: '7XXXXXXXXX', prefix: '7' },
        { code: 'CN', name: 'China', dialCode: '+86', flag: 'üá®üá≥', pattern: /^1[3-9]\d{9}$/, length: 11, placeholder: '1XXXXXXXXXX', prefix: '1' },
        { code: 'JP', name: 'Japan', dialCode: '+81', flag: 'üáØüáµ', pattern: /^[789]0\d{8}$/, length: 11, placeholder: '90XXXXXXXXX', prefix: '9' },
    ];
    
    countries.forEach(country => {
        const option = document.createElement('option');
        option.value = country.code;
        option.textContent = `${country.flag} ${country.dialCode}`;
        option.setAttribute('data-dial-code', country.dialCode);
        option.setAttribute('data-pattern', country.pattern.source);
        option.setAttribute('data-length', country.length);
        option.setAttribute('data-placeholder', country.placeholder);
        if (country.code === 'VN') {
            option.selected = true;
        }
        countrySelect.appendChild(option);
    });
    
    // Create number input
    const numberInput = document.createElement('input');
    numberInput.type = 'tel';
    numberInput.className = 'form-input phone-number-input';
    numberInput.setAttribute('data-phone-number', 'true');
    numberInput.placeholder = '0XXXXXXXXX';
    numberInput.maxLength = 10;
    
    // Copy name and id from original input if exists
    if (input.name) numberInput.name = input.name;
    if (input.id) {
        numberInput.id = input.id;
        input.removeAttribute('id'); // Remove ID from original to avoid duplicate
    }
    if (input.required) numberInput.required = input.required;
    
    // Insert container before original input
    input.parentNode.insertBefore(container, input);
    container.appendChild(countrySelect);
    container.appendChild(numberInput);
    
    // Setup event listeners similar to phone.js
    setupManualPhoneEvents(countrySelect, numberInput, input);
    
    console.log('Phone input wrapped manually');
    
    // Now set the phone value
    setTimeout(() => {
        if (phoneValue) {
            setPhoneValueManually(container, phoneValue);
            // Store initial state after phone value is set
            const form = input.closest('form');
            if (form) {
                setTimeout(() => {
                    const modalId = form.closest('.modal-overlay')?.id;
                    if (modalId) {
                        storeModalState(modalId, form);
                    }
                }, 100);
            }
        }
    }, 50);
}

// Setup event listeners for manually wrapped phone input
function setupManualPhoneEvents(countrySelect, numberInput, hiddenInput) {
    // Country change handler
    countrySelect.addEventListener('change', function() {
        const selectedOption = countrySelect.options[countrySelect.selectedIndex];
        const length = parseInt(selectedOption.getAttribute('data-length'));
        const placeholder = selectedOption.getAttribute('data-placeholder');
        
        numberInput.placeholder = placeholder;
        numberInput.maxLength = length;
        
        // Update hidden input
        updateManualHiddenInput(countrySelect, numberInput, hiddenInput);
    });
    
    // Number input handler
    numberInput.addEventListener('input', function() {
        updateManualHiddenInput(countrySelect, numberInput, hiddenInput);
    });
    
    // Initial update
    updateManualHiddenInput(countrySelect, numberInput, hiddenInput);
}

// Update hidden input for manually wrapped phone
function updateManualHiddenInput(countrySelect, numberInput, hiddenInput) {
    const countryCode = countrySelect.value;
    const number = numberInput.value.replace(/\D/g, '');
    
    // Find dial code for selected country
    const selectedOption = countrySelect.options[countrySelect.selectedIndex];
    const dialCode = selectedOption.getAttribute('data-dial-code');
    
    if (number && dialCode) {
        // Remove leading 0 for Vietnam if present
        let fullNumber = number;
        if (countryCode === 'VN' && number.startsWith('0')) {
            fullNumber = dialCode + number.substring(1);
        } else {
            fullNumber = dialCode + number;
        }
        hiddenInput.value = fullNumber;
    } else {
        hiddenInput.value = '';
    }
}

// Helper function to manually set phone value
function setPhoneValueManually(container, phoneValue) {
    if (!container || !phoneValue) {
        console.warn('setPhoneValueManually: missing container or phoneValue', { container: !!container, phoneValue });
        return;
    }
    
    const countrySelect = container.querySelector('.phone-country-select');
    const numberInput = container.querySelector('.phone-number-input');
    
    if (!countrySelect || !numberInput) {
        console.warn('Phone component elements not found', {
            countrySelect: !!countrySelect,
            numberInput: !!numberInput
        });
        return;
    }
    
    console.log('Setting phone manually:', phoneValue);
    
    // Parse phone number
    if (phoneValue && phoneValue.startsWith('+84')) {
        // Vietnam number: +840616511561 -> 0616511561
        countrySelect.value = 'VN';
        const localNumber = phoneValue.replace(/^\+84/, '');
        console.log('Parsed Vietnam number:', localNumber);
        numberInput.value = localNumber;
        console.log('Set Vietnam number in input:', numberInput.value);
        
        // Trigger change event to update hidden input and validation
        const changeEvent = new Event('change', { bubbles: true });
        countrySelect.dispatchEvent(changeEvent);
        numberInput.dispatchEvent(changeEvent);
        
        // Also trigger input event for real-time validation
        const inputEvent = new Event('input', { bubbles: true });
        numberInput.dispatchEvent(inputEvent);
        
        // Update hidden input if exists
        const hiddenInput = container.previousElementSibling;
        if (hiddenInput && hiddenInput.hasAttribute('data-phone-hidden')) {
            hiddenInput.value = phoneValue;
            console.log('Updated hidden input:', hiddenInput.value);
        }
    } else if (phoneValue && phoneValue.startsWith('+')) {
        // Other country - try to detect dial code
        const dialCodeMatch = phoneValue.match(/^\+(\d+)/);
        if (dialCodeMatch) {
            const dialCode = '+' + dialCodeMatch[1];
            console.log('Detected dial code:', dialCode);
            // Find country by dial code
            const options = countrySelect.querySelectorAll('option');
            let found = false;
            for (let opt of options) {
                const optDialCode = opt.getAttribute('data-dial-code');
                if (optDialCode === dialCode) {
                    countrySelect.value = opt.value;
                    const localNumber = phoneValue.substring(dialCode.length);
                    numberInput.value = localNumber;
                    console.log('Set number for country:', opt.value, 'number:', localNumber);
                    found = true;
                    
                    // Trigger change event
                    const changeEvent = new Event('change', { bubbles: true });
                    countrySelect.dispatchEvent(changeEvent);
                    numberInput.dispatchEvent(changeEvent);
                    break;
                }
            }
            if (!found) {
                console.warn('Country not found for dial code:', dialCode);
            }
        }
    } else if (phoneValue) {
        // No country code, assume Vietnam
        countrySelect.value = 'VN';
        numberInput.value = phoneValue;
        console.log('Set number without country code:', phoneValue);
        
        // Trigger change event
        const changeEvent = new Event('change', { bubbles: true });
        countrySelect.dispatchEvent(changeEvent);
        numberInput.dispatchEvent(changeEvent);
        
        // Update hidden input if exists
        const hiddenInput = container.previousElementSibling;
        if (hiddenInput && hiddenInput.hasAttribute('data-phone-hidden')) {
            // Construct full phone number with country code
            const fullNumber = '+84' + phoneValue.replace(/^0/, '');
            hiddenInput.value = fullNumber;
            console.log('Updated hidden input:', hiddenInput.value);
        }
    }
}
</script>
{% endblock %}