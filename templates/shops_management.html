{% extends "base.html" %}

{% block title %}Quản lý shop - PhanMemKeToan{% endblock %}

{% block page_title %}
<i class="fas fa-store"></i> Quản lý shop
{% endblock %}

{% block page_description %}
Tạo và quản lý các shop, theo dõi thông tin chi tiết từng shop
{% endblock %}

{% block content %}
<!-- Statistics Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-store"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="totalShops">0</div>
            <div class="stat-label">Tổng shop</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-map-marker-alt"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="activeShops">0</div>
            <div class="stat-label">Đang hoạt động</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-city"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="cityShops">0</div>
            <div class="stat-label">Thành phố</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-users"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="totalManagers">0</div>
            <div class="stat-label">Người quản lý</div>
        </div>
    </div>
</div>

<!-- Create Shop Form -->
<div class="card">
    <div class="card-header">
        <h3><i class="fas fa-plus-circle"></i> Tạo shop mới</h3>
    </div>
    <div class="card-body">
        <form id="createShopForm">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Tên shop *</label>
                    <input type="text" class="form-input" name="name" required placeholder="Nhập tên shop">
                </div>
                <div class="form-group">
                    <label class="form-label">Mã shop *</label>
                    <input type="text" class="form-input" name="code" required placeholder="Nhập mã shop">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Khu vực *</label>
                    <select class="form-select" name="area_id" required>
                        <option value="">Chọn khu vực</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Loại shop</label>
                    <select class="form-select" name="type">
                        <option value="main">Shop chính</option>
                        <option value="branch">Chi nhánh</option>
                        <option value="outlet">Outlet</option>
                        <option value="popup">Pop-up</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Địa chỉ *</label>
                <textarea class="form-textarea" name="address" rows="3" required placeholder="Nhập địa chỉ shop"></textarea>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Số điện thoại</label>
                    <input type="tel" class="form-input" name="phone" placeholder="Nhập số điện thoại">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" name="email" placeholder="Nhập email">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Người quản lý</label>
                    <input type="text" class="form-input" name="manager" placeholder="Nhập tên người quản lý">
                </div>
                <div class="form-group">
                    <label class="form-label">Trạng thái</label>
                    <select class="form-select" name="status">
                        <option value="active">Hoạt động</option>
                        <option value="inactive">Không hoạt động</option>
                        <option value="maintenance">Bảo trì</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Mô tả</label>
                <textarea class="form-textarea" name="description" rows="3" placeholder="Mô tả shop"></textarea>
            </div>
            
            <div class="form-group">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-plus"></i>
                    Tạo shop
                </button>
                <button type="button" class="btn btn-secondary" onclick="resetForm()">
                    <i class="fas fa-undo"></i>
                    Làm mới
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Filter Bar -->
<div class="filter-bar">
    <div class="filter-row">
        <div class="form-group">
            <label class="form-label">Tìm kiếm</label>
            <div class="search-input">
                <i class="fas fa-search"></i>
                <input type="text" class="form-input" id="searchShop" placeholder="Tìm theo tên, mã, địa chỉ...">
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Khu vực</label>
            <select class="form-select" id="areaFilter">
                <option value="">Tất cả khu vực</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">Loại shop</label>
            <select class="form-select" id="typeFilter">
                <option value="">Tất cả loại</option>
                <option value="main">Shop chính</option>
                <option value="branch">Chi nhánh</option>
                <option value="outlet">Outlet</option>
                <option value="popup">Pop-up</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">Trạng thái</label>
            <select class="form-select" id="statusFilter">
                <option value="">Tất cả trạng thái</option>
                <option value="active">Hoạt động</option>
                <option value="inactive">Không hoạt động</option>
                <option value="maintenance">Bảo trì</option>
            </select>
        </div>
        
        <div class="form-group">
            <button class="btn btn-secondary" onclick="clearFilters()">
                <i class="fas fa-times"></i>
                Xóa bộ lọc
            </button>
        </div>
    </div>
</div>

<!-- Shops Table -->
<div class="table-container">
    <div class="card">
        <div class="card-header">
            <h3>Danh sách shop</h3>
        </div>
        <div class="card-body p-0">
            <table class="table" id="shopsTable">
                <thead>
                    <tr>
                        <th>Mã shop</th>
                        <th>Tên shop</th>
                        <th>Khu vực</th>
                        <th>Loại</th>
                        <th>Địa chỉ</th>
                        <th>SĐT</th>
                        <th>Email</th>
                        <th>Quản lý</th>
                        <th>Trạng thái</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody id="shopsTableBody">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Pagination -->
<div class="pagination" id="pagination">
    <!-- Pagination will be generated here -->
</div>

<!-- View Shop Modal -->
<div class="modal-overlay" id="viewShopModal" style="display: none;">
    <div class="modal modal-large">
        <div class="modal-header">
            <h3><i class="fas fa-eye"></i> Chi tiết shop</h3>
            <button class="modal-close" onclick="closeViewShopModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div id="shopDetails">
                <!-- Shop details will be loaded here -->
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeViewShopModal()">Đóng</button>
        </div>
    </div>
</div>

<!-- Edit Shop Modal -->
<div class="modal-overlay" id="editShopModal" style="display: none;">
    <div class="modal modal-horizontal">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Chỉnh sửa shop</h3>
            <button class="modal-close" onclick="closeEditShopModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="editShopForm">
                <input type="hidden" name="id">
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Tên shop *</label>
                        <input type="text" class="form-input" name="name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mã shop *</label>
                        <input type="text" class="form-input" name="code" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Khu vực *</label>
                        <select class="form-select" name="area_id" required>
                            <option value="">Chọn khu vực</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Loại shop</label>
                        <select class="form-select" name="type">
                            <option value="main">Shop chính</option>
                            <option value="branch">Chi nhánh</option>
                            <option value="outlet">Outlet</option>
                            <option value="popup">Pop-up</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Số điện thoại</label>
                        <input type="tel" class="form-input" name="phone">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" name="email">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Người quản lý</label>
                        <input type="text" class="form-input" name="manager">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Trạng thái</label>
                        <select class="form-select" name="status">
                            <option value="active">Hoạt động</option>
                            <option value="inactive">Không hoạt động</option>
                            <option value="maintenance">Bảo trì</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Địa chỉ *</label>
                    <textarea class="form-textarea" name="address" rows="3" required></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Mô tả</label>
                    <textarea class="form-textarea" name="description" rows="3"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeEditShopModal()">Hủy</button>
            <button type="button" class="btn btn-primary" onclick="updateShop()">Cập nhật</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" id="deleteShopModal" style="display: none;">
    <div class="modal modal-small">
        <div class="modal-header">
            <h3><i class="fas fa-exclamation-triangle"></i> Xác nhận xóa</h3>
            <button class="modal-close" onclick="closeDeleteShopModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p>Bạn có chắc chắn muốn xóa shop này không?</p>
            <p class="text-gray-600">Hành động này không thể hoàn tác.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeDeleteShopModal()">Hủy</button>
            <button type="button" class="btn btn-danger" onclick="confirmDeleteShop()">Xóa</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--spacing-4);
    margin-bottom: var(--spacing-6);
}

.stat-card {
    background: white;
    border-radius: var(--radius-lg);
    padding: var(--spacing-6);
    box-shadow: var(--shadow-md);
    border: 1px solid var(--gray-200);
    display: flex;
    align-items: center;
    transition: all var(--transition-normal);
}

.stat-card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-2px);
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: var(--radius-lg);
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: var(--spacing-4);
}

.stat-icon i {
    font-size: var(--font-size-xl);
    color: white;
}

.stat-content {
    flex: 1;
}

.stat-number {
    font-size: var(--font-size-2xl);
    font-weight: 700;
    color: var(--gray-900);
    margin-bottom: var(--spacing-1);
}

.stat-label {
    font-size: var(--font-size-sm);
    color: var(--gray-600);
    font-weight: 500;
}

.shop-details {
    display: grid;
    gap: var(--spacing-4);
}

.detail-row {
    display: flex;
    justify-content: space-between;
    padding: var(--spacing-3);
    background: var(--gray-50);
    border-radius: var(--radius-md);
}

.detail-label {
    font-weight: 600;
    color: var(--gray-700);
}

.detail-value {
    color: var(--gray-600);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let shopsData = [];
let areasData = [];
let filteredShops = [];
let currentPage = 1;
const itemsPerPage = 10;
let deleteShopId = null;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadAreasData();
    loadShopsData();
    setupEventListeners();
});

// Setup event listeners
function setupEventListeners() {
    // Form submission
    document.getElementById('createShopForm').addEventListener('submit', createShop);
    
    // Filter inputs
    document.getElementById('searchShop').addEventListener('input', debounce(filterShops, 300));
    document.getElementById('areaFilter').addEventListener('change', filterShops);
    document.getElementById('typeFilter').addEventListener('change', filterShops);
    document.getElementById('statusFilter').addEventListener('change', filterShops);
}

// Load areas data
async function loadAreasData() {
    try {
        const response = await fetch('{{ BACKEND_URL }}/api/areas/');
        if (response.ok) {
            areasData = await response.json();
            updateAreaSelects();
        } else {
            console.error('Failed to load areas');
        }
    } catch (error) {
        console.error('Error loading areas:', error);
    }
}

// Load shops data
async function loadShopsData() {
    try {
        const response = await fetch('{{ BACKEND_URL }}/api/shops/');
        if (response.ok) {
            shopsData = await response.json();
            filteredShops = [...shopsData];
            updateStatistics();
            updateShopsTable();
            updatePagination();
        } else {
            console.error('Failed to load shops');
        }
    } catch (error) {
        console.error('Error loading shops:', error);
    }
}

// Update area selects
function updateAreaSelects() {
    const selects = [
        document.querySelector('#createShopForm select[name="area_id"]'),
        document.querySelector('#editShopForm select[name="area_id"]'),
        document.getElementById('areaFilter')
    ];
    
    selects.forEach(select => {
        if (select) {
            const currentValue = select.value;
            select.innerHTML = '<option value="">Chọn khu vực</option>';
            
            areasData.forEach(area => {
                const option = document.createElement('option');
                option.value = area.id;
                option.textContent = area.ten_khu_vuc;
                select.appendChild(option);
            });
            
            if (currentValue) {
                select.value = currentValue;
            }
        }
    });
}

// Update statistics
function updateStatistics() {
    const totalShops = shopsData.length;
    const activeShops = shopsData.filter(s => s.status === 'active').length;
    const cityShops = shopsData.filter(s => {
        const area = areasData.find(a => a.id === s.area_id);
        return area && area.loai_khu_vuc === 'city';
    }).length;
    const totalManagers = new Set(shopsData.map(s => s.manager).filter(Boolean)).size;
    
    document.getElementById('totalShops').textContent = totalShops;
    document.getElementById('activeShops').textContent = activeShops;
    document.getElementById('cityShops').textContent = cityShops;
    document.getElementById('totalManagers').textContent = totalManagers;
}

// Create shop
async function createShop(e) {
    e.preventDefault();
    
    const form = document.getElementById('createShopForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    try {
        const response = await fetch('{{ BACKEND_URL }}/api/shops/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            document.getElementById('createShopForm').reset();
            clearModalState('createShopForm');
            storeModalState('createShopForm', document.getElementById('createShopForm'));
            loadShopsData();
            showSuccessMessage('Tạo shop thành công!');
        } else {
            const error = await response.json();
            showErrorMessage(error.detail || 'Có lỗi xảy ra khi tạo shop');
        }
    } catch (error) {
        showErrorMessage('Có lỗi xảy ra khi tạo shop');
    }
}

// Reset form
function resetForm() {
    document.getElementById('createShopForm').reset();
}

// Filter shops
function filterShops() {
    const searchTerm = document.getElementById('searchShop').value.toLowerCase();
    const areaFilter = document.getElementById('areaFilter').value;
    const typeFilter = document.getElementById('typeFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    
    filteredShops = shopsData.filter(shop => {
        const matchesSearch = !searchTerm || 
                             shop.ten_shop.toLowerCase().includes(searchTerm) ||
                             shop.ma_shop.toLowerCase().includes(searchTerm) ||
                             (shop.dia_chi && shop.dia_chi.toLowerCase().includes(searchTerm));
        const matchesArea = !areaFilter || shop.area_id == areaFilter;
        const matchesType = !typeFilter || shop.type === typeFilter;
        const matchesStatus = !statusFilter || shop.status === statusFilter;
        
        return matchesSearch && matchesArea && matchesType && matchesStatus;
    });
    
    currentPage = 1;
    updateShopsTable();
    updatePagination();
}

// Clear filters
function clearFilters() {
    document.getElementById('searchShop').value = '';
    document.getElementById('areaFilter').value = '';
    document.getElementById('typeFilter').value = '';
    document.getElementById('statusFilter').value = '';
    
    filteredShops = [...shopsData];
    currentPage = 1;
    updateShopsTable();
    updatePagination();
}

// Update shops table
function updateShopsTable() {
    const tbody = document.getElementById('shopsTableBody');
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageShops = filteredShops.slice(startIndex, endIndex);
    
    tbody.innerHTML = pageShops.map(shop => {
        const area = areasData.find(a => a.id === shop.area_id);
        return `
            <tr>
                <td><strong>${shop.ma_shop}</strong></td>
                <td>${shop.ten_shop}</td>
                <td>${area ? area.ten_khu_vuc : '-'}</td>
                <td><span class="badge badge-info">${getTypeText(shop.type)}</span></td>
                <td>${shop.dia_chi || '-'}</td>
                <td>${shop.phone || '-'}</td>
                <td>${shop.email || '-'}</td>
                <td>${shop.manager || '-'}</td>
                <td>${getStatusBadge(shop.status)}</td>
                <td>
                    <div class="table-actions">
                        <button class="btn btn-sm btn-secondary" onclick="viewShop(${shop.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="editShop(${shop.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteShop(${shop.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

// Update pagination
function updatePagination() {
    const totalPages = Math.ceil(filteredShops.length / itemsPerPage);
    const pagination = document.getElementById('pagination');
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let paginationHTML = '';
    
    // Previous button
    paginationHTML += `
        <button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">
            <i class="fas fa-chevron-left"></i>
        </button>
    `;
    
    // Page numbers
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        paginationHTML += `<button class="pagination-btn" onclick="goToPage(1)">1</button>`;
        if (startPage > 2) {
            paginationHTML += `<span class="text-gray-500">...</span>`;
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
            <button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">
                ${i}
            </button>
        `;
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            paginationHTML += `<span class="text-gray-500">...</span>`;
        }
        paginationHTML += `<button class="pagination-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
    }
    
    // Next button
    paginationHTML += `
        <button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">
            <i class="fas fa-chevron-right"></i>
        </button>
    `;
    
    pagination.innerHTML = paginationHTML;
}

// Go to page
function goToPage(page) {
    const totalPages = Math.ceil(filteredShops.length / itemsPerPage);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        updateShopsTable();
        updatePagination();
    }
}

// Modal functions
function viewShop(id) {
    const shop = shopsData.find(s => s.id === id);
    if (shop) {
        const area = areasData.find(a => a.id === shop.area_id);
        const details = document.getElementById('shopDetails');
        details.innerHTML = `
            <div class="shop-details">
                <div class="detail-row">
                    <span class="detail-label">Tên shop:</span>
                    <span class="detail-value">${shop.ten_shop}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Mã shop:</span>
                    <span class="detail-value">${shop.ma_shop}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Khu vực:</span>
                    <span class="detail-value">${area ? area.ten_khu_vuc : '-'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Loại shop:</span>
                    <span class="detail-value">${getTypeText(shop.type)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Địa chỉ:</span>
                    <span class="detail-value">${shop.dia_chi || '-'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Số điện thoại:</span>
                    <span class="detail-value">${shop.phone || '-'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Email:</span>
                    <span class="detail-value">${shop.email || '-'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Người quản lý:</span>
                    <span class="detail-value">${shop.manager || '-'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Trạng thái:</span>
                    <span class="detail-value">${getStatusBadge(shop.status)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Mô tả:</span>
                    <span class="detail-value">${shop.description || '-'}</span>
                </div>
            </div>
        `;
        
        document.getElementById('viewShopModal').style.display = 'flex';
    }
}

function closeViewShopModal() {
    closeModalWithConfirmation('viewShopModal');
}

function editShop(id) {
    const shop = shopsData.find(s => s.id === id);
    if (shop) {
        const form = document.getElementById('editShopForm');
        form.querySelector('input[name="id"]').value = shop.id;
        form.querySelector('input[name="name"]').value = shop.ten_shop;
        form.querySelector('input[name="code"]').value = shop.ma_shop;
        form.querySelector('select[name="area_id"]').value = shop.area_id || '';
        form.querySelector('select[name="type"]').value = shop.type;
        form.querySelector('textarea[name="address"]').value = shop.dia_chi || '';
        form.querySelector('input[name="phone"]').value = shop.phone || '';
        form.querySelector('input[name="email"]').value = shop.email || '';
        form.querySelector('input[name="manager"]').value = shop.manager || '';
        form.querySelector('select[name="status"]').value = shop.status;
        form.querySelector('textarea[name="description"]').value = shop.description || '';
        
        // Update area select options
        updateAreaSelects();
        
        // Store initial state for edit modal
        storeModalState('editShopModal', form);
        
        // Store initial state for edit modal
        storeModalState('editShopModal', form);
        
        document.getElementById('editShopModal').style.display = 'flex';
    }
}

function closeEditShopModal() {
    closeModalWithConfirmation('editShopModal');
}

async function updateShop() {
    const form = document.getElementById('editShopForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    const id = data.id;
    delete data.id;
    
    try {
        const response = await fetch(`{{ BACKEND_URL }}/api/shops/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            document.getElementById('editShopModal').style.display = 'none';
            clearModalState('editShopModal');
            loadShopData();
            showSuccessMessage('Cập nhật thành công!');
        } else {
            const error = await response.json();
            showErrorMessage(error.detail || 'Có lỗi xảy ra khi cập nhật shop');
        }
    } catch (error) {
        showErrorMessage('Có lỗi xảy ra khi cập nhật shop');
    }
}

function deleteShop(id) {
    deleteShopId = id;
    document.getElementById('deleteShopModal').style.display = 'flex';
}

function closeDeleteShopModal() {
    document.getElementById('deleteShopModal').style.display = 'none';
    deleteShopId = null;
}

async function confirmDeleteShop() {
    if (!deleteShopId) return;
    
    try {
        const response = await fetch(`{{ BACKEND_URL }}/api/shops/${deleteShopId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`
            }
        });
        
        if (response.ok) {
            document.getElementById('DeleteShopModal').style.display = 'none';
            clearModalState('DeleteShopModal');
            loadShopsData();
            showSuccessMessage('Xóa shop thành công!');
        } else {
            const error = await response.json();
            showErrorMessage(error.detail || 'Có lỗi xảy ra khi xóa shop');
        }
    } catch (error) {
        showErrorMessage('Có lỗi xảy ra khi xóa shop');
    }
}

// Utility functions
function getTypeText(type) {
    const types = {
        'main': 'Shop chính',
        'branch': 'Chi nhánh',
        'outlet': 'Outlet',
        'popup': 'Pop-up'
    };
    return types[type] || type;
}

function getStatusBadge(status) {
    const badges = {
        'active': '<span class="badge badge-success">Hoạt động</span>',
        'inactive': '<span class="badge badge-danger">Không hoạt động</span>',
        'maintenance': '<span class="badge badge-warning">Bảo trì</span>'
    };
    return badges[status] || '<span class="badge badge-secondary">Không xác định</span>';
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function showSuccessMessage(message) {
    showSuccessModal('Thành công', message);
}

function showErrorMessage(message) {
    showErrorModal('Lỗi', message);
}
</script>
{% endblock %}