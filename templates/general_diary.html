{% extends "base.html" %}

{% block title %}Nhật ký chung - PhanMemKeToan{% endblock %}

{% block page_title %}
<i class="fas fa-book"></i> Nhật ký chung
{% endblock %}

{% block page_description %}
Quản lý và theo dõi các giao dịch tài chính, nhập liệu thông tin phát sinh hàng ngày
{% endblock %}

{% block content %}
<!-- Statistics Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-plus-circle"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="totalEntries">0</div>
            <div class="stat-label">Tổng phát sinh</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-arrow-up"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="totalImport">0</div>
            <div class="stat-label">Tổng nhập</div>
        </div>
</div>

    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-arrow-down"></i>
      </div>
        <div class="stat-content">
            <div class="stat-number" id="totalExport">0</div>
            <div class="stat-label">Tổng xuất</div>
       </div>
      </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-money-bill-wave"></i>
      </div>
        <div class="stat-content">
            <div class="stat-number" id="totalAmount">0 VNĐ</div>
            <div class="stat-label">Tổng tiền</div>
      </div>
    </div>
</div>

<!-- Create Entry Form -->
<div class="card">
    <div class="card-header">
        <h3><i class="fas fa-plus-circle"></i> Tạo phát sinh mới</h3>
    </div>
    <div class="card-body">
        <form id="generalDiaryForm">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Ngày nhập hàng *</label>
                    <input type="date" class="form-input" name="ngay_nhap" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Số hiệu *</label>
                    <input type="text" class="form-input" name="so_hieu" required placeholder="PC/PT(xxxx)">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Diễn giải</label>
                <textarea class="form-textarea" name="dien_giai" rows="3" placeholder="Mô tả giao dịch..."></textarea>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">TK nợ</label>
                    <input type="text" class="form-input" name="tk_no" placeholder="Nhập tài khoản nợ">
                </div>
                <div class="form-group">
                    <label class="form-label">TK có</label>
                    <input type="text" class="form-input" name="tk_co" placeholder="Nhập tài khoản có">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Số lượng nhập</label>
                    <input type="number" class="form-input" name="so_luong_nhap" min="0" placeholder="0" oninput="validatePositiveInteger(this)">
                </div>
                <div class="form-group">
                    <label class="form-label">Số lượng xuất</label>
                    <input type="number" class="form-input" name="so_luong_xuat" min="0" placeholder="0" oninput="validatePositiveInteger(this)">
      </div>
      </div>
            
            <div class="form-group">
                <label class="form-label">Tổng tiền</label>
                <div class="money-input-container">
                    <input type="text" id="so_tien_display" class="form-input" placeholder="0" oninput="formatMoneyTyping(this, document.getElementById('so_tien'))">
        <input type="hidden" name="so_tien" id="so_tien">
        <span class="currency-unit">VNĐ</span>
      </div>
       </div>
      
            <div class="form-group">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Lưu thông tin
                </button>
                <button type="button" class="btn btn-secondary" onclick="resetForm()">
                    <i class="fas fa-undo"></i>
                    Làm mới
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Filter Bar -->
<div class="filter-bar">
    <div class="filter-row">
        <div class="form-group">
            <label class="form-label">Tìm kiếm</label>
            <div class="search-input">
                <i class="fas fa-search"></i>
                <input type="text" class="form-input" id="searchEntry" placeholder="Tìm theo số hiệu, diễn giải...">
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Ngày từ</label>
            <input type="date" class="form-input" id="dateFrom">
        </div>
        
        <div class="form-group">
            <label class="form-label">Ngày đến</label>
            <input type="date" class="form-input" id="dateTo">
        </div>
        
        <div class="form-group">
            <button class="btn btn-secondary" onclick="clearFilters()">
                <i class="fas fa-times"></i>
                Xóa bộ lọc
            </button>
        </div>
    </div>
</div>

<!-- Entries Table -->
<div class="table-container">
    <div class="card">
        <div class="card-header">
            <h3>Danh sách phát sinh</h3>
        </div>
        <div class="card-body p-0">
            <table class="table" id="entriesTable">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Ngày nhập</th>
                        <th>Số hiệu</th>
                        <th>Diễn giải</th>
                        <th>TK nợ</th>
                        <th>TK có</th>
                        <th>Số lượng nhập</th>
                        <th>Số lượng xuất</th>
                        <th>Tổng tiền</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody id="entriesTableBody">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
    </div>
    </div>
  </div>

<!-- Pagination -->
<div class="pagination" id="pagination">
    <!-- Pagination will be generated here -->
</div>

<!-- Edit Entry Modal -->
<div class="modal-overlay" id="editEntryModal" style="display: none;">
    <div class="modal modal-horizontal">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Chỉnh sửa phát sinh</h3>
            <button class="modal-close" onclick="closeEditEntryModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="editEntryForm">
                <input type="hidden" name="id">
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Ngày nhập hàng *</label>
                        <input type="date" class="form-input" name="ngay_nhap" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Số hiệu *</label>
                        <input type="text" class="form-input" name="so_hieu" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Diễn giải</label>
                    <textarea class="form-textarea" name="dien_giai" rows="3"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">TK nợ</label>
                        <input type="text" class="form-input" name="tk_no">
                    </div>
                    <div class="form-group">
                        <label class="form-label">TK có</label>
                        <input type="text" class="form-input" name="tk_co">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Số lượng nhập</label>
                        <input type="number" class="form-input" name="so_luong_nhap" min="0" oninput="validatePositiveInteger(this)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Số lượng xuất</label>
                        <input type="number" class="form-input" name="so_luong_xuat" min="0" oninput="validatePositiveInteger(this)">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Tổng tiền</label>
                    <div class="money-input-container">
                        <input type="text" id="edit_so_tien_display" class="form-input" oninput="formatMoneyTyping(this, document.getElementById('edit_so_tien'))">
                        <input type="hidden" name="so_tien" id="edit_so_tien">
                        <span class="currency-unit">VNĐ</span>
                    </div>
                </div>
            </form>
    </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeEditEntryModal()">Hủy</button>
            <button type="button" class="btn btn-primary" onclick="updateEntry()">Cập nhật</button>
      </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" id="deleteEntryModal" style="display: none;">
    <div class="modal modal-small">
        <div class="modal-header">
            <h3><i class="fas fa-exclamation-triangle"></i> Xác nhận xóa</h3>
            <button class="modal-close" onclick="closeDeleteEntryModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p>Bạn có chắc chắn muốn xóa phát sinh này không?</p>
            <p class="text-gray-600">Hành động này không thể hoàn tác.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeDeleteEntryModal()">Hủy</button>
            <button type="button" class="btn btn-danger" onclick="confirmDeleteEntry()">Xóa</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--spacing-4);
    margin-bottom: var(--spacing-6);
}

.stat-card {
    background: white;
    border-radius: var(--radius-lg);
    padding: var(--spacing-6);
    box-shadow: var(--shadow-md);
    border: 1px solid var(--gray-200);
    display: flex;
    align-items: center;
    transition: all var(--transition-normal);
}

.stat-card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-2px);
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: var(--radius-lg);
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: var(--spacing-4);
}

.stat-icon i {
    font-size: var(--font-size-xl);
    color: white;
}

.stat-content {
    flex: 1;
}

.stat-number {
    font-size: var(--font-size-2xl);
    font-weight: 700;
    color: var(--gray-900);
    margin-bottom: var(--spacing-1);
}

.stat-label {
    font-size: var(--font-size-sm);
    color: var(--gray-600);
    font-weight: 500;
}

.money-input-container {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
}

.money-input-container .form-input {
    flex: 1;
}

.currency-unit {
    font-weight: 600;
    color: var(--gray-600);
    font-size: var(--font-size-sm);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let entriesData = [];
let filteredEntries = [];
let currentPage = 1;
const itemsPerPage = 10;
let deleteEntryId = null;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadEntriesData();
    setupEventListeners();
});

// Setup event listeners
function setupEventListeners() {
    // Form submission
    document.getElementById('generalDiaryForm').addEventListener('submit', createEntry);
    
    // Store initial state for create form
    const createForm = document.getElementById('generalDiaryForm');
    storeModalState('generalDiaryForm', createForm);
    
    // Filter inputs
    document.getElementById('searchEntry').addEventListener('input', debounce(filterEntries, 300));
    document.getElementById('dateFrom').addEventListener('change', filterEntries);
    document.getElementById('dateTo').addEventListener('change', filterEntries);
}

// Load entries data
async function loadEntriesData() {
    try {
        const response = await fetch('{{ BACKEND_URL }}/api/general-diary/');
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                entriesData = result.data || [];
                filteredEntries = [...entriesData];
                updateStatistics();
                updateEntriesTable();
                updatePagination();
            }
        } else {
            console.error('Failed to load entries');
        }
    } catch (error) {
        console.error('Error loading entries:', error);
    }
}

// Update statistics
function updateStatistics() {
    const totalEntries = entriesData.length;
    const totalImport = entriesData.reduce((sum, entry) => sum + (entry.so_luong_nhap || 0), 0);
    const totalExport = entriesData.reduce((sum, entry) => sum + (entry.so_luong_xuat || 0), 0);
    const totalAmount = entriesData.reduce((sum, entry) => sum + (entry.so_tien || 0), 0);
    
    document.getElementById('totalEntries').textContent = totalEntries;
    document.getElementById('totalImport').textContent = totalImport.toLocaleString();
    document.getElementById('totalExport').textContent = totalExport.toLocaleString();
    document.getElementById('totalAmount').textContent = totalAmount.toLocaleString() + ' VNĐ';
}

// Create entry
async function createEntry(e) {
    e.preventDefault();
    
  const form = document.getElementById('generalDiaryForm');
  const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    // Convert numeric fields
    data.so_luong_nhap = parseInt(data.so_luong_nhap || '0');
    data.so_luong_xuat = parseInt(data.so_luong_xuat || '0');
    data.so_tien = parseInt(document.getElementById('so_tien').value || '0');
    
    try {
        const response = await fetch('{{ BACKEND_URL }}/api/general-diary/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
                'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`
    },
    body: JSON.stringify(data)
        });
        
        const result = await response.json();
    if (result.success) {
      document.getElementById('generalDiaryForm').reset();
      document.getElementById('so_tien_display').value = '';
      document.getElementById('so_tien').value = '';
      clearModalState('generalDiaryForm');
      storeModalState('generalDiaryForm', document.getElementById('generalDiaryForm'));
            loadEntriesData();
            showSuccessMessage('Lưu thông tin thành công!');
    } else {
            showErrorMessage(result.message || 'Có lỗi xảy ra khi lưu thông tin');
        }
    } catch (error) {
        showErrorMessage('Có lỗi xảy ra khi lưu thông tin');
    }
}

// Reset form
function resetForm() {
    const form = document.getElementById('generalDiaryForm');
    form.reset();
    document.getElementById('so_tien_display').value = '';
    document.getElementById('so_tien').value = '';
    clearModalState('generalDiaryForm');
    storeModalState('generalDiaryForm', form);
}

// Filter entries
function filterEntries() {
    const searchTerm = document.getElementById('searchEntry').value.toLowerCase();
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    
    filteredEntries = entriesData.filter(entry => {
        const matchesSearch = !searchTerm || 
                             (entry.so_hieu && entry.so_hieu.toLowerCase().includes(searchTerm)) ||
                             (entry.dien_giai && entry.dien_giai.toLowerCase().includes(searchTerm));
        
        const entryDate = entry.ngay_nhap;
        const matchesDateFrom = !dateFrom || !entryDate || entryDate >= dateFrom;
        const matchesDateTo = !dateTo || !entryDate || entryDate <= dateTo;
        
        return matchesSearch && matchesDateFrom && matchesDateTo;
    });
    
    currentPage = 1;
    updateEntriesTable();
    updatePagination();
}

// Clear filters
function clearFilters() {
    document.getElementById('searchEntry').value = '';
    document.getElementById('dateFrom').value = '';
    document.getElementById('dateTo').value = '';
    
    filteredEntries = [...entriesData];
    currentPage = 1;
    updateEntriesTable();
    updatePagination();
}

// Update entries table
function updateEntriesTable() {
    const tbody = document.getElementById('entriesTableBody');
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageEntries = filteredEntries.slice(startIndex, endIndex);
    
    tbody.innerHTML = pageEntries.map((entry, index) => `
        <tr>
            <td>${startIndex + index + 1}</td>
            <td>${entry.ngay_nhap || '-'}</td>
            <td><strong>${entry.so_hieu || '-'}</strong></td>
            <td>${entry.dien_giai || '-'}</td>
            <td>${entry.tk_no || '-'}</td>
            <td>${entry.tk_co || '-'}</td>
            <td>${(entry.so_luong_nhap || 0).toLocaleString()}</td>
            <td>${(entry.so_luong_xuat || 0).toLocaleString()}</td>
            <td>${(entry.so_tien || 0).toLocaleString()} VNĐ</td>
            <td>
                <div class="table-actions">
                    <button class="btn btn-sm btn-primary" onclick="editEntry(${entry.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteEntry(${entry.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

// Update pagination
function updatePagination() {
    const totalPages = Math.ceil(filteredEntries.length / itemsPerPage);
    const pagination = document.getElementById('pagination');
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let paginationHTML = '';
    
    // Previous button
    paginationHTML += `
        <button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">
            <i class="fas fa-chevron-left"></i>
        </button>
    `;
    
    // Page numbers
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        paginationHTML += `<button class="pagination-btn" onclick="goToPage(1)">1</button>`;
        if (startPage > 2) {
            paginationHTML += `<span class="text-gray-500">...</span>`;
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
            <button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">
                ${i}
            </button>
        `;
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            paginationHTML += `<span class="text-gray-500">...</span>`;
        }
        paginationHTML += `<button class="pagination-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
    }
    
    // Next button
    paginationHTML += `
        <button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">
            <i class="fas fa-chevron-right"></i>
        </button>
    `;
    
    pagination.innerHTML = paginationHTML;
}

// Go to page
function goToPage(page) {
    const totalPages = Math.ceil(filteredEntries.length / itemsPerPage);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        updateEntriesTable();
        updatePagination();
    }
}

// Modal functions
function editEntry(id) {
    const entry = entriesData.find(e => e.id === id);
    if (entry) {
        const form = document.getElementById('editEntryForm');
        form.querySelector('input[name="id"]').value = entry.id;
        form.querySelector('input[name="ngay_nhap"]').value = entry.ngay_nhap || '';
        form.querySelector('input[name="so_hieu"]').value = entry.so_hieu || '';
        form.querySelector('textarea[name="dien_giai"]').value = entry.dien_giai || '';
        form.querySelector('input[name="tk_no"]').value = entry.tk_no || '';
        form.querySelector('input[name="tk_co"]').value = entry.tk_co || '';
        form.querySelector('input[name="so_luong_nhap"]').value = entry.so_luong_nhap || 0;
        form.querySelector('input[name="so_luong_xuat"]').value = entry.so_luong_xuat || 0;
        
        const soTien = entry.so_tien || 0;
        document.getElementById('edit_so_tien').value = soTien;
        document.getElementById('edit_so_tien_display').value = soTien.toLocaleString();
        
        // Store initial state for edit modal
        storeModalState('editEntryModal', form);
        
        document.getElementById('editEntryModal').style.display = 'flex';
    }
}

function closeEditEntryModal() {
    closeModalWithConfirmation('editEntryModal');
}

async function updateEntry() {
    const form = document.getElementById('editEntryForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    const id = data.id;
    delete data.id;
    
    // Convert numeric fields
    data.so_luong_nhap = parseInt(data.so_luong_nhap || '0');
    data.so_luong_xuat = parseInt(data.so_luong_xuat || '0');
    data.so_tien = parseInt(document.getElementById('edit_so_tien').value || '0');
    
    try {
        const response = await fetch(`{{ BACKEND_URL }}/api/general-diary/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (result.success) {
            document.getElementById('editEntryModal').style.display = 'none';
            clearModalState('editEntryModal');
            loadEntryData();
            showSuccessMessage('Cập nhật thành công!');
        } else {
            showErrorMessage(result.message || 'Có lỗi xảy ra khi cập nhật');
        }
    } catch (error) {
        showErrorMessage('Có lỗi xảy ra khi cập nhật');
    }
}

function deleteEntry(id) {
    deleteEntryId = id;
    document.getElementById('deleteEntryModal').style.display = 'flex';
}

function closeDeleteEntryModal() {
    document.getElementById('deleteEntryModal').style.display = 'none';
    deleteEntryId = null;
}

async function confirmDeleteEntry() {
    if (!deleteEntryId) return;
    
    try {
        const response = await fetch(`{{ BACKEND_URL }}/api/general-diary/${deleteEntryId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`
            }
        });
        
        const result = await response.json();
        if (result.success) {
            closeDeleteEntryModal();
            loadEntriesData();
            showSuccessMessage('Xóa thành công!');
        } else {
            showErrorMessage(result.message || 'Có lỗi xảy ra khi xóa');
        }
    } catch (error) {
        showErrorMessage('Có lỗi xảy ra khi xóa');
    }
}

// Utility functions
function validatePositiveInteger(input) {
  let value = input.value;
  value = value.replace(/[^\d]/g, '');
  if (value === '') {
    input.value = '';
    return;
  }
  let num = parseInt(value);
  if (num < 0) {
    num = 0;
  }
  input.value = num;
}

function formatMoneyTyping(sourceInput, hiddenInput) {
  const raw = (sourceInput.value || '').replace(/[^0-9]/g, '');
  if (!raw) {
    sourceInput.value = '';
    if (hiddenInput) hiddenInput.value = '';
    return;
  }
  if (hiddenInput) hiddenInput.value = raw;
  sourceInput.value = raw.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function showSuccessMessage(message) {
    showSuccessModal('Thành công', message);
}

function showErrorMessage(message) {
    showErrorModal('Lỗi', message);
}
</script>
{% endblock %}