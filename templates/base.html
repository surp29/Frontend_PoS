<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}PosPos{% endblock %}</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/phone.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2><i class="fas fa-calculator"></i> PosPos</h2>
        </div>

        <nav class="sidebar-nav">
        <ul>
            <li>
                <a href="javascript:void(0)" class="dropdown-btn {% if request.endpoint in ['pos','discount_codes'] %}active{% endif %}" data-dropdown="sales">
                    <i class="fas fa-cash-register"></i>
                    B√°n h√†ng
                    <i class="fas fa-chevron-down" style="margin-left: auto; font-size: 12px;"></i>
                </a>
                <ul class="dropdown-container" {% if request.endpoint in ['pos','discount_codes'] %}style="display:block;"{% endif %}>
                    <li><a href="{{ url_for('pos') }}" {% if request.endpoint == 'pos' %}class="active"{% endif %}>POS</a></li>
                    <li><a href="{{ url_for('discount_codes') }}" {% if request.endpoint == 'discount_codes' %}class="active"{% endif %}>M√£ gi·∫£m gi√°</a></li>
                </ul>
            </li>
                
                <li>
                    <a href="{{ url_for('general_diary') }}" {% if request.endpoint == 'general_diary' %}class="active"{% endif %}>
                        <i class="fas fa-home"></i>
                        Nh·∫≠t k√Ω chung
                    </a>
                </li>

                <li>
              <a href="javascript:void(0)" class="dropdown-btn {% if request.endpoint in ['products','product_groups','prices'] %}active{% endif %}" data-dropdown="products">
                        <i class="fas fa-box"></i>
                        Qu·∫£n l√Ω s·∫£n ph·∫©m
                        <i class="fas fa-chevron-down" style="margin-left: auto; font-size: 12px;"></i>
                </a>
                <ul class="dropdown-container" {% if request.endpoint in ['products','product_groups','prices'] %}style="display:block;"{% endif %}>
                    <li><a href="{{ url_for('products') }}" {% if request.endpoint == 'products' %}class="active"{% endif %}>S·∫£n ph·∫©m</a></li>
                        <li><a href="{{ url_for('product_groups') }}" {% if request.endpoint == 'product_groups' %}class="active"{% endif %}>Nh√≥m s·∫£n ph·∫©m</a></li>
                    <li><a href="{{ url_for('prices') }}" {% if request.endpoint == 'prices' %}class="active"{% endif %}>B·∫£ng gi√°</a></li>
                </ul>
            </li>
                
                <li>
                    <a href="{{ url_for('orders') }}" {% if request.endpoint == 'orders' %}class="active"{% endif %}>
                        <i class="fas fa-shopping-cart"></i>
                        ƒê∆°n h√†ng
                    </a>
                </li>
                
                <li>
                    <a href="{{ url_for('invoices') }}" {% if request.endpoint == 'invoices' %}class="active"{% endif %}>
                        <i class="fas fa-file-invoice"></i>
                        H√≥a ƒë∆°n
                    </a>
                </li>
                
                <li>
                    <a href="{{ url_for('warehouse') }}" {% if request.endpoint == 'warehouse' %}class="active"{% endif %}>
                        <i class="fas fa-warehouse"></i>
                        Kho h√†ng
                    </a>
                </li>
                
                <li>
                    <a href="{{ url_for('areas_management') }}" {% if request.endpoint == 'areas_management' %}class="active"{% endif %}>
                        <i class="fas fa-map-marker-alt"></i>
                        Qu·∫£n l√Ω khu v·ª±c
                    </a>
                </li>
                
                <li>
                    <a href="{{ url_for('shops_management') }}" {% if request.endpoint == 'shops_management' %}class="active"{% endif %}>
                        <i class="fas fa-store"></i>
                        Qu·∫£n l√Ω shop
                    </a>
                </li>
                
                <li>
                    <a href="{{ url_for('reports') }}" {% if request.endpoint == 'reports' %}class="active"{% endif %}>
                        <i class="fas fa-chart-line"></i>
                        B√°o c√°o
                    </a>
                </li>
                
                <li>
                    <a href="javascript:void(0)" class="dropdown-btn {% if request.endpoint in ['customers','customers_debts','customers_leaderboard'] %}active{% endif %}" data-dropdown="customers">
                        <i class="fas fa-users"></i>
                        Qu·∫£n l√Ω kh√°ch h√†ng
                        <i class="fas fa-chevron-down" style="margin-left: auto; font-size: 12px;"></i>
                    </a>
                    <ul class="dropdown-container" {% if request.endpoint in ['customers','customers_debts','customers_leaderboard'] %}style="display:block;"{% endif %}>
                        <li><a href="{{ url_for('customers') }}" {% if request.endpoint == 'customers' %}class="active"{% endif %}>Danh s√°ch</a></li>
                        <li><a href="{{ url_for('customers_debts') }}" {% if request.endpoint == 'customers_debts' %}class="active"{% endif %}>C√¥ng n·ª£</a></li>
                        <li><a href="{{ url_for('customers_leaderboard') }}" {% if request.endpoint == 'customers_leaderboard' %}class="active"{% endif %}>X·∫øp h·∫°ng</a></li>
                    </ul>
                </li>

                <li>
                    <a href="javascript:void(0)" class="dropdown-btn {% if request.endpoint in ['employees','employees_schedules'] %}active{% endif %}" data-dropdown="employees">
                        <i class="fas fa-user-tie"></i>
                        Qu·∫£n l√Ω nh√¢n vi√™n
                        <i class="fas fa-chevron-down" style="margin-left: auto; font-size: 12px;"></i>
                    </a>
                    <ul class="dropdown-container" {% if request.endpoint in ['employees','employees_schedules'] %}style="display:block;"{% endif %}>
                        <li><a href="{{ url_for('employees') }}" {% if request.endpoint == 'employees' %}class="active"{% endif %}>Nh√¢n vi√™n</a></li>
                        <li><a href="{{ url_for('employees_schedules') }}" {% if request.endpoint == 'employees_schedules' %}class="active"{% endif %}>Ca l√†m vi·ªác</a></li>
                    </ul>
                </li>
        </ul>
        </nav>
        
        <!-- Chatbot Section -->
        <div class="chatbot-section">
            <button class="chatbot-toggle-btn" onclick="toggleChatbot()" title="Th∆∞ k√Ω ·∫£o AI">
                <i class="fas fa-robot"></i>
                <span class="chatbot-toggle-text">Th∆∞ k√Ω ·∫£o AI</span>
                <span class="chatbot-badge" id="chatbotBadge" style="display: none;">!</span>
            </button>
            
            <!-- Chatbot Window -->
            <div class="chatbot-window" id="chatbotWindow" style="display: none;">
                <div class="chatbot-header">
                    <div class="chatbot-header-info">
                        <i class="fas fa-robot"></i>
                        <div>
                            <h4>Th∆∞ k√Ω ·∫£o AI</h4>
                            <span class="chatbot-status">ƒêang ho·∫°t ƒë·ªông</span>
                        </div>
                    </div>
                    <button class="chatbot-close" onclick="toggleChatbot()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="chatbot-messages" id="chatbotMessages">
                    <div class="chatbot-message bot">
                        <div class="message-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-content">
                            <p>Xin ch√†o! T√¥i l√† Th∆∞ k√Ω ·∫£o AI c·ªßa b·∫°n. T√¥i c√≥ th·ªÉ gi√∫p b·∫°n:</p>
                            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                <li>Ph√¢n t√≠ch v√† th·ªëng k√™ t·ªìn kho</li>
                                <li>ƒê·ªÅ xu·∫•t ƒë·∫∑t h√†ng t·ª± ƒë·ªông</li>
                                <li>Ki·ªÉm tra s·∫£n ph·∫©m b√°n ch·∫°y, s·∫Øp h·∫øt h√†ng</li>
                                <li>B√°o c√°o v√† ph√¢n t√≠ch doanh thu</li>
                            </ul>
                            <p style="margin-top: 0.5rem;">H√£y th·ª≠: "ƒê·ªÅ xu·∫•t ƒë·∫∑t h√†ng", "S·∫£n ph·∫©m s·∫Øp h·∫øt", "Ph√¢n t√≠ch t·ªìn kho"</p>
                        </div>
                    </div>
                </div>
                
                <div class="chatbot-suggestions" id="chatbotSuggestions">
                    <button class="suggestion-btn" onclick="sendChatbotMessage('ƒê·ªÅ xu·∫•t ƒë·∫∑t h√†ng')">
                        <i class="fas fa-shopping-cart"></i> ƒê·ªÅ xu·∫•t ƒë·∫∑t h√†ng
                    </button>
                    <button class="suggestion-btn" onclick="sendChatbotMessage('S·∫£n ph·∫©m s·∫Øp h·∫øt')">
                        <i class="fas fa-exclamation-triangle"></i> S·∫£n ph·∫©m s·∫Øp h·∫øt
                    </button>
                    <button class="suggestion-btn" onclick="sendChatbotMessage('Ph√¢n t√≠ch t·ªìn kho')">
                        <i class="fas fa-chart-bar"></i> Ph√¢n t√≠ch t·ªìn kho
                    </button>
                </div>
                
                <div class="chatbot-input-container">
                    <input type="text" 
                           class="chatbot-input" 
                           id="chatbotInput" 
                           placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n..."
                           onkeypress="handleChatbotKeypress(event)">
                    <button class="chatbot-send-btn" onclick="sendChatbotMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- User Account Section -->
        <div class="user-account-section">
            <div class="user-info" onclick="toggleUserMenu()">
                <div class="user-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="user-details">
                    <span class="username" id="username-display">Kh√°ch</span>
                    <span class="user-role">Qu·∫£n tr·ªã vi√™n</span>
                </div>
                <i class="fas fa-chevron-down user-menu-toggle"></i>
    </div>

            <div class="user-menu" id="userMenu">
                <a href="#" onclick="openSwitchAccountModal()">
                    <i class="fas fa-exchange-alt"></i>
                    Chuy·ªÉn t√†i kho·∫£n
                </a>
                <a href="#" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    ƒêƒÉng xu·∫•t
                </a>
        </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Content Header -->
        <div class="content-header">
            <div class="header-left">
                <h1>{% block page_title %}Trang ch·ªß{% endblock %}</h1>
                <p class="page-description">{% block page_description %}{% endblock %}</p>
    </div>
            <div class="header-right">
                {% block header_actions %}{% endblock %}
          </div>
        </div>

        <!-- Content Body -->
        <div class="content-body">
            {% block content %}{% endblock %}
      </div>
    </div>

    <!-- Switch Account Modal -->
    <div class="modal-overlay" id="switchAccountModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3>Chuy·ªÉn t√†i kho·∫£n</h3>
                <button class="modal-close" onclick="closeSwitchAccountModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
            <form id="switchAccountForm">
                <div class="form-group">
                        <label class="form-label">T√™n ƒëƒÉng nh·∫≠p</label>
                        <input type="text" class="form-input" name="username" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p" required>
                </div>
                <div class="form-group">
                        <label class="form-label">M·∫≠t kh·∫©u</label>
                        <input type="password" class="form-input" name="password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" required>
                </div>
            </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeSwitchAccountModal()">H·ªßy</button>
                <button type="button" class="btn btn-primary" onclick="switchAccount()">Chuy·ªÉn</button>
            </div>
        </div>
    </div>

    <!-- Global Notification Modal -->
    <div class="global-notification-overlay" id="globalNotificationModal" style="display: none;">
        <div class="global-notification" id="globalNotification">
            <div class="global-notification-header">
                <div class="global-notification-title">
                    <div class="global-notification-icon" id="globalNotificationIcon">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <span id="globalNotificationTitle">Th√¥ng b√°o</span>
                </div>
                <button class="global-notification-close" onclick="closePopup()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="global-notification-body">
                <p class="global-notification-message" id="globalNotificationMessage">N·ªôi dung th√¥ng b√°o</p>
            </div>
            <div class="global-notification-footer" id="globalNotificationFooter">
                <button type="button" class="global-notification-btn primary" onclick="closePopup()">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Sidebar dropdown functionality
        document.addEventListener('DOMContentLoaded', function() {
            const dropdownBtns = document.querySelectorAll('.dropdown-btn');
            
            dropdownBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const dropdown = this.getAttribute('data-dropdown');
          const container = this.nextElementSibling;
                    
                    // Close other dropdowns
                    document.querySelectorAll('.dropdown-container').forEach(c => {
                        if (c !== container) {
                            c.style.display = 'none';
                        }
                    });
                    
                    // Toggle current dropdown
                    if (container.style.display === 'block') {
                        container.style.display = 'none';
                    } else {
                        container.style.display = 'block';
                    }
                });
            });
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.dropdown-btn') && !e.target.closest('.dropdown-container')) {
                    document.querySelectorAll('.dropdown-container').forEach(c => {
                        c.style.display = 'none';
                    });
                }
            });
        });

        // User menu functionality
        function toggleUserMenu() {
            const userMenu = document.getElementById('userMenu');
            if (userMenu.style.display === 'block') {
                userMenu.style.display = 'none';
            } else {
                userMenu.style.display = 'block';
            }
        }

        // Close user menu when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.user-account-section')) {
                document.getElementById('userMenu').style.display = 'none';
            }
        });

        // Switch account modal
        function openSwitchAccountModal() {
            document.getElementById('switchAccountModal').style.display = 'flex';
            document.getElementById('userMenu').style.display = 'none';
        }

        function closeSwitchAccountModal() {
            document.getElementById('switchAccountModal').style.display = 'none';
            document.getElementById('switchAccountForm').reset();
        }

        function switchAccount() {
            const form = document.getElementById('switchAccountForm');
            const formData = new FormData(form);
            
            // Clear chat history when switching account
            sessionStorage.removeItem('chatbot_history');
            resetChatHistory();
            
            // Implementation for switching account
            console.log('Switching account...');
            closeSwitchAccountModal();
        }

        // Logout functionality
        function logout() {
            // Clear sessionStorage including chat history
            sessionStorage.removeItem('access_token');
            sessionStorage.removeItem('user_id');
            sessionStorage.removeItem('username');
            sessionStorage.removeItem('chatbot_history');
            
            // Reset chat history
            resetChatHistory();
            
            // Redirect to login
            window.location.href = '/login';
        }

        // Update username from sessionStorage
      function updateUsername() {
        const usernameElement = document.getElementById('username-display');
        if (usernameElement) {
                const currentUsername = sessionStorage.getItem('username');
                if (currentUsername && currentUsername.trim() !== '') {
            usernameElement.textContent = currentUsername;
          } else {
            usernameElement.textContent = 'Kh√°ch';
                }
            }
        }

        // Check authentication
        function checkAuthentication() {
            const token = sessionStorage.getItem('access_token');
            const userId = sessionStorage.getItem('user_id');
            
            if (!token || !userId) {
                window.location.href = '/login';
                return false;
            }
            
            updateUsername();
            return true;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            if (!window.location.pathname.includes('/login')) {
                checkAuthentication();
            }
        });

        // Close modal when clicking overlay
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal-overlay')) {
                const modal = e.target;
                if (shouldConfirmClose(modal)) {
                    showConfirm('X√°c nh·∫≠n ƒë√≥ng', 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒë√≥ng popup n√†y kh√¥ng? D·ªØ li·ªáu ƒë√£ nh·∫≠p s·∫Ω b·ªã m·∫•t.', 
                        function() { modal.style.display = 'none'; });
          } else {
                    modal.style.display = 'none';
                }
            }
        });

        // Close modal with ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modals = document.querySelectorAll('.modal-overlay');
                modals.forEach(modal => {
                    if (modal.style.display === 'flex') {
                        if (shouldConfirmClose(modal)) {
                            showConfirm('X√°c nh·∫≠n ƒë√≥ng', 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒë√≥ng popup n√†y kh√¥ng? D·ªØ li·ªáu ƒë√£ nh·∫≠p s·∫Ω b·ªã m·∫•t.', 
                                function() { modal.style.display = 'none'; });
            } else { 
                            modal.style.display = 'none';
                        }
                    }
                });
            }
        });

        // Global Notification System
        function openPopup() {
            document.getElementById('globalNotificationModal').style.display = 'flex';
        }

        function closePopup() {
            document.getElementById('globalNotificationModal').style.display = 'none';
        }

        function showSuccessModal(title, message, autoClose = true) {
            const modal = document.getElementById('globalNotification');
            const icon = document.getElementById('globalNotificationIcon');
            const titleEl = document.getElementById('globalNotificationTitle');
            const messageEl = document.getElementById('globalNotificationMessage');
            const footer = document.getElementById('globalNotificationFooter');
            
            modal.className = 'global-notification success';
            icon.innerHTML = '<i class="fas fa-check-circle"></i>';
            titleEl.textContent = title || 'Th√†nh c√¥ng';
            messageEl.textContent = message;
            footer.innerHTML = '<button type="button" class="global-notification-btn primary" onclick="closePopup()">ƒê√≥ng</button>';
            
            openPopup();
            
            if (autoClose) {
                setTimeout(closePopup, 3000);
            }
        }

        function showErrorModal(title, message, autoClose = true) {
            const modal = document.getElementById('globalNotification');
            const icon = document.getElementById('globalNotificationIcon');
            const titleEl = document.getElementById('globalNotificationTitle');
            const messageEl = document.getElementById('globalNotificationMessage');
            const footer = document.getElementById('globalNotificationFooter');
            
            modal.className = 'global-notification error';
            icon.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
            titleEl.textContent = title || 'L·ªói';
            messageEl.textContent = message;
            footer.innerHTML = '<button type="button" class="global-notification-btn primary" onclick="closePopup()">ƒê√≥ng</button>';
            
            openPopup();
            
            if (autoClose) {
                setTimeout(closePopup, 3000);
            }
        }

        function showInfoModal(title, message, autoClose = true) {
            const modal = document.getElementById('globalNotification');
            const icon = document.getElementById('globalNotificationIcon');
            const titleEl = document.getElementById('globalNotificationTitle');
            const messageEl = document.getElementById('globalNotificationMessage');
            const footer = document.getElementById('globalNotificationFooter');
            
            modal.className = 'global-notification info';
            icon.innerHTML = '<i class="fas fa-info-circle"></i>';
            titleEl.textContent = title || 'Th√¥ng tin';
            messageEl.textContent = message;
            footer.innerHTML = '<button type="button" class="global-notification-btn primary" onclick="closePopup()">ƒê√≥ng</button>';
            
            openPopup();
            
            if (autoClose) {
                setTimeout(closePopup, 3000);
            }
        }

        function showConfirm(title, message, onConfirm, onCancel = null) {
            const modal = document.getElementById('globalNotification');
            const icon = document.getElementById('globalNotificationIcon');
            const titleEl = document.getElementById('globalNotificationTitle');
            const messageEl = document.getElementById('globalNotificationMessage');
            const footer = document.getElementById('globalNotificationFooter');
            
            modal.className = 'global-notification warning';
            icon.innerHTML = '<i class="fas fa-question-circle"></i>';
            titleEl.textContent = title || 'X√°c nh·∫≠n';
            messageEl.textContent = message;
            
            // Create buttons with proper event listeners
            footer.innerHTML = `
                <button type="button" class="global-notification-btn secondary" id="confirmCancelBtn">H·ªßy</button>
                <button type="button" class="global-notification-btn danger" id="confirmOkBtn">X√°c nh·∫≠n</button>
            `;
            
            // Add event listeners
            document.getElementById('confirmCancelBtn').onclick = function() {
                closePopup();
                if (onCancel && typeof onCancel === 'function') {
                    onCancel();
                }
            };
            
            document.getElementById('confirmOkBtn').onclick = function() {
                closePopup();
                if (onConfirm && typeof onConfirm === 'function') {
                    onConfirm();
                }
            };
            
            openPopup();
        }

        // Override native alert function
        window.alert = function(message) {
            showInfoModal('Th√¥ng b√°o', message);
        };

        // Close notification when clicking overlay
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('global-notification-overlay')) {
                closePopup();
            }
        });

        // Close notification with ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('globalNotificationModal').style.display === 'flex') {
                closePopup();
            }
        });

        // Auto-wrap delete buttons with confirmation - DISABLED
        function wrapDeleteButtons() {
            // Disabled to prevent double confirmation popups
            return;
        }

        // Use MutationObserver to watch for dynamically added delete buttons
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList') {
                    wrapDeleteButtons();
                }
            });
        });

        observer.observe(document.body, {
            childList: true,
            subtree: true
        });

        // Wrap existing delete buttons on page load
      document.addEventListener('DOMContentLoaded', function() {
            wrapDeleteButtons();
        });

        // Patch fetch to show success messages for DELETE requests
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            return originalFetch.apply(this, args).then(response => {
                if (args[1] && args[1].method === 'DELETE' && response.ok) {
                    showSuccessModal('Th√†nh c√¥ng', 'X√≥a th√†nh c√¥ng!');
                }
                return response;
            });
        };

        // Modal confirmation system
        const modalStates = new Map(); // Store original states of modals
        
        function shouldConfirmClose(modal) {
            const modalId = modal.id;
            if (!modalId) return false;
            
            // Check if this is a form modal
            const form = modal.querySelector('form');
            if (!form) return false;
            
            // Get current form data
            const currentData = getFormData(form);
            
            // Get original data if exists
            const originalData = modalStates.get(modalId);
            
            // If no original data, check if form has any data
            if (!originalData) {
                return hasFormData(currentData);
            }
            
            // Compare current data with original data
            return !isFormDataEqual(currentData, originalData);
        }
        
        function hasFormData(data) {
            for (const key in data) {
                if (data[key] && data[key].toString().trim() !== '') {
                    return true;
                }
            }
            return false;
        }
        
        function isFormDataEqual(data1, data2) {
            const keys1 = Object.keys(data1);
            const keys2 = Object.keys(data2);
            
            if (keys1.length !== keys2.length) return false;
            
            for (const key of keys1) {
                if (data1[key] !== data2[key]) return false;
            }
            
            return true;
        }
        
        function getFormData(form) {
            const formData = new FormData(form);
            const data = {};
            
            for (const [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            // Also check hidden inputs for money fields
            const hiddenInputs = form.querySelectorAll('input[type="hidden"]');
            hiddenInputs.forEach(input => {
                if (input.name && input.value) {
                    data[input.name] = input.value;
                }
            });
            
            // Get phone value from phone component if exists
            const phoneEl = form.querySelector('input[data-phone][name="phone"]');
            if (phoneEl && window.getPhoneValue) {
                const phoneValue = window.getPhoneValue(phoneEl);
                if (phoneValue) {
                    data.phone = phoneValue;
                }
            }
            
            return data;
        }
        
        function storeModalState(modalId, form) {
            if (form) {
                const data = getFormData(form);
                modalStates.set(modalId, data);
            }
        }
        
        function clearModalState(modalId) {
            modalStates.delete(modalId);
        }
        
        // Enhanced modal close functions
        function closeModalWithConfirmation(modalId, onConfirm = null) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            
            if (shouldConfirmClose(modal)) {
                showConfirm('X√°c nh·∫≠n ƒë√≥ng', 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒë√≥ng popup n√†y kh√¥ng? D·ªØ li·ªáu ƒë√£ nh·∫≠p s·∫Ω b·ªã m·∫•t.', 
                    function() { 
                        modal.style.display = 'none';
                        clearModalState(modalId);
                        if (onConfirm) onConfirm();
                    });
            } else {
          modal.style.display = 'none';
                clearModalState(modalId);
                if (onConfirm) onConfirm();
            }
        }
        
        // Override modal close buttons
        function enhanceModalCloseButtons() {
            document.querySelectorAll('.modal-close').forEach(button => {
                if (!button.hasAttribute('data-enhanced')) {
                    button.setAttribute('data-enhanced', 'true');
                    const originalOnclick = button.getAttribute('onclick');
                    if (originalOnclick) {
                        button.setAttribute('onclick', `closeModalWithConfirmation('${button.closest('.modal-overlay').id}')`);
                    }
                }
            });
        }
        
        // Watch for dynamically added modals
        const modalObserver = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList') {
                    enhanceModalCloseButtons();
                }
            });
        });
        
        modalObserver.observe(document.body, {
            childList: true,
            subtree: true
        });
        
        // Enhance existing modal close buttons on page load
        document.addEventListener('DOMContentLoaded', function() {
            enhanceModalCloseButtons();
        });
    </script>

    <!-- Phone Input Component -->
    <script src="{{ url_for('static', filename='js/phone.js') }}"></script>
    
    <!-- Utility Functions -->
    <script src="{{ url_for('static', filename='js/utils.js') }}"></script>
    
    <!-- Chatbot Script -->
    <script>
        const BACKEND_URL = '{{ BACKEND_URL }}';
        
        // Chatbot functionality
        function toggleChatbot() {
            const chatbotWindow = document.getElementById('chatbotWindow');
            const sidebar = document.querySelector('.sidebar');
            const isVisible = chatbotWindow.style.display !== 'none';
            chatbotWindow.style.display = isVisible ? 'none' : 'flex';
            
            // Adjust position based on sidebar state
            if (!isVisible) {
                updateChatbotPosition();
                loadChatHistory();
                // Focus input when opening
                setTimeout(() => {
                    document.getElementById('chatbotInput').focus();
                }, 100);
            }
        }
        
        // Load chat history from sessionStorage
        function loadChatHistory() {
            const messagesContainer = document.getElementById('chatbotMessages');
            const chatHistory = sessionStorage.getItem('chatbot_history');
            
            // Only load if chatbot window is visible and we have history
            if (chatHistory && messagesContainer) {
                try {
                    const history = JSON.parse(chatHistory);
                    // Clear default welcome message if we have history
                    if (history.length > 0) {
                        // Check if we already loaded history (avoid duplicate loading)
                        const existingMessages = messagesContainer.querySelectorAll('.chatbot-message');
                        if (existingMessages.length <= 1) { // Only welcome message exists
                            messagesContainer.innerHTML = '';
                            history.forEach(msg => {
                                addMessageToDOM(msg.type, msg.content, false, false);
                            });
                            // Scroll to bottom after loading
                            setTimeout(() => {
                                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                            }, 100);
                        }
                    }
                } catch (e) {
                    console.error('Error loading chat history:', e);
                }
            }
        }
        
        // Save chat history to sessionStorage
        function saveChatHistory() {
            const messagesContainer = document.getElementById('chatbotMessages');
            const messages = messagesContainer.querySelectorAll('.chatbot-message');
            const history = [];
            
            messages.forEach(msg => {
                // Skip loading messages
                const isLoading = msg.getAttribute('data-loading') === 'true';
                if (isLoading) return;
                
                const type = msg.classList.contains('user') ? 'user' : 'bot';
                
                // Check if this message has suggestions
                const suggestionCard = msg.querySelector('.suggestion-card');
                if (suggestionCard) {
                    // For messages with suggestions, save the text content
                    const contentEl = msg.querySelector('.message-content p');
                    if (contentEl) {
                        const content = contentEl.textContent || contentEl.innerText;
                        if (content && !content.includes('ƒêang ph√¢n t√≠ch...')) {
                            history.push({ type, content, hasSuggestions: true });
                        }
                    }
                } else {
                    // Regular message
                    const contentEl = msg.querySelector('.message-content p');
                    if (contentEl) {
                        const content = contentEl.textContent || contentEl.innerText;
                        if (content && !content.includes('ƒêang ph√¢n t√≠ch...') && !content.includes('fa-spinner')) {
                            history.push({ type, content });
                        }
                    }
                }
            });
            
            sessionStorage.setItem('chatbot_history', JSON.stringify(history));
        }
        
        // Reset chat history
        function resetChatHistory() {
            sessionStorage.removeItem('chatbot_history');
            const messagesContainer = document.getElementById('chatbotMessages');
            // Reset to default welcome message
            messagesContainer.innerHTML = `
                <div class="chatbot-message bot">
                    <div class="message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <p>Xin ch√†o! T√¥i l√† Th∆∞ k√Ω ·∫£o AI c·ªßa b·∫°n. T√¥i c√≥ th·ªÉ gi√∫p b·∫°n:</p>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                            <li>Ph√¢n t√≠ch v√† th·ªëng k√™ t·ªìn kho</li>
                            <li>ƒê·ªÅ xu·∫•t ƒë·∫∑t h√†ng t·ª± ƒë·ªông</li>
                            <li>Ki·ªÉm tra s·∫£n ph·∫©m b√°n ch·∫°y, s·∫Øp h·∫øt h√†ng</li>
                            <li>B√°o c√°o v√† ph√¢n t√≠ch doanh thu</li>
                        </ul>
                        <p style="margin-top: 0.5rem;">H√£y th·ª≠: "ƒê·ªÅ xu·∫•t ƒë·∫∑t h√†ng", "S·∫£n ph·∫©m s·∫Øp h·∫øt", "Ph√¢n t√≠ch t·ªìn kho"</p>
                    </div>
                </div>
            `;
        }
        
        function updateChatbotPosition() {
            const chatbotWindow = document.getElementById('chatbotWindow');
            const sidebar = document.querySelector('.sidebar');
            
            if (sidebar && chatbotWindow) {
                if (sidebar.classList.contains('collapsed')) {
                    chatbotWindow.style.left = '100px';
                } else {
                    chatbotWindow.style.left = '300px';
                }
            }
        }
        
        // Update chatbot position when sidebar state changes
        document.addEventListener('DOMContentLoaded', function() {
            // Watch for sidebar class changes
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                            updateChatbotPosition();
                        }
                    });
                });
                observer.observe(sidebar, { attributes: true });
            }
        });
        
        function handleChatbotKeypress(event) {
            if (event.key === 'Enter') {
                sendChatbotMessage();
            }
        }
        
        async function sendChatbotMessage(message = null) {
            const input = document.getElementById('chatbotInput');
            const messagesContainer = document.getElementById('chatbotMessages');
            const suggestionsContainer = document.getElementById('chatbotSuggestions');
            
            const userMessage = message || input.value.trim();
            if (!userMessage) return;
            
            // Clear input
            input.value = '';
            
            // Add user message
            addMessage('user', userMessage);
            saveChatHistory(); // Save after user message
            
            // Hide suggestions while processing
            suggestionsContainer.style.display = 'none';
            
            // Show loading
            const loadingId = addMessage('bot', 'ƒêang ph√¢n t√≠ch...', true);
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/chatbot/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`
                    },
                    body: JSON.stringify({ message: userMessage })
                });
                
                // Remove loading message IMMEDIATELY before processing response
                const loadingMsg = document.getElementById(loadingId);
                if (loadingMsg) {
                    loadingMsg.remove(); // Remove immediately without animation for cleaner UX
                }
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Add bot response
                    addMessage('bot', data.response);
                    
                    // Add suggestions if available
                    if (data.suggestions && data.suggestions.length > 0) {
                        addSuggestions(data.suggestions);
                    }
                    
                    // Save history after bot response
                    saveChatHistory();
                } else {
                    addMessage('bot', 'Xin l·ªói, ƒë√£ x·∫£y ra l·ªói khi x·ª≠ l√Ω y√™u c·∫ßu c·ªßa b·∫°n.');
                    saveChatHistory();
                }
            } catch (error) {
                // Remove loading message IMMEDIATELY
                const loadingMsg = document.getElementById(loadingId);
                if (loadingMsg) {
                    loadingMsg.remove();
                }
                
                console.error('Chatbot error:', error);
                addMessage('bot', 'Xin l·ªói, kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server. Vui l√≤ng th·ª≠ l·∫°i sau.');
                saveChatHistory();
            }
            
            // Show suggestions again
            suggestionsContainer.style.display = 'flex';
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function addMessage(type, content, isLoading = false) {
            return addMessageToDOM(type, content, isLoading, true);
        }
        
        function addMessageToDOM(type, content, isLoading = false, scroll = true) {
            const messagesContainer = document.getElementById('chatbotMessages');
            const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `chatbot-message ${type}`;
            messageDiv.id = messageId;
            messageDiv.setAttribute('data-loading', isLoading ? 'true' : 'false');
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = type === 'bot' ? '<i class="fas fa-robot"></i>' : '<i class="fas fa-user"></i>';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            if (isLoading) {
                messageContent.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> ' + content + '</p>';
            } else {
                // Convert line breaks to <br>
                const formattedContent = content.replace(/\n/g, '<br>');
                messageContent.innerHTML = '<p>' + formattedContent + '</p>';
            }
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            messagesContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            if (scroll) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            return messageId;
        }
        
        function addSuggestions(suggestions) {
            const messagesContainer = document.getElementById('chatbotMessages');
            
            const suggestionCard = document.createElement('div');
            suggestionCard.className = 'suggestion-card';
            
            const title = document.createElement('h5');
            title.textContent = 'üí° ƒê·ªÅ xu·∫•t ƒë·∫∑t h√†ng:';
            suggestionCard.appendChild(title);
            
            suggestions.forEach(suggestion => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                
                const info = document.createElement('div');
                info.className = 'suggestion-item-info';
                
                const name = document.createElement('div');
                name.className = 'suggestion-item-name';
                name.textContent = suggestion.product_name || suggestion.ma_sp;
                
                const details = document.createElement('div');
                details.className = 'suggestion-item-details';
                let detailsText = `M√£: ${suggestion.ma_sp} | T·ªìn kho: ${(suggestion.current_stock || 0).toLocaleString()}`;
                if (suggestion.days_until_out && suggestion.days_until_out !== 'N/A') {
                    detailsText += ` | D·ª± ki·∫øn h·∫øt trong: ${suggestion.days_until_out} ng√†y`;
                }
                if (suggestion.sales_rate) {
                    detailsText += ` | T·ªëc ƒë·ªô b√°n: ${suggestion.sales_rate}/ng√†y`;
                }
                details.textContent = detailsText;
                
                info.appendChild(name);
                info.appendChild(details);
                
                const action = document.createElement('div');
                action.className = 'suggestion-item-action';
                
                const orderBtn = document.createElement('button');
                orderBtn.className = 'order-btn';
                orderBtn.textContent = `ƒê·∫∑t ${(suggestion.recommended_quantity || 0).toLocaleString()}`;
                orderBtn.onclick = () => createOrderFromSuggestion(suggestion);
                
                action.appendChild(orderBtn);
                
                item.appendChild(info);
                item.appendChild(action);
                suggestionCard.appendChild(item);
            });
            
            const botMessage = document.createElement('div');
            botMessage.className = 'chatbot-message bot';
            botMessage.setAttribute('data-loading', 'false');
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = '<i class="fas fa-robot"></i>';
            
            botMessage.appendChild(avatar);
            botMessage.appendChild(suggestionCard);
            
            messagesContainer.appendChild(botMessage);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        async function createOrderFromSuggestion(suggestion) {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën t·∫°o ƒë∆°n ƒë·∫∑t h√†ng cho ${suggestion.product_name} v·ªõi s·ªë l∆∞·ª£ng ${(suggestion.recommended_quantity || 0).toLocaleString()}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/chatbot/create-order`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`
                    },
                    body: JSON.stringify({
                        product_code: suggestion.ma_sp,
                        quantity: suggestion.recommended_quantity
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    addMessage('bot', `‚úÖ ${data.message}`);
                    
                    // Show success notification
                    if (typeof showSuccessModal === 'function') {
                        showSuccessModal('Th√†nh c√¥ng', data.message);
                    }
                    
                    // Optionally redirect to orders page
                    setTimeout(() => {
                        if (confirm('B·∫°n c√≥ mu·ªën xem ƒë∆°n h√†ng v·ª´a t·∫°o kh√¥ng?')) {
                            window.location.href = '/orders';
                        }
                    }, 1000);
                } else {
                    const error = await response.json();
                    addMessage('bot', `‚ùå L·ªói: ${error.detail || 'Kh√¥ng th·ªÉ t·∫°o ƒë∆°n h√†ng'}`);
                }
            } catch (error) {
                console.error('Error creating order:', error);
                addMessage('bot', '‚ùå ƒê√£ x·∫£y ra l·ªói khi t·∫°o ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }
        
        // Check for low stock products on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkLowStockProducts();
        });
        
        async function checkLowStockProducts() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/chatbot/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`
                    },
                    body: JSON.stringify({ message: 's·∫£n ph·∫©m s·∫Øp h·∫øt' })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.suggestions && data.suggestions.length > 0) {
                        // Show badge if there are products needing reorder
                        const badge = document.getElementById('chatbotBadge');
                        if (badge) {
                            badge.textContent = data.suggestions.length;
                            badge.style.display = 'flex';
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking low stock:', error);
            }
        }
        
        // Close chatbot when clicking outside
        document.addEventListener('click', function(e) {
            const chatbotWindow = document.getElementById('chatbotWindow');
            const chatbotSection = document.querySelector('.chatbot-section');
            
            if (chatbotWindow && chatbotWindow.style.display !== 'none') {
                if (!chatbotWindow.contains(e.target) && !chatbotSection.contains(e.target)) {
                    chatbotWindow.style.display = 'none';
                }
            }
        });
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html> 
