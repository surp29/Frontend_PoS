{% extends "base.html" %}

{% block title %}Xếp hạng khách hàng - PhanMemKeToan{% endblock %}

{% block page_title %}
<i class="fas fa-trophy"></i> Xếp hạng khách hàng
{% endblock %}

{% block page_description %}
Bảng xếp hạng theo tổng giá trị đã mua của khách hàng
{% endblock %}

{% block content %}
<!-- Statistics Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-trophy"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="totalRankedCustomers">0</div>
            <div class="stat-label">Khách hàng được xếp hạng</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-money-bill-wave"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="totalRevenue">0 VNĐ</div>
            <div class="stat-label">Tổng doanh thu</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-gem"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="diamondCustomers">0</div>
            <div class="stat-label">Khách hàng Kim cương</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-file-invoice"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="totalPaidInvoices">0</div>
            <div class="stat-label">Hóa đơn đã thanh toán</div>
        </div>
    </div>
</div>

<div class="table-container">
    <div class="card">
        <div class="card-header">
            <h3>Bảng xếp hạng khách hàng</h3>
        </div>
        <div class="card-body p-0">
            <table class="table" id="leaderboardTable">
                <thead>
                    <tr>
                        <th>Hạng</th>
                        <th>Tên khách hàng</th>
                        <th>Mã KH</th>
                        <th>Hạng thành viên</th>
                        <th>Hạn mức</th>
                        <th>Tổng SL mua</th>
                        <th>Số hóa đơn</th>
                        <th>Tổng giá trị</th>
                    </tr>
                </thead>
                <tbody id="leaderboardTableBody">
                    <tr><td colspan="8" style="text-align:center; padding: var(--spacing-4); color: var(--gray-600);">Đang tải...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Pagination -->
<div class="pagination" id="leaderboardPagination">
    <!-- Pagination will be generated here -->
</div>
{% endblock %}

{% block extra_js %}
<script>
let leaderboardData = [];
let filteredLeaderboard = [];
let currentPage = 1;
const itemsPerPage = 20; // Popup modal: 20 items per page

document.addEventListener('DOMContentLoaded', function() {
    loadLeaderboardData();
});

async function loadLeaderboardData() {
    try {
        const response = await fetch('{{ BACKEND_URL }}/api/customers-analytics/leaderboard', {
            headers: {
                'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`
            }
        });
        if (response.ok) {
            const data = await response.json();
            leaderboardData = Array.isArray(data) ? data : [];
            filteredLeaderboard = [...leaderboardData];
            updateStatistics();
            updateLeaderboardTable();
            updateLeaderboardPagination();
        } else {
            document.getElementById('leaderboardTableBody').innerHTML = '<tr><td colspan="8" style="text-align:center; padding: var(--spacing-4); color: var(--gray-600);">Không thể tải dữ liệu</td></tr>';
        }
    } catch (e) {
        console.error('Error loading leaderboard:', e);
        document.getElementById('leaderboardTableBody').innerHTML = '<tr><td colspan="8" style="text-align:center; padding: var(--spacing-4); color: var(--gray-600);">Có lỗi xảy ra</td></tr>';
    }
}

function updateStatistics() {
    const totalRankedCustomers = leaderboardData.length;
    const totalRevenue = leaderboardData.reduce((sum, c) => sum + (c.totalAmount || 0), 0);
    const diamondCustomers = leaderboardData.filter(c => c.tierName === 'Kim cương').length;
    const totalPaidInvoices = leaderboardData.reduce((sum, c) => sum + (c.invoiceCount || 0), 0);
    
    document.getElementById('totalRankedCustomers').textContent = totalRankedCustomers;
    document.getElementById('totalRevenue').textContent = totalRevenue.toLocaleString('vi-VN') + ' VNĐ';
    document.getElementById('diamondCustomers').textContent = diamondCustomers;
    document.getElementById('totalPaidInvoices').textContent = totalPaidInvoices;
}

function updateLeaderboardTable() {
    const tbody = document.getElementById('leaderboardTableBody');
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageLeaderboard = filteredLeaderboard.slice(startIndex, endIndex);
    
    if (pageLeaderboard.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: var(--spacing-4); color: var(--gray-600);">Chưa có dữ liệu xếp hạng</td></tr>';
        return;
    }
    
    tbody.innerHTML = pageLeaderboard.map((r, index) => {
        return `
        <tr>
            <td><strong style="font-size: 1.1em; color: var(--primary-color);">${startIndex + index + 1}</strong></td>
            <td><strong>${r.customerName || '-'}</strong></td>
            <td>${r.customerCode || '-'}</td>
            <td>
                <span class="badge" style="background-color: ${r.tierColor || '#cd7f32'}; color: white; font-weight: 600;">
                    ${r.tierName || 'Đồng'}
                </span>
            </td>
            <td>${(r.creditLimit || 0).toLocaleString('vi-VN')} VNĐ</td>
            <td>${r.totalQuantity || 0}</td>
            <td>${r.invoiceCount || 0}</td>
            <td><strong style="color: var(--primary-color);">${(r.totalAmount || 0).toLocaleString('vi-VN')} VNĐ</strong></td>
        </tr>
    `;
    }).join('');
}

function updateLeaderboardPagination() {
    const totalPages = Math.ceil(filteredLeaderboard.length / itemsPerPage);
    const pagination = document.getElementById('leaderboardPagination');
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    pagination.innerHTML = generatePaginationHTML(currentPage, totalPages);
}

function goToPage(page) {
    const totalPages = Math.ceil(filteredLeaderboard.length / itemsPerPage);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        updateLeaderboardTable();
        updateLeaderboardPagination();
    }
}

// Make goToPage available globally
window.goToPage = goToPage;
</script>
{% endblock %}




