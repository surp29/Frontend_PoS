{% extends "base.html" %}

{% block title %}Quản lý hóa đơn - PhanMemKeToan{% endblock %}

{% block page_title %}
<i class="fas fa-file-invoice"></i> Quản lý hóa đơn
{% endblock %}

{% block page_description %}
Quản lý và theo dõi các hóa đơn, xử lý thanh toán và cập nhật trạng thái hóa đơn
{% endblock %}

{% block content %}
<!-- Statistics Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-file-invoice"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="totalInvoices">0</div>
            <div class="stat-label">Tổng hóa đơn</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="paidInvoices">0</div>
            <div class="stat-label">Đã thanh toán</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-clock"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="pendingInvoices">0</div>
            <div class="stat-label">Chưa thanh toán</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-money-bill-wave"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="totalRevenue">0 VNĐ</div>
            <div class="stat-label">Tổng doanh thu</div>
        </div>
    </div>
</div>

<!-- Status Tabs -->
<div class="tabs-container">
<div class="tabs">
  <button class="tab active" data-status="all">Tất cả</button>
  <button class="tab" data-status="Đã thanh toán">Đã thanh toán</button>
  <button class="tab" data-status="Chưa thanh toán">Chưa thanh toán</button>
    </div>
</div>

<!-- Filter Bar -->
<div class="filter-bar">
    <div class="filter-row">
        <div class="form-group">
            <label class="form-label">Tìm kiếm</label>
            <div class="search-input">
                <i class="fas fa-search"></i>
                <input type="text" class="form-input" id="searchInvoice" placeholder="Tìm theo số hóa đơn, khách hàng...">
  </div>
  </div>
        
        <div class="form-group">
            <label class="form-label">Tìm khách hàng</label>
            <div class="customer-search-container">
                <div class="search-input">
                    <i class="fas fa-search"></i>
                    <input type="text" id="customerSearch" class="form-input" placeholder="Tìm kiếm hoặc nhập tên khách hàng" autocomplete="off" onkeypress="handleCustomerKeypress(event)">
                </div>
                <!-- Custom dropdown list -->
                <div class="customer-dropdown-list" id="customerDropdownList" style="display: none;">
                    <!-- Options will be populated dynamically -->
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Từ ngày</label>
            <input type="date" class="form-input" id="fromDate">
  </div>
        
        <div class="form-group">
            <label class="form-label">Đến ngày</label>
            <input type="date" class="form-input" id="toDate">
  </div>
        
    

        <div class="form-group">
            <button class="btn btn-secondary" onclick="clearFilters()">
                <i class="fas fa-times"></i>
                Xóa bộ lọc
            </button>
        </div>
    </div>
  </div>

<!-- Invoices Table -->
<div class="table-container">
    <div class="card">
        <div class="card-header">
            <h3>Danh sách hóa đơn</h3>
            <button class="btn btn-primary" onclick="openAddInvoiceModal()">
                <i class="fas fa-plus"></i>
                Thêm hóa đơn
    </button>
  </div>
        <div class="card-body p-0">
            <table class="table" id="invoicesTable">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Số hóa đơn</th>
                        <th>Ngày tạo</th>
                        <th>Khách hàng</th>
                        
                        <th>Tổng tiền</th>
                        <th>Trạng thái</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody id="invoicesTableBody">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>
  </div>
</div>

<!-- Pagination -->
<div class="pagination" id="pagination">
    <!-- Pagination will be generated here -->
</div>

<!-- Add Invoice Modal -->
<div class="modal-overlay" id="addInvoiceModal" style="display: none;">
    <div class="modal modal-horizontal">
    <div class="modal-header">
            <h3><i class="fas fa-plus"></i> Thêm hóa đơn mới</h3>
            <button class="modal-close" onclick="closeAddInvoiceModal()">
                <i class="fas fa-times"></i>
            </button>
    </div>
        <div class="modal-body">
            <form id="addInvoiceForm">
                <!-- Row 1: Số hóa đơn | Ngày tạo -->
       <div class="form-row">
         <div class="form-group">
                        <label class="form-label">Số hóa đơn *</label>
                        <input type="text" class="form-input" name="so_hoa_don" required placeholder="Nhập số hóa đơn">
         </div>
         <div class="form-group">
                        <label class="form-label">Ngày tạo *</label>
                        <input type="date" class="form-input" name="ngay_tao" required>
         </div>
       </div>
      
                <!-- Row 2: Tên khách hàng | Mã đơn hàng -->
                <div class="form-row">
         <div class="form-group">
                    <label class="form-label">Tên khách hàng *</label>
                    <div class="customer-search-container">
                        <div class="search-input">
                            <i class="fas fa-search"></i>
                                <input type="text" class="form-input" name="ten_khach_hang" id="addCustomerName" required placeholder="Tìm kiếm hoặc nhập tên khách hàng" autocomplete="off" onkeypress="handleAddCustomerKeypress(event)" onchange="handleCustomerChange()">
                        </div>
                        <!-- Custom dropdown list -->
                        <div class="customer-dropdown-list" id="addCustomerDropdownList" style="display: none;">
                            <!-- Options will be populated dynamically -->
                        </div>
                    </div>
                        <input type="hidden" id="selectedCustomerId" name="customer_id">
       </div>
         <div class="form-group">
                        <label class="form-label">Mã đơn hàng</label>
                        <div class="order-search-container">
                            <div class="search-input">
                                <i class="fas fa-search"></i>
                                <input type="text" class="form-input" id="addOrderCode" placeholder="Tìm kiếm mã đơn hàng" autocomplete="off" readonly onclick="showOrderDropdown()">
                            </div>
                            <!-- Custom dropdown list for orders -->
                            <div class="order-dropdown-list" id="addOrderDropdownList" style="display: none;">
                                <!-- Options will be populated dynamically -->
                            </div>
                        </div>
                        <input type="hidden" id="selectedOrderId" name="order_id">
         </div>
       </div>
      
                <!-- Row 3: Tổng tiền | Hình thức thanh toán -->
                <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Tổng tiền *</label>
                    <div class="money-input-container">
                        <input type="text" id="add_tong_tien_display" class="form-input" placeholder="0" oninput="formatMoneyTyping(this, document.getElementById('add_tong_tien'))">
                        <input type="hidden" name="tong_tien" id="add_tong_tien">
                        <span class="currency-unit">VNĐ</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Hình thức thanh toán *</label>
                        <select class="form-select" name="hinh_thuc_tt" id="addHinhThucTT" required>
                            <option value="">Chọn hình thức thanh toán</option>
                            <option value="Tiền mặt">Tiền mặt</option>
                            <option value="MoMo">MoMo</option>
                            <option value="Banking">Banking</option>
                        </select>
                    </div>
                </div>
                
                <!-- Row 4: Trạng thái | Ghi chú -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Trạng thái *</label>
                        <select class="form-select" name="trang_thai" required>
                            <option value="">Chọn trạng thái</option>
                            <option value="Đã thanh toán">Đã thanh toán</option>
                            <option value="Chưa thanh toán">Chưa thanh toán</option>
                        </select>
                    </div>
                <div class="form-group">
                    <label class="form-label">Ghi chú</label>
                    <textarea class="form-textarea" name="ghi_chu" rows="3" placeholder="Nhập ghi chú"></textarea>
                    </div>
      </div>
    </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeAddInvoiceModal()">Hủy</button>
            <button type="button" class="btn btn-primary" onclick="createInvoice()">Tạo hóa đơn</button>
        </div>
  </div>
</div>

<!-- Edit Invoice Modal -->
<div class="modal-overlay" id="editInvoiceModal" style="display: none;">
    <div class="modal modal-horizontal">
    <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Chỉnh sửa hóa đơn</h3>
            <button class="modal-close" onclick="closeEditInvoiceModal()">
                <i class="fas fa-times"></i>
            </button>
    </div>
        <div class="modal-body">
            <form id="editInvoiceForm">
                <input type="hidden" name="id">
      
      <div class="form-row">
        <div class="form-group">
                        <label class="form-label">Số hóa đơn</label>
                        <input type="text" class="form-input" name="so_hoa_don" readonly>
        </div>
        <div class="form-group">
                        <label class="form-label">Ngày tạo *</label>
                        <input type="date" class="form-input" name="ngay_tao" required>
        </div>
      </div>
      
        <div class="form-group">
                    <label class="form-label">Tên khách hàng</label>
                    <input type="text" class="form-input" name="ten_khach_hang" readonly>
      </div>
      
      <!-- Row 3: Tổng tiền | Hình thức thanh toán -->
      <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Tổng tiền</label>
                    <div class="money-input-container">
                <input type="text" id="edit_tong_tien_display" class="form-input" oninput="formatMoneyTyping(this, document.getElementById('edit_tong_tien'))">
                        <input type="hidden" name="tong_tien" id="edit_tong_tien">
                        <span class="currency-unit">VNĐ</span>
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">Hình thức thanh toán *</label>
            <select class="form-select" name="hinh_thuc_tt" id="editHinhThucTT" required>
                <option value="">Chọn hình thức thanh toán</option>
                <option value="Tiền mặt">Tiền mặt</option>
                <option value="MoMo">MoMo</option>
                <option value="Banking">Banking</option>
            </select>
  </div>
</div>

      <!-- Row 4: Trạng thái | Ghi chú -->
      <div class="form-row">
        <div class="form-group">
            <label class="form-label">Trạng thái *</label>
            <select class="form-select" name="trang_thai" required>
                <option value="">Chọn trạng thái</option>
                <option value="Đã thanh toán">Đã thanh toán</option>
                <option value="Chưa thanh toán">Chưa thanh toán</option>
            </select>
        </div>
                <div class="form-group">
                    <label class="form-label">Ghi chú</label>
            <textarea class="form-textarea" name="ghi_chu" rows="3" placeholder="Nhập ghi chú (tùy chọn)"></textarea>
        </div>
    </div>
            </form>
    </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeEditInvoiceModal()">Hủy</button>
            <button type="button" class="btn btn-primary" onclick="updateInvoice()">Cập nhật</button>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" id="deleteInvoiceModal" style="display: none;">
    <div class="modal modal-small">
        <div class="modal-header">
            <h3><i class="fas fa-exclamation-triangle"></i> Xác nhận xóa</h3>
            <button class="modal-close" onclick="closeDeleteInvoiceModal()">
                <i class="fas fa-times"></i>
            </button>
    </div>
        <div class="modal-body">
            <p>Bạn có chắc chắn muốn xóa hóa đơn này không?</p>
            <p class="text-gray-600">Hành động này không thể hoàn tác.</p>
    </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeDeleteInvoiceModal()">Hủy</button>
            <button type="button" class="btn btn-danger" onclick="confirmDeleteInvoice()">Xóa</button>
    </div>
  </div>
</div>

<!-- View Invoice Details Modal -->
<div class="modal-overlay" id="viewInvoiceDetailsModal" style="display: none;">
    <div class="modal modal-large">
        <div class="modal-header">
            <h3><i class="fas fa-file-invoice"></i> Chi tiết hóa đơn</h3>
            <button class="modal-close" onclick="closeViewInvoiceDetailsModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div id="invoiceDetailsContent">
                <!-- Invoice details will be loaded here -->
                <div style="text-align: center; padding: var(--spacing-6);">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2em; color: var(--primary-color);"></i>
                    <p style="margin-top: var(--spacing-2);">Đang tải chi tiết hóa đơn...</p>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeViewInvoiceDetailsModal()">Đóng</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let invoicesData = [];
let filteredInvoices = [];
let currentPage = 1;
const itemsPerPage = 20; // Popup modal: 20 items per page
let deleteInvoiceId = null;
let currentStatus = 'all';
let customersData = [];

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadInvoicesData();
    loadCustomers();
    setupEventListeners();
});

// Setup event listeners
function setupEventListeners() {
    // Tab clicks
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            currentStatus = this.getAttribute('data-status');
            filterInvoices();
  });
});

    // Filter inputs
    document.getElementById('searchInvoice').addEventListener('input', debounce(filterInvoices, 300));
    document.getElementById('fromDate').addEventListener('change', filterInvoices);
    document.getElementById('toDate').addEventListener('change', filterInvoices);
    document.getElementById('customerSearch').addEventListener('input', debounce(filterInvoices, 300));
    // removed type filter
}

// Load customers
async function loadCustomers() {
    try {
        const response = await fetch('{{ BACKEND_URL }}/api/accounts/');
        if (response.ok) {
            customersData = await response.json();
            console.log('Loaded customers:', customersData);
            populateCustomerList();
            populateAddCustomerList();
            // Setup dropdown events after customers are loaded
            setupCustomerDropdownEvents();
            setupAddCustomerDropdownEvents();
        }
    } catch (error) {
        console.error('Error loading customers:', error);
    }
}

// Populate customer dropdown
function populateCustomerList(searchTerm = '') {
    const dropdownList = document.getElementById('customerDropdownList');
    const customerInput = document.getElementById('customerSearch');
    
    console.log('populateCustomerList called with searchTerm:', searchTerm);
    console.log('dropdownList element:', dropdownList);
    
    if (!dropdownList) {
        console.error('Dropdown element not found!');
        return;
    }
    
    dropdownList.innerHTML = '';
    
    // Get all customers (not just active ones)
    let allCustomers = customersData || [];
    console.log('All customers for dropdown:', allCustomers);
    
    // Filter by search term if provided
    if (searchTerm) {
        const searchLower = searchTerm.toLowerCase();
        allCustomers = allCustomers.filter(c => {
            const name = (c.ten_tk || '').toLowerCase();
            const email = (c.email || '').toLowerCase();
            const phone = (c.so_dt || '').toLowerCase();
            return name.includes(searchLower) || email.includes(searchLower) || phone.includes(searchLower);
        });
        console.log('Filtered customers for search "' + searchTerm + '":', allCustomers);
    }
    
    // Add "Tất cả khách hàng" first (always show)
    const allCustomersDiv = document.createElement('div');
    allCustomersDiv.className = 'customer-dropdown-item';
    allCustomersDiv.dataset.value = '';
    allCustomersDiv.innerHTML = '<strong>Tất cả khách hàng</strong>';
    allCustomersDiv.onclick = function() {
        selectCustomer('');
    };
    dropdownList.appendChild(allCustomersDiv);
    
    // Add customers
    if (allCustomers.length === 0 && searchTerm) {
        // Show option to use typed name as customer name
        const customCustomerDiv = document.createElement('div');
        customCustomerDiv.className = 'customer-dropdown-item';
        customCustomerDiv.dataset.value = searchTerm;
        customCustomerDiv.innerHTML = `<strong>Thêm khách hàng: "${searchTerm}"</strong><small>Nhấn Enter để sử dụng</small>`;
        customCustomerDiv.onclick = function() {
            selectCustomer(searchTerm);
        };
        dropdownList.appendChild(customCustomerDiv);
        
        const noResult = document.createElement('div');
        noResult.className = 'customer-dropdown-item';
        noResult.innerHTML = '<small style="color: var(--gray-500);">Không tìm thấy khách hàng có sẵn</small>';
        dropdownList.appendChild(noResult);
    } else {
        allCustomers.forEach(customer => {
            const name = customer.ten_tk || '';
            const email = customer.email || '';
            const phone = customer.so_dt || '';
            
            const item = document.createElement('div');
            item.className = 'customer-dropdown-item';
            item.dataset.value = name;
            
            let displayText = `<strong>${name}</strong>`;
            if (email) {
                displayText += `<small>${email}</small>`;
            } else if (phone) {
                displayText += `<small>${phone}</small>`;
            }
            
            item.innerHTML = displayText;
            item.onclick = function() {
                selectCustomer(name);
            };
            
            dropdownList.appendChild(item);
        });
        
        // If user is typing and there are results, also show option to use typed name
        if (searchTerm && allCustomers.length > 0) {
            const customCustomerDiv = document.createElement('div');
            customCustomerDiv.className = 'customer-dropdown-item';
            customCustomerDiv.dataset.value = searchTerm;
            customCustomerDiv.innerHTML = `<strong>Thêm khách hàng: "${searchTerm}"</strong><small>Nhấn Enter để sử dụng</small>`;
            customCustomerDiv.onclick = function() {
                selectCustomer(searchTerm);
                toggleDropdown();
            };
            dropdownList.appendChild(customCustomerDiv);
        }
    }
}

// Handle customer input keypress
function handleCustomerKeypress(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        const customerInput = document.getElementById('customerSearch');
        const searchTerm = customerInput.value.trim();
        
        if (searchTerm) {
            // If user typed something, use that as customer name
            selectCustomer(searchTerm);
        } else {
            // If empty, select "Tất cả khách hàng"
            selectCustomer('');
        }
    }
}

// Handle add customer input keypress
function handleAddCustomerKeypress(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        const customerInput = document.getElementById('addCustomerName');
        const searchTerm = customerInput.value.trim();
        
        if (searchTerm) {
            // If user typed something, use that as customer name
            selectAddCustomer(searchTerm);
        } else {
            // If empty, select "Khách vãng lai"
            selectAddCustomer('Khách vãng lai');
        }
    }
}
// Toggle dropdown
function toggleDropdown() {
    const dropdown = document.getElementById('customerDropdownList');
    if (dropdown) {
        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
    }
}

// Toggle add dropdown
function toggleAddDropdown() {
    const dropdown = document.getElementById('addCustomerDropdownList');
    if (dropdown) {
        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
    }
}

// Select customer
function selectCustomer(customerName) {
    const customerInput = document.getElementById('customerSearch');
    
    if (customerInput) {
        customerInput.value = customerName;
    }
    
    // Close dropdown
    const dropdown = document.getElementById('customerDropdownList');
    if (dropdown) {
        dropdown.style.display = 'none';
    }
    
    // Trigger filter
    filterInvoices();
}

// Select add customer
function selectAddCustomer(customerName) {
    const customerInput = document.getElementById('addCustomerName');
    
    if (customerInput) {
        customerInput.value = customerName;
    }
    
    // Find customer ID from customersData
    const customer = customersData.find(c => c.ten_tk === customerName);
    if (customer) {
        document.getElementById('selectedCustomerId').value = customer.id;
    } else {
        document.getElementById('selectedCustomerId').value = '';
    }
    
    // Reset order code when customer changes
    document.getElementById('addOrderCode').value = '';
    document.getElementById('selectedOrderId').value = '';
    document.getElementById('add_tong_tien_display').value = '';
    document.getElementById('add_tong_tien').value = '';
    
    // Close dropdown
    const dropdown = document.getElementById('addCustomerDropdownList');
    if (dropdown) {
        dropdown.style.display = 'none';
    }
}

// Handle customer change
function handleCustomerChange() {
    const customerName = document.getElementById('addCustomerName').value;
    const customer = customersData.find(c => c.ten_tk === customerName);
    if (customer) {
        document.getElementById('selectedCustomerId').value = customer.id;
    } else {
        document.getElementById('selectedCustomerId').value = '';
    }
    
    // Reset order code when customer changes
    document.getElementById('addOrderCode').value = '';
    document.getElementById('selectedOrderId').value = '';
    document.getElementById('add_tong_tien_display').value = '';
    document.getElementById('add_tong_tien').value = '';
    
    // Close order dropdown if open
    const orderDropdown = document.getElementById('addOrderDropdownList');
    if (orderDropdown) {
        orderDropdown.style.display = 'none';
    }
}

// Populate add customer dropdown
function populateAddCustomerList(searchTerm = '') {
    const dropdownList = document.getElementById('addCustomerDropdownList');
    const customerInput = document.getElementById('addCustomerName');
    
    if (!dropdownList) {
        console.error('Add customer dropdown element not found!');
        return;
    }
    
    dropdownList.innerHTML = '';
    
    // Get filtered active customers
    let activeCustomers = customersData.filter(c => c.trang_thai === true || c.trang_thai === 'true');
    
    // Filter by search term if provided
    if (searchTerm) {
        const searchLower = searchTerm.toLowerCase();
        activeCustomers = activeCustomers.filter(c => {
            const name = (c.ten_tk || '').toLowerCase();
            const email = (c.email || '').toLowerCase();
            const phone = (c.so_dt || '').toLowerCase();
            return name.includes(searchLower) || email.includes(searchLower) || phone.includes(searchLower);
        });
    }
    
    // Add "Khách vãng lai" first (always show)
    const walkInDiv = document.createElement('div');
    walkInDiv.className = 'customer-dropdown-item';
    walkInDiv.dataset.value = 'Khách vãng lai';
    walkInDiv.innerHTML = '<strong>Khách vãng lai</strong>';
    walkInDiv.onclick = function() {
        selectAddCustomer('Khách vãng lai');
        toggleAddDropdown();
    };
    dropdownList.appendChild(walkInDiv);
    
    // Add active customers
    if (activeCustomers.length === 0 && searchTerm) {
        // Show option to use typed name as customer name
        const customCustomerDiv = document.createElement('div');
        customCustomerDiv.className = 'customer-dropdown-item';
        customCustomerDiv.dataset.value = searchTerm;
        customCustomerDiv.innerHTML = `<strong>Thêm khách hàng: "${searchTerm}"</strong><small>Nhấn Enter để sử dụng</small>`;
        customCustomerDiv.onclick = function() {
            selectAddCustomer(searchTerm);
        };
        dropdownList.appendChild(customCustomerDiv);
        
        const noResult = document.createElement('div');
        noResult.className = 'customer-dropdown-item';
        noResult.innerHTML = '<small style="color: var(--gray-500);">Không tìm thấy khách hàng có sẵn</small>';
        dropdownList.appendChild(noResult);
    } else {
        activeCustomers.forEach(customer => {
            const name = customer.ten_tk || '';
            const email = customer.email || '';
            const phone = customer.so_dt || '';
            
            const item = document.createElement('div');
            item.className = 'customer-dropdown-item';
            item.dataset.value = name;
            
            let displayText = `<strong>${name}</strong>`;
            if (email) {
                displayText += `<small>${email}</small>`;
            } else if (phone) {
                displayText += `<small>${phone}</small>`;
            }
            
            item.innerHTML = displayText;
            item.onclick = function() {
                selectAddCustomer(name);
            };
            
            dropdownList.appendChild(item);
        });
        
        // If user is typing and there are results, also show option to use typed name
        if (searchTerm && activeCustomers.length > 0) {
            const customCustomerDiv = document.createElement('div');
            customCustomerDiv.className = 'customer-dropdown-item';
            customCustomerDiv.dataset.value = searchTerm;
            customCustomerDiv.innerHTML = `<strong>Thêm khách hàng: "${searchTerm}"</strong><small>Nhấn Enter để sử dụng</small>`;
            customCustomerDiv.onclick = function() {
                selectAddCustomer(searchTerm);
                toggleAddDropdown();
            };
            dropdownList.appendChild(customCustomerDiv);
        }
    }
}

// Setup customer input events
function setupCustomerDropdownEvents() {
    const customerInput = document.getElementById('customerSearch');
    const dropdown = document.getElementById('customerDropdownList');
    
    console.log('Setting up customer dropdown events...');
    console.log('customerInput:', customerInput);
    console.log('dropdown:', dropdown);
    
    if (customerInput && dropdown) {
        console.log('Both elements found, setting up event listeners');
        // Click on input to show dropdown
        customerInput.addEventListener('click', function() {
            const searchTerm = customerInput.value;
            populateCustomerList(searchTerm);
            dropdown.style.display = 'block';
            highlightMatchedCustomer(searchTerm);
        });
        
        // Focus on input to show dropdown and all customers
        customerInput.addEventListener('focus', function() {
            const searchTerm = customerInput.value;
            populateCustomerList(searchTerm);
            dropdown.style.display = 'block';
            highlightMatchedCustomer(searchTerm);
        });
        
        // Real-time search as user types - always show dropdown when typing
        customerInput.addEventListener('input', function() {
            const searchTerm = customerInput.value;
            console.log('Input event triggered, searchTerm:', searchTerm);
            populateCustomerList(searchTerm);
            dropdown.style.display = 'block';
            console.log('Dropdown display set to block');
            highlightMatchedCustomer(searchTerm);
        });
        
        // Handle keydown for better UX
        customerInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                dropdown.style.display = 'none';
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                // Focus first item in dropdown
                const firstItem = dropdown.querySelector('.customer-dropdown-item');
                if (firstItem) {
                    firstItem.focus();
                }
            }
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!customerInput.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });
        
        console.log('Customer dropdown events setup completed');
    } else {
        console.error('Customer input or dropdown element not found!');
    }
}

// Setup add customer input events
function setupAddCustomerDropdownEvents() {
    const customerInput = document.getElementById('addCustomerName');
    const dropdown = document.getElementById('addCustomerDropdownList');
    
    console.log('Setting up add customer dropdown events...');
    console.log('addCustomerInput:', customerInput);
    console.log('addCustomerDropdown:', dropdown);
    
    if (customerInput && dropdown) {
        console.log('Both add customer elements found, setting up event listeners');
        
        // Click on input to show dropdown
        customerInput.addEventListener('click', function() {
            const searchTerm = customerInput.value;
            populateAddCustomerList(searchTerm);
            dropdown.style.display = 'block';
            highlightMatchedAddCustomer(searchTerm);
        });
        
        // Focus on input to show dropdown and all customers
        customerInput.addEventListener('focus', function() {
            const searchTerm = customerInput.value;
            populateAddCustomerList(searchTerm);
            dropdown.style.display = 'block';
            highlightMatchedAddCustomer(searchTerm);
        });
        
        // Real-time search as user types - always show dropdown when typing
        customerInput.addEventListener('input', function() {
            const searchTerm = customerInput.value;
            console.log('Add customer input event triggered, searchTerm:', searchTerm);
            populateAddCustomerList(searchTerm);
            dropdown.style.display = 'block';
            console.log('Add customer dropdown display set to block');
            highlightMatchedAddCustomer(searchTerm);
        });
        
        // Handle keydown for better UX
        customerInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                dropdown.style.display = 'none';
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                // Focus first item in dropdown
                const firstItem = dropdown.querySelector('.customer-dropdown-item');
                if (firstItem) {
                    firstItem.focus();
                }
            }
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!customerInput.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });
        
        console.log('Add customer dropdown events setup completed');
    } else {
        console.error('Add customer input or dropdown element not found!');
    }
}

// Function to highlight matched add customer
function highlightMatchedAddCustomer(searchTerm) {
    if (!searchTerm || searchTerm.trim() === '') {
        return; // Don't highlight anything if search term is empty
    }
    
    const dropdown = document.getElementById('addCustomerDropdownList');
    if (!dropdown) return;
    
    // Clear all highlights
    const items = dropdown.querySelectorAll('.customer-dropdown-item');
    items.forEach(item => item.classList.remove('selected'));
    
    // Find and highlight matching customer
    searchTerm = searchTerm.trim().toLowerCase();
    const matchingItem = Array.from(items).find(item => {
        const value = (item.dataset.value || '').toLowerCase();
        return value === searchTerm || value.includes(searchTerm);
    });
    
    if (matchingItem) {
        matchingItem.classList.add('selected');
    }
}

// Function to highlight matched customer
function highlightMatchedCustomer(searchTerm) {
    if (!searchTerm || searchTerm.trim() === '') {
        return; // Don't highlight anything if search term is empty
    }
    
    const dropdown = document.getElementById('customerDropdownList');
    if (!dropdown) return;
    
    // Clear all highlights
    const items = dropdown.querySelectorAll('.customer-dropdown-item');
    items.forEach(item => item.classList.remove('selected'));
    
    // Find and highlight matching customer
    searchTerm = searchTerm.trim().toLowerCase();
    const matchingItem = Array.from(items).find(item => {
        const value = (item.dataset.value || '').toLowerCase();
        return value === searchTerm || value.includes(searchTerm);
    });
    
    if (matchingItem) {
        matchingItem.classList.add('selected');
    }
}
async function loadInvoicesData() {
    try {
        const response = await fetch('{{ BACKEND_URL }}/api/invoices/');
        if (response.ok) {
            invoicesData = await response.json();
            filteredInvoices = [...invoicesData];
            updateStatistics();
            filterInvoices();
            } else {
            console.error('Failed to load invoices');
        }
    } catch (error) {
        console.error('Error loading invoices:', error);
    }
}

// Update statistics
function updateStatistics() {
    const totalInvoices = invoicesData.length;
    const paidInvoices = invoicesData.filter(i => i.trang_thai === 'Đã thanh toán').length;
    const pendingInvoices = invoicesData.filter(i => i.trang_thai === 'Chưa thanh toán').length;
    const totalRevenue = invoicesData.reduce((sum, invoice) => sum + (invoice.tong_tien || 0), 0);
    
    document.getElementById('totalInvoices').textContent = totalInvoices;
    document.getElementById('paidInvoices').textContent = paidInvoices;
    document.getElementById('pendingInvoices').textContent = pendingInvoices;
    document.getElementById('totalRevenue').textContent = totalRevenue.toLocaleString() + ' VNĐ';
}

// Filter invoices
function filterInvoices() {
    const searchTerm = document.getElementById('searchInvoice').value.toLowerCase();
    const customerSearch = document.getElementById('customerSearch').value.toLowerCase();
    const fromDate = document.getElementById('fromDate').value;
    const toDate = document.getElementById('toDate').value;
    const typeFilter = '';
    
    console.log('Filtering invoices with customer search:', customerSearch);
    console.log('Available invoices:', invoicesData);
    
    filteredInvoices = invoicesData.filter(invoice => {
        const matchesSearch = !searchTerm || 
                             (invoice.so_hd && invoice.so_hd.toLowerCase().includes(searchTerm)) ||
                             (invoice.nguoi_mua && invoice.nguoi_mua.toLowerCase().includes(searchTerm));
        
        const matchesCustomer = !customerSearch || 
                               (invoice.nguoi_mua && invoice.nguoi_mua.toLowerCase().includes(customerSearch));
        
        const invoiceDate = invoice.ngay_hd;
        const matchesFromDate = !fromDate || !invoiceDate || invoiceDate >= fromDate;
        const matchesToDate = !toDate || !invoiceDate || invoiceDate <= toDate;
        
        const matchesTypeFilter = true; // no type filter
        
        const matchesTabStatus = currentStatus === 'all' || invoice.trang_thai === currentStatus;
        
        return matchesSearch && matchesCustomer && matchesFromDate && matchesToDate && matchesTypeFilter && matchesTabStatus;
    });
    
    console.log('Filtered invoices result:', filteredInvoices);
    
    currentPage = 1;
    updateInvoicesTable();
    updatePagination();
}

// Clear filters
function clearFilters() {
    document.getElementById('searchInvoice').value = '';
    document.getElementById('customerSearch').value = '';
    document.getElementById('fromDate').value = '';
    document.getElementById('toDate').value = '';
    document.getElementById('typeFilter').value = '';
    
    // Reset to all tab
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelector('.tab[data-status="all"]').classList.add('active');
    currentStatus = 'all';
    
    filteredInvoices = [...invoicesData];
    currentPage = 1;
    updateInvoicesTable();
    updatePagination();
}

// Update invoices table
function updateInvoicesTable() {
    const tbody = document.getElementById('invoicesTableBody');
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageInvoices = filteredInvoices.slice(startIndex, endIndex);
    
    tbody.innerHTML = pageInvoices.map((invoice, index) => `
        <tr>
            <td>${startIndex + index + 1}</td>
            <td><strong>${invoice.so_hd || '-'}</strong></td>
            <td>${invoice.ngay_hd || '-'}</td>
            <td>${invoice.nguoi_mua || '-'}</td>
            
            <td>${(invoice.tong_tien || 0).toLocaleString()} VNĐ</td>
            <td>${getStatusBadge(invoice.trang_thai)}</td>
            <td>
                <div class="table-actions">
                    <button class="btn btn-sm btn-primary" onclick="viewInvoiceDetails(${invoice.id})">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-info" onclick="editInvoice(${invoice.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteInvoice(${invoice.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

// Update pagination
function updatePagination() {
    const totalPages = Math.ceil(filteredInvoices.length / itemsPerPage);
    const pagination = document.getElementById('pagination');
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
    return; 
  }

    let paginationHTML = '';
    
    // Previous button
    paginationHTML += `
        <button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">
            <i class="fas fa-chevron-left"></i>
        </button>
    `;
    
    // Page numbers
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        paginationHTML += `<button class="pagination-btn" onclick="goToPage(1)">1</button>`;
        if (startPage > 2) {
            paginationHTML += `<span class="text-gray-500">...</span>`;
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
            <button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">
                ${i}
            </button>
        `;
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            paginationHTML += `<span class="text-gray-500">...</span>`;
        }
        paginationHTML += `<button class="pagination-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
    }
    
    // Next button
    paginationHTML += `
        <button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">
            <i class="fas fa-chevron-right"></i>
        </button>
    `;
    
    pagination.innerHTML = paginationHTML;
}

// Go to page
function goToPage(page) {
    const totalPages = Math.ceil(filteredInvoices.length / itemsPerPage);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        updateInvoicesTable();
        updatePagination();
    }
}

// Modal functions
async function openAddInvoiceModal() {
    const modal = document.getElementById('addInvoiceModal');
    const form = document.getElementById('addInvoiceForm');
    
    modal.style.display = 'flex';
    form.reset();
    document.getElementById('add_tong_tien_display').value = '';
    document.getElementById('add_tong_tien').value = '';
    document.getElementById('selectedCustomerId').value = '';
    document.getElementById('selectedOrderId').value = '';
    document.getElementById('addOrderCode').value = '';
    
    // Auto-generate invoice number
    try {
        const nextNumberResponse = await fetch('{{ BACKEND_URL }}/api/invoices/next-number', {
            headers: {
                'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`
            }
        });
        if (nextNumberResponse.ok) {
            const nextNumberData = await nextNumberResponse.json();
            const invoiceNumberInput = form.querySelector('input[name="so_hoa_don"]');
            if (invoiceNumberInput && nextNumberData.full_invoice_number) {
                invoiceNumberInput.value = nextNumberData.full_invoice_number;
            }
        }
    } catch (error) {
        console.warn('Could not get next invoice number:', error);
        // Fallback: generate manually
        const today = new Date();
        const dd = String(today.getDate()).padStart(2, '0');
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const yy = String(today.getFullYear()).slice(-2);
        const dateStr = dd + mm + yy;
        const invoiceNumberInput = form.querySelector('input[name="so_hoa_don"]');
        if (invoiceNumberInput) {
            invoiceNumberInput.value = `HĐ-${dateStr}-001`;
        }
    }
    
    // Set today's date as default
    const todayInput = form.querySelector('input[name="ngay_tao"]');
    if (todayInput) {
        const today = new Date();
        todayInput.value = today.toISOString().split('T')[0];
    }
    
    // Setup add customer dropdown events when modal opens
    setTimeout(() => {
        setupAddCustomerDropdownEvents();
        populateAddCustomerList();
    }, 100);
    
    // Store initial state
    storeModalState('addInvoiceModal', form);
}

function closeAddInvoiceModal() {
    document.getElementById('addInvoiceModal').style.display = 'none';
    clearModalState('addInvoiceModal');
    loadInvoicesData();
    showSuccessMessage('Thêm thành công!');
}

function editInvoice(id) {
    const invoice = invoicesData.find(i => i.id === id);
    if (invoice) {
        const form = document.getElementById('editInvoiceForm');
        form.querySelector('input[name="id"]').value = invoice.id;
        form.querySelector('input[name="so_hoa_don"]').value = invoice.so_hd || '';
        
        // Set date
        if (invoice.ngay_hd) {
            form.querySelector('input[name="ngay_tao"]').value = invoice.ngay_hd;
        }
        
        // Set customer name (readonly)
        form.querySelector('input[name="ten_khach_hang"]').value = invoice.nguoi_mua || '';
        
        // Set status
        form.querySelector('select[name="trang_thai"]').value = invoice.trang_thai || '';
        
        // Set total amount
        const tongTien = invoice.tong_tien || 0;
        document.getElementById('edit_tong_tien').value = tongTien;
        document.getElementById('edit_tong_tien_display').value = tongTien.toLocaleString();
        
        // Set payment method if available
        if (invoice.hinh_thuc_tt) {
            const hinhThucTTSelect = form.querySelector('select[name="hinh_thuc_tt"]');
            if (hinhThucTTSelect) {
                hinhThucTTSelect.value = invoice.hinh_thuc_tt;
            }
        }
        
        // Store initial state for edit modal
        storeModalState('editInvoiceModal', form);
        
        document.getElementById('editInvoiceModal').style.display = 'flex';
    }
}

function closeEditInvoiceModal() {
    closeModalWithConfirmation('editInvoiceModal');
}

async function createInvoice() {
    const form = document.getElementById('addInvoiceForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    // Map form fields to backend API fields
    const payload = {
        so_hd: data.so_hoa_don,
        ngay_hd: data.ngay_tao,
        nguoi_mua: data.ten_khach_hang,
        tong_tien: parseInt(document.getElementById('add_tong_tien').value || '0'),
        trang_thai: data.trang_thai,
        hinh_thuc_tt: data.hinh_thuc_tt || null
    };
    
    try {
        const response = await fetch('{{ BACKEND_URL }}/api/invoices/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`
            },
            body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        if (result.success) {
            document.getElementById('addInvoiceModal').style.display = 'none';
            clearModalState('addInvoiceModal');
            loadInvoicesData();
            showSuccessMessage('Tạo hóa đơn thành công!');
      } else {
            showErrorMessage(result.message || 'Có lỗi xảy ra khi tạo hóa đơn');
        }
    } catch (error) {
        showErrorMessage('Có lỗi xảy ra khi tạo hóa đơn');
    }
}

async function updateInvoice() {
    const form = document.getElementById('editInvoiceForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    const id = data.id;
    
    // Map form fields to backend API fields
    const payload = {
        so_hd: data.so_hoa_don,
        ngay_hd: data.ngay_tao,
        nguoi_mua: data.ten_khach_hang,
        tong_tien: parseInt(document.getElementById('edit_tong_tien').value || '0'),
        trang_thai: data.trang_thai,
        hinh_thuc_tt: data.hinh_thuc_tt || null
    };
    
    try {
        const response = await fetch(`{{ BACKEND_URL }}/api/invoices/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`
            },
            body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        if (result.success) {
            document.getElementById('editInvoiceModal').style.display = 'none';
            clearModalState('editInvoiceModal');
            loadInvoicesData();
            showSuccessMessage('Cập nhật thành công!');
  } else {
            showErrorMessage(result.message || 'Có lỗi xảy ra khi cập nhật hóa đơn');
        }
    } catch (error) {
        showErrorMessage('Có lỗi xảy ra khi cập nhật hóa đơn');
    }
}

function deleteInvoice(id) {
    deleteInvoiceId = id;
    document.getElementById('deleteInvoiceModal').style.display = 'flex';
}

function closeDeleteInvoiceModal() {
    document.getElementById('deleteInvoiceModal').style.display = 'none';
    deleteInvoiceId = null;
}

async function confirmDeleteInvoice() {
    if (!deleteInvoiceId) return;
    
    try {
        const response = await fetch(`{{ BACKEND_URL }}/api/invoices/${deleteInvoiceId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`
            }
        });
        
        const result = await response.json();
        if (result.success) {
        closeDeleteInvoiceModal();
            loadInvoicesData();
            showSuccessMessage('Xóa hóa đơn thành công!');
      } else {
            showErrorMessage(result.message || 'Có lỗi xảy ra khi xóa hóa đơn');
        }
    } catch (error) {
        showErrorMessage('Có lỗi xảy ra khi xóa hóa đơn');
    }
}

// Utility functions - đã được định nghĩa trong utils.js
// Các hàm formatMoneyTyping, debounce, showSuccessMessage, showErrorMessage đã có trong utils.js

// View invoice details
async function viewInvoiceDetails(invoiceId) {
    const modal = document.getElementById('viewInvoiceDetailsModal');
    const content = document.getElementById('invoiceDetailsContent');
    
    modal.style.display = 'flex';
    
    // Show loading
    content.innerHTML = `
        <div style="text-align: center; padding: var(--spacing-6);">
            <i class="fas fa-spinner fa-spin" style="font-size: 2em; color: var(--primary-color);"></i>
            <p style="margin-top: var(--spacing-2);">Đang tải chi tiết hóa đơn...</p>
        </div>
    `;
    
    try {
        const response = await fetch(`{{ BACKEND_URL }}/api/invoices/${invoiceId}/details`, {
            headers: {
                'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            const invoice = data.invoice;
            const items = data.items || [];
            
            let itemsHTML = '';
            if (items.length === 0) {
                itemsHTML = '<tr><td colspan="6" style="text-align: center; padding: var(--spacing-4); color: var(--gray-500);">Không có sản phẩm nào trong hóa đơn này</td></tr>';
            } else {
                itemsHTML = items.map((item, index) => `
                    <tr>
                        <td>${index + 1}</td>
                        <td><strong>${item.product_code || '-'}</strong></td>
                        <td>${item.product_name || '-'}</td>
                        <td>${item.so_luong || 0}</td>
                        <td>${(item.don_gia || 0).toLocaleString()} VNĐ</td>
                        <td style="font-weight: 600; color: var(--primary-color);">${(item.total_price || 0).toLocaleString()} VNĐ</td>
                    </tr>
                `).join('');
            }
            
            content.innerHTML = `
                <div class="invoice-details-container">
                    <div class="invoice-header-info" style="background: var(--gray-50); padding: var(--spacing-4); border-radius: var(--radius-md); margin-bottom: var(--spacing-4);">
                        <div class="invoice-info-row" style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-2);">
                            <div>
                                <span style="font-weight: 600; color: var(--gray-700);">Số hóa đơn:</span>
                                <span style="font-weight: 700; color: var(--primary-color); font-size: 1.1em; margin-left: var(--spacing-2);">${invoice.so_hd || '-'}</span>
                            </div>
                            <div>
                                <span style="font-weight: 600; color: var(--gray-700);">Ngày:</span>
                                <span style="margin-left: var(--spacing-2);">${invoice.ngay_hd || '-'}</span>
                            </div>
                        </div>
                        <div class="invoice-info-row" style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-2);">
                            <div>
                                <span style="font-weight: 600; color: var(--gray-700);">Khách hàng:</span>
                                <span style="margin-left: var(--spacing-2);">${invoice.nguoi_mua || '-'}</span>
                            </div>
                            <div>
                                <span style="font-weight: 600; color: var(--gray-700);">Trạng thái:</span>
                                <span style="margin-left: var(--spacing-2);">${getStatusBadge(invoice.trang_thai)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <h4 style="margin-bottom: var(--spacing-3); color: var(--gray-900);">
                        <i class="fas fa-boxes"></i> Danh sách sản phẩm
                    </h4>
                    
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>Mã SP</th>
                                    <th>Tên sản phẩm</th>
                                    <th>Số lượng</th>
                                    <th>Đơn giá</th>
                                    <th>Thành tiền</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHTML}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="invoice-total-section" style="margin-top: var(--spacing-4); padding-top: var(--spacing-4); border-top: 2px solid var(--gray-300);">
                        <div style="display: flex; justify-content: flex-end;">
                            <div style="text-align: right;">
                                <div style="font-size: 1.2em; font-weight: 700; color: var(--primary-color);">
                                    Tổng tiền: ${(invoice.tong_tien || 0).toLocaleString()} VNĐ
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } else {
            const error = await response.json();
            content.innerHTML = `
                <div style="text-align: center; padding: var(--spacing-6);">
                    <i class="fas fa-exclamation-triangle" style="font-size: 2em; color: var(--danger-color);"></i>
                    <p style="margin-top: var(--spacing-2); color: var(--danger-color);">${error.detail || 'Không thể tải chi tiết hóa đơn'}</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading invoice details:', error);
        content.innerHTML = `
            <div style="text-align: center; padding: var(--spacing-6);">
                <i class="fas fa-exclamation-triangle" style="font-size: 2em; color: var(--danger-color);"></i>
                <p style="margin-top: var(--spacing-2); color: var(--danger-color);">Đã xảy ra lỗi khi tải chi tiết hóa đơn</p>
            </div>
        `;
    }
}

function closeViewInvoiceDetailsModal() {
    document.getElementById('viewInvoiceDetailsModal').style.display = 'none';
}

// Order search functionality
let ordersData = [];

// Show order dropdown
async function showOrderDropdown() {
    const customerId = document.getElementById('selectedCustomerId').value;
    const customerName = document.getElementById('addCustomerName').value;
    
    if (!customerId && !customerName) {
        showErrorMessage('Vui lòng chọn khách hàng trước');
        return;
    }
    
    const dropdown = document.getElementById('addOrderDropdownList');
    if (!dropdown) return;
    
    // Show loading
    dropdown.innerHTML = '<div class="customer-dropdown-item"><small>Đang tải...</small></div>';
    dropdown.style.display = 'block';
    
    try {
        // Find customer ID if we only have name
        let searchCustomerId = customerId;
        let searchCustomerName = customerName;
        
        if (!searchCustomerId && customerName) {
            const customer = customersData.find(c => c.ten_tk === customerName);
            if (customer) {
                searchCustomerId = customer.id;
                searchCustomerName = customer.ten_tk;
            }
        } else if (searchCustomerId && !searchCustomerName) {
            // If we have ID but not name, find name from customersData
            const customer = customersData.find(c => c.id == searchCustomerId);
            if (customer) {
                searchCustomerName = customer.ten_tk;
            }
        }
        
        // Build query parameters
        const params = new URLSearchParams();
        if (searchCustomerId) {
            params.append('customer_id', searchCustomerId);
        }
        if (searchCustomerName && searchCustomerName !== 'Khách vãng lai') {
            params.append('customer_name', searchCustomerName);
        }
        
        // Fetch orders for this customer
        const url = `{{ BACKEND_URL }}/api/orders/search?${params.toString()}`;
        console.log('Fetching orders from:', url);
        
        const response = await fetch(url, {
            headers: {
                'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`
            }
        });
        
        if (response.ok) {
            ordersData = await response.json();
            console.log('Loaded orders:', ordersData);
            populateOrderDropdown(ordersData);
        } else {
            const errorText = await response.text();
            console.error('Error response:', errorText);
            dropdown.innerHTML = '<div class="customer-dropdown-item"><small style="color: var(--danger-color);">Không thể tải danh sách đơn hàng</small></div>';
        }
    } catch (error) {
        console.error('Error loading orders:', error);
        dropdown.innerHTML = '<div class="customer-dropdown-item"><small style="color: var(--danger-color);">Đã xảy ra lỗi khi tải đơn hàng: ' + error.message + '</small></div>';
    }
}

// Populate order dropdown
function populateOrderDropdown(orders) {
    const dropdown = document.getElementById('addOrderDropdownList');
    if (!dropdown) return;
    
    dropdown.innerHTML = '';
    
    if (orders.length === 0) {
        const noResult = document.createElement('div');
        noResult.className = 'customer-dropdown-item';
        noResult.innerHTML = '<small style="color: var(--gray-500);">Không có đơn hàng nào</small>';
        dropdown.appendChild(noResult);
        return;
    }
    
    orders.forEach(order => {
        const item = document.createElement('div');
        item.className = 'customer-dropdown-item';
        item.dataset.orderId = order.id;
        item.dataset.orderCode = order.ma_don_hang;
        
        // Lấy tổng tiền từ order, đảm bảo là số
        const orderTotal = parseFloat(order.tong_tien) || 0;
        item.dataset.totalAmount = orderTotal;
        
        let displayText = `<strong>${order.ma_don_hang}</strong>`;
        if (orderTotal > 0) {
            displayText += `<small>Tổng tiền: ${orderTotal.toLocaleString()} VNĐ</small>`;
        } else {
            displayText += `<small style="color: var(--gray-500);">Chưa có tổng tiền</small>`;
        }
        
        item.innerHTML = displayText;
        item.onclick = function() {
            // Truyền cả order object và totalAmount để đảm bảo có đủ thông tin
            selectOrder(order.ma_don_hang, orderTotal);
        };
        
        dropdown.appendChild(item);
    });
}

// Select order
function selectOrder(orderCode, totalAmount) {
    const orderInput = document.getElementById('addOrderCode');
    const order = ordersData.find(o => o.ma_don_hang === orderCode);
    
    if (orderInput) {
        orderInput.value = orderCode;
    }
    
    if (order) {
        document.getElementById('selectedOrderId').value = order.id;
        
        // Auto-fill total amount - ưu tiên tong_tien từ order object
        let finalAmount = totalAmount || 0;
        if (order.tong_tien && order.tong_tien > 0) {
            finalAmount = order.tong_tien;
        } else if (finalAmount <= 0 && order.tong_tien !== undefined) {
            finalAmount = order.tong_tien || 0;
        }
        
        // Điền tổng tiền vào form
        if (finalAmount > 0) {
            document.getElementById('add_tong_tien').value = finalAmount;
            document.getElementById('add_tong_tien_display').value = finalAmount.toLocaleString();
        } else {
            // Nếu không có tổng tiền, đặt về 0
            document.getElementById('add_tong_tien').value = 0;
            document.getElementById('add_tong_tien_display').value = '0';
        }
    } else {
        // Nếu không tìm thấy order trong ordersData, vẫn điền tổng tiền từ tham số
        if (totalAmount > 0) {
            document.getElementById('add_tong_tien').value = totalAmount;
            document.getElementById('add_tong_tien_display').value = totalAmount.toLocaleString();
        }
    }
    
    // Close dropdown
    const dropdown = document.getElementById('addOrderDropdownList');
    if (dropdown) {
        dropdown.style.display = 'none';
    }
}

// Toggle order dropdown
function toggleOrderDropdown() {
    const dropdown = document.getElementById('addOrderDropdownList');
    if (dropdown) {
        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
    }
}

// Close order dropdown when clicking outside
document.addEventListener('DOMContentLoaded', function() {
    document.addEventListener('click', function(e) {
        const orderInput = document.getElementById('addOrderCode');
        const orderDropdown = document.getElementById('addOrderDropdownList');
        
        if (orderInput && orderDropdown) {
            if (!orderInput.contains(e.target) && !orderDropdown.contains(e.target)) {
                orderDropdown.style.display = 'none';
            }
        }
    });
});
</script>
{% endblock %}