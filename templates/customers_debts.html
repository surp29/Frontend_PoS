{% extends "base.html" %}

{% block title %}Công nợ khách hàng - PhanMemKeToan{% endblock %}

{% block page_title %}
<i class="fas fa-hand-holding-dollar"></i> Công nợ khách hàng
{% endblock %}

{% block page_description %}
Quan sát công nợ theo khách hàng dựa trên đơn hàng và thanh toán
{% endblock %}

{% block content %}
<!-- Statistics Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-users"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="totalDebtCustomers">0</div>
            <div class="stat-label">Khách hàng có công nợ</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-money-bill-wave"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="totalDebtAmount">0 VNĐ</div>
            <div class="stat-label">Tổng công nợ</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-file-invoice"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="totalUnpaidInvoices">0</div>
            <div class="stat-label">Hóa đơn chưa thanh toán</div>
        </div>
    </div>
    
</div>

<div class="table-container">
    <div class="card">
        <div class="card-header">
            <h3>Công nợ khách hàng</h3>
        </div>
        <div class="card-body p-0">
            <table class="table" id="debtsTable">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Tên khách hàng</th>
                        <th>Mã KH</th>
                        <th>Số hóa đơn</th>
                        <th>Công nợ</th>
                    </tr>
                </thead>
                <tbody id="debtsTableBody">
                    <tr><td colspan="5" style="text-align:center; padding: var(--spacing-4); color: var(--gray-600);">Đang tải...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Pagination -->
<div class="pagination" id="debtsPagination">
    <!-- Pagination will be generated here -->
</div>
{% endblock %}

{% block extra_js %}
<script>
let debtsData = [];
let filteredDebts = [];
let currentPage = 1;
const itemsPerPage = 20; // Popup modal: 20 items per page

document.addEventListener('DOMContentLoaded', function() {
    loadDebtsData();
});

async function loadDebtsData() {
    try {
        const response = await fetch('{{ BACKEND_URL }}/api/customers-analytics/debts', {
            headers: {
                'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`
            }
        });
        if (response.ok) {
            const data = await response.json();
            debtsData = Array.isArray(data) ? data : [];
            filteredDebts = [...debtsData];
            updateStatistics();
            updateDebtsTable();
            updateDebtsPagination();
        } else {
            document.getElementById('debtsTableBody').innerHTML = '<tr><td colspan="5" style="text-align:center; padding: var(--spacing-4); color: var(--gray-600);">Không thể tải dữ liệu</td></tr>';
        }
    } catch (e) {
        console.error('Error loading debts:', e);
        document.getElementById('debtsTableBody').innerHTML = '<tr><td colspan="5" style="text-align:center; padding: var(--spacing-4); color: var(--gray-600);">Có lỗi xảy ra</td></tr>';
    }
}

function updateStatistics() {
    const totalDebtCustomers = debtsData.length;
    const totalDebtAmount = debtsData.reduce((sum, d) => sum + (d.totalDebt || 0), 0);
    const totalUnpaidInvoices = debtsData.reduce((sum, d) => sum + (d.invoiceCount || 0), 0);
    
    document.getElementById('totalDebtCustomers').textContent = totalDebtCustomers;
    document.getElementById('totalDebtAmount').textContent = totalDebtAmount.toLocaleString('vi-VN') + ' VNĐ';
    document.getElementById('totalUnpaidInvoices').textContent = totalUnpaidInvoices;
}

function updateDebtsTable() {
    const tbody = document.getElementById('debtsTableBody');
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageDebts = filteredDebts.slice(startIndex, endIndex);
    
    if (pageDebts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: var(--spacing-4); color: var(--gray-600);">Chưa có công nợ</td></tr>';
        return;
    }
    
    tbody.innerHTML = pageDebts.map((d, index) => {
        return `
            <tr>
                <td>${startIndex + index + 1}</td>
                <td><strong>${d.customerName || '-'}</strong></td>
                <td>${d.customerCode || '-'}</td>
                <td>${d.invoiceCount || 0}</td>
                <td><strong style="color: var(--danger-color);">${(d.totalDebt || 0).toLocaleString('vi-VN')} VNĐ</strong></td>
            </tr>
        `;
    }).join('');
}

function updateDebtsPagination() {
    const totalPages = Math.ceil(filteredDebts.length / itemsPerPage);
    const pagination = document.getElementById('debtsPagination');
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    pagination.innerHTML = generatePaginationHTML(currentPage, totalPages);
}

function goToPage(page) {
    const totalPages = Math.ceil(filteredDebts.length / itemsPerPage);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        updateDebtsTable();
        updateDebtsPagination();
    }
}

// Make goToPage available globally
window.goToPage = goToPage;
</script>
{% endblock %}



