{% extends "base.html" %}

{% block title %}Quản lý kho hàng - PhanMemKeToan{% endblock %}

{% block page_title %}
<i class="fas fa-warehouse"></i> Quản lý kho hàng
{% endblock %}

{% block page_description %}
Quản lý và theo dõi tồn kho, kiểm soát số lượng sản phẩm trong kho
{% endblock %}

{% block content %}
<!-- Statistics Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-warehouse"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="totalWarehouses">0</div>
            <div class="stat-label">Tổng kho</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-boxes"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="totalProducts">0</div>
            <div class="stat-label">Tổng sản phẩm</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="inStockProducts">0</div>
            <div class="stat-label">Còn hàng</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="outOfStockProducts">0</div>
            <div class="stat-label">Hết hàng</div>
        </div>
    </div>
</div>

<!-- Filter Bar -->
<div class="filter-bar">
    <div class="filter-row">
        <div class="form-group">
            <label class="form-label">Tìm kiếm</label>
            <div class="search-input">
                <i class="fas fa-search"></i>
                <input type="text" class="form-input" id="searchWarehouse" placeholder="Tìm theo mã kho, tên kho, sản phẩm...">
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Mã kho</label>
            <select class="form-select" id="warehouseCodeFilter">
                <option value="">Tất cả mã kho</option>
    </select>
  </div>
        
        <div class="form-group">
            <label class="form-label">Tên kho</label>
            <select class="form-select" id="warehouseNameFilter">
                <option value="">Tất cả tên kho</option>
    </select>
  </div>
        
        <div class="form-group">
            <label class="form-label">Nhóm sản phẩm</label>
            <select class="form-select" id="groupFilter">
      <option value="">Tất cả nhóm</option>
    </select>
  </div>
        
        <div class="form-group">
            <label class="form-label">Trạng thái</label>
            <select class="form-select" id="statusFilter">
                <option value="">Tất cả trạng thái</option>
      <option value="Còn hàng">Còn hàng</option>
      <option value="Hết hàng">Hết hàng</option>
    </select>
</div>

        <div class="form-group">
            <button class="btn btn-secondary" onclick="clearFilters()">
                <i class="fas fa-times"></i>
                Xóa bộ lọc
  </button>
    </div>
  </div>
</div>

<!-- Warehouse Table -->
<div class="table-container">
    <div class="card">
        <div class="card-header">
            <h3>Danh sách kho hàng</h3>
        </div>
        <div class="card-body p-0">
            <table class="table" id="warehouseTable">
  <thead>
    <tr>
                        <th>STT</th>
                        <th>Mã kho</th>
                        <th>Tên kho</th>
                        <th>Nhóm SP</th>
                        <th>Mã SP</th>
                        <th>Tên SP</th>
                        <th>Số lượng</th>
                        <th>Giá nhập</th>
                        <th>Giá bán</th>
                        <th>Trạng thái</th>
                        <th>Thao tác</th>
    </tr>
  </thead>
                <tbody id="warehouseTableBody">
                    <!-- Data will be loaded here -->
  </tbody>
</table>
    </div>
    </div>
</div>

<!-- Pagination -->
<div class="pagination" id="pagination">
    <!-- Pagination will be generated here -->
</div>

<!-- Edit Warehouse Modal -->
<div class="modal-overlay" id="editWarehouseModal" style="display: none;">
<div class="modal modal-horizontal">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Chỉnh sửa kho hàng</h3>
            <button class="modal-close" onclick="closeEditWarehouseModal()">
                <i class="fas fa-times"></i>
            </button>
</div>
        <div class="modal-body">
            <form id="editWarehouseForm">
                <input type="hidden" name="id">
                
      <div class="form-row">
        <div class="form-group">
                        <label class="form-label">Mã kho</label>
                        <input type="text" class="form-input" name="ma_kho" readonly>
        </div>
        <div class="form-group">
                        <label class="form-label">Tên kho</label>
                        <input type="text" class="form-input" name="ten_kho" readonly>
        </div>
      </div>
                
      <div class="form-row">
        <div class="form-group">
                        <label class="form-label">Nhóm sản phẩm</label>
                        <input type="text" class="form-input" name="nhom_san_pham" readonly>
        </div>
        <div class="form-group">
                        <label class="form-label">Mã sản phẩm</label>
                        <input type="text" class="form-input" name="ma_sp" readonly>
        </div>
      </div>
                
                <div class="form-group">
                    <label class="form-label">Tên sản phẩm</label>
                    <input type="text" class="form-input" name="ten_sp" readonly>
                </div>
                
      <div class="form-row">
        <div class="form-group">
                        <label class="form-label">Số lượng *</label>
                        <input type="number" class="form-input" name="so_luong" min="0" required>
        </div>
        <div class="form-group">
                        <label class="form-label">Trạng thái</label>
                        <select class="form-select" name="trang_thai">
                            <option value="Còn hàng">Còn hàng</option>
                            <option value="Hết hàng">Hết hàng</option>
                        </select>
        </div>
      </div>
                
      <div class="form-row">
        <div class="form-group">
                        <label class="form-label">Giá nhập</label>
                        <div class="money-input-container">
                            <input type="text" id="edit_gia_nhap_display" class="form-input" oninput="formatMoneyTyping(this, document.getElementById('edit_gia_nhap'))">
                            <input type="hidden" name="gia_nhap" id="edit_gia_nhap">
                            <span class="currency-unit">VNĐ</span>
        </div>
      </div>
      <div class="form-group">
                        <label class="form-label">Giá bán</label>
                        <div class="money-input-container">
                            <input type="text" id="edit_gia_ban_display" class="form-input" oninput="formatMoneyTyping(this, document.getElementById('edit_gia_ban'))">
                            <input type="hidden" name="gia_ban" id="edit_gia_ban">
                            <span class="currency-unit">VNĐ</span>
      </div>
  </div>
</div>

                <div class="form-group">
                    <label class="form-label">Ghi chú</label>
                    <textarea class="form-textarea" name="ghi_chu" rows="3" placeholder="Nhập ghi chú"></textarea>
    </div>
            </form>
    </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeEditWarehouseModal()">Hủy</button>
            <button type="button" class="btn btn-primary" onclick="updateWarehouse()">Cập nhật</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--spacing-4);
    margin-bottom: var(--spacing-6);
}

.stat-card {
    background: white;
    border-radius: var(--radius-lg);
    padding: var(--spacing-6);
    box-shadow: var(--shadow-md);
    border: 1px solid var(--gray-200);
    display: flex;
    align-items: center;
    transition: all var(--transition-normal);
}

.stat-card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-2px);
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: var(--radius-lg);
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: var(--spacing-4);
}

.stat-icon i {
    font-size: var(--font-size-xl);
    color: white;
}

.stat-content {
    flex: 1;
}

.stat-number {
    font-size: var(--font-size-2xl);
    font-weight: 700;
    color: var(--gray-900);
    margin-bottom: var(--spacing-1);
}

.stat-label {
    font-size: var(--font-size-sm);
    color: var(--gray-600);
    font-weight: 500;
}

.money-input-container {
    display: flex;
    align-items: center;
    gap: var(--spacing-2);
}

.money-input-container .form-input {
    flex: 1;
}

.currency-unit {
    font-weight: 600;
    color: var(--gray-600);
    font-size: var(--font-size-sm);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let warehouseData = [];
let filteredWarehouse = [];
let currentPage = 1;
const itemsPerPage = 10;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadWarehouseData();
    setupEventListeners();
});

// Setup event listeners
function setupEventListeners() {
    // Filter inputs
    document.getElementById('searchWarehouse').addEventListener('input', debounce(filterWarehouse, 300));
    document.getElementById('warehouseCodeFilter').addEventListener('change', filterWarehouse);
    document.getElementById('warehouseNameFilter').addEventListener('change', filterWarehouse);
    document.getElementById('groupFilter').addEventListener('change', filterWarehouse);
    document.getElementById('statusFilter').addEventListener('change', filterWarehouse);
}

// Load warehouse data
async function loadWarehouseData() {
    try {
        const response = await fetch('{{ BACKEND_URL }}/api/warehouse/');
        if (response.ok) {
            warehouseData = await response.json();
            filteredWarehouse = [...warehouseData];
            updateStatistics();
            updateFilterOptions();
            updateWarehouseTable();
            updatePagination();
            } else {
            console.error('Failed to load warehouse data');
        }
    } catch (error) {
        console.error('Error loading warehouse data:', error);
    }
}

// Update statistics
function updateStatistics() {
    const totalWarehouses = new Set(warehouseData.map(w => w.ma_kho)).size;
    const totalProducts = warehouseData.length;
    const inStockProducts = warehouseData.filter(w => w.trang_thai === 'Còn hàng').length;
    const outOfStockProducts = warehouseData.filter(w => w.trang_thai === 'Hết hàng').length;
    
    document.getElementById('totalWarehouses').textContent = totalWarehouses;
    document.getElementById('totalProducts').textContent = totalProducts;
    document.getElementById('inStockProducts').textContent = inStockProducts;
    document.getElementById('outOfStockProducts').textContent = outOfStockProducts;
}

// Update filter options
function updateFilterOptions() {
    // Warehouse codes
    const warehouseCodes = [...new Set(warehouseData.map(w => w.ma_kho))];
    const codeSelect = document.getElementById('warehouseCodeFilter');
    codeSelect.innerHTML = '<option value="">Tất cả mã kho</option>';
    warehouseCodes.forEach(code => {
        const option = document.createElement('option');
        option.value = code;
        option.textContent = code;
        codeSelect.appendChild(option);
    });
    
    // Warehouse names
    const warehouseNames = [...new Set(warehouseData.map(w => w.ten_kho))];
    const nameSelect = document.getElementById('warehouseNameFilter');
    nameSelect.innerHTML = '<option value="">Tất cả tên kho</option>';
    warehouseNames.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        nameSelect.appendChild(option);
    });
    
    // Product groups
    const groups = [...new Set(warehouseData.map(w => w.nhom_san_pham).filter(Boolean))];
    const groupSelect = document.getElementById('groupFilter');
    groupSelect.innerHTML = '<option value="">Tất cả nhóm</option>';
    groups.forEach(group => {
        const option = document.createElement('option');
        option.value = group;
        option.textContent = group;
        groupSelect.appendChild(option);
    });
}

// Filter warehouse
function filterWarehouse() {
    const searchTerm = document.getElementById('searchWarehouse').value.toLowerCase();
    const codeFilter = document.getElementById('warehouseCodeFilter').value;
    const nameFilter = document.getElementById('warehouseNameFilter').value;
    const groupFilter = document.getElementById('groupFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    
    filteredWarehouse = warehouseData.filter(item => {
        const matchesSearch = !searchTerm || 
                             (item.ma_kho && item.ma_kho.toLowerCase().includes(searchTerm)) ||
                             (item.ten_kho && item.ten_kho.toLowerCase().includes(searchTerm)) ||
                             (item.ma_sp && item.ma_sp.toLowerCase().includes(searchTerm)) ||
                             (item.ten_sp && item.ten_sp.toLowerCase().includes(searchTerm));
        
        const matchesCode = !codeFilter || item.ma_kho === codeFilter;
        const matchesName = !nameFilter || item.ten_kho === nameFilter;
        const matchesGroup = !groupFilter || item.nhom_san_pham === groupFilter;
        const matchesStatus = !statusFilter || item.trang_thai === statusFilter;
        
        return matchesSearch && matchesCode && matchesName && matchesGroup && matchesStatus;
    });
    
    currentPage = 1;
    updateWarehouseTable();
    updatePagination();
}

// Clear filters
function clearFilters() {
    document.getElementById('searchWarehouse').value = '';
    document.getElementById('warehouseCodeFilter').value = '';
    document.getElementById('warehouseNameFilter').value = '';
    document.getElementById('groupFilter').value = '';
    document.getElementById('statusFilter').value = '';
    
    filteredWarehouse = [...warehouseData];
    currentPage = 1;
    updateWarehouseTable();
    updatePagination();
}

// Update warehouse table
function updateWarehouseTable() {
    const tbody = document.getElementById('warehouseTableBody');
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageItems = filteredWarehouse.slice(startIndex, endIndex);
    
    tbody.innerHTML = pageItems.map((item, index) => `
        <tr>
            <td>${startIndex + index + 1}</td>
            <td><strong>${item.ma_kho || '-'}</strong></td>
            <td>${item.ten_kho || '-'}</td>
            <td><span class="badge badge-info">${item.nhom_san_pham || '-'}</span></td>
            <td><strong>${item.ma_sp || '-'}</strong></td>
            <td>${item.ten_sp || '-'}</td>
            <td><span class="badge badge-secondary">${(item.so_luong || 0).toLocaleString()}</span></td>
            <td>${(item.gia_nhap || 0).toLocaleString()} VNĐ</td>
            <td>${(item.gia_ban || 0).toLocaleString()} VNĐ</td>
            <td>${getStatusBadge(item.trang_thai)}</td>
            <td>
                <div class="table-actions">
                    <button class="btn btn-sm btn-primary" onclick="editWarehouse(${item.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

// Update pagination
function updatePagination() {
    const totalPages = Math.ceil(filteredWarehouse.length / itemsPerPage);
    const pagination = document.getElementById('pagination');
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let paginationHTML = '';
    
    // Previous button
    paginationHTML += `
        <button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">
            <i class="fas fa-chevron-left"></i>
        </button>
    `;
    
    // Page numbers
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        paginationHTML += `<button class="pagination-btn" onclick="goToPage(1)">1</button>`;
        if (startPage > 2) {
            paginationHTML += `<span class="text-gray-500">...</span>`;
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
            <button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">
                ${i}
            </button>
        `;
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            paginationHTML += `<span class="text-gray-500">...</span>`;
        }
        paginationHTML += `<button class="pagination-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
    }
    
    // Next button
    paginationHTML += `
        <button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">
            <i class="fas fa-chevron-right"></i>
        </button>
    `;
    
    pagination.innerHTML = paginationHTML;
}

// Go to page
function goToPage(page) {
    const totalPages = Math.ceil(filteredWarehouse.length / itemsPerPage);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        updateWarehouseTable();
        updatePagination();
    }
}

// Modal functions
function editWarehouse(id) {
    const item = warehouseData.find(w => w.id === id);
    if (item) {
        const form = document.getElementById('editWarehouseForm');
        form.querySelector('input[name="id"]').value = item.id;
        form.querySelector('input[name="ma_kho"]').value = item.ma_kho || '';
        form.querySelector('input[name="ten_kho"]').value = item.ten_kho || '';
        form.querySelector('input[name="nhom_san_pham"]').value = item.nhom_san_pham || '';
        form.querySelector('input[name="ma_sp"]').value = item.ma_sp || '';
        form.querySelector('input[name="ten_sp"]').value = item.ten_sp || '';
        form.querySelector('input[name="so_luong"]').value = item.so_luong || 0;
        form.querySelector('select[name="trang_thai"]').value = item.trang_thai || '';
        form.querySelector('textarea[name="ghi_chu"]').value = item.ghi_chu || '';
        
        const giaNhap = item.gia_nhap || 0;
        const giaBan = item.gia_ban || 0;
        document.getElementById('edit_gia_nhap').value = giaNhap;
        document.getElementById('edit_gia_nhap_display').value = giaNhap.toLocaleString();
        document.getElementById('edit_gia_ban').value = giaBan;
        document.getElementById('edit_gia_ban_display').value = giaBan.toLocaleString();
        
        // Store initial state for edit modal
        storeModalState('editWarehouseModal', form);
        
        // Store initial state for edit modal
        storeModalState('editWarehouseModal', form);
        
        document.getElementById('editWarehouseModal').style.display = 'flex';
    }
}

function closeEditWarehouseModal() {
    closeModalWithConfirmation('editWarehouseModal');
}

async function updateWarehouse() {
    const form = document.getElementById('editWarehouseForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    const id = data.id;
    delete data.id;
    
    // Convert numeric fields
    data.so_luong = parseInt(data.so_luong || '0');
    data.gia_nhap = parseInt(document.getElementById('edit_gia_nhap').value || '0');
    data.gia_ban = parseInt(document.getElementById('edit_gia_ban').value || '0');
    
    // Update status based on quantity
    if (data.so_luong > 0) {
        data.trang_thai = 'Còn hàng';
    } else {
        data.trang_thai = 'Hết hàng';
    }
    
    try {
        const response = await fetch(`{{ BACKEND_URL }}/api/warehouse/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            document.getElementById('editWarehouseModal').style.display = 'none';
            clearModalState('editWarehouseModal');
            loadWarehouseData();
            showSuccessMessage('Cập nhật thành công!');
        } else {
            const error = await response.json();
            showErrorMessage(error.detail || 'Có lỗi xảy ra khi cập nhật kho hàng');
        }
    } catch (error) {
        showErrorMessage('Có lỗi xảy ra khi cập nhật kho hàng');
    }
}

// Utility functions
function getStatusBadge(status) {
    const badges = {
        'Còn hàng': '<span class="badge badge-success">Còn hàng</span>',
        'Hết hàng': '<span class="badge badge-danger">Hết hàng</span>'
    };
    return badges[status] || '<span class="badge badge-secondary">Không xác định</span>';
}

function formatMoneyTyping(sourceInput, hiddenInput) {
    const raw = (sourceInput.value || '').replace(/[^0-9]/g, '');
    if (!raw) {
        sourceInput.value = '';
        if (hiddenInput) hiddenInput.value = '';
    return;
  }
    if (hiddenInput) hiddenInput.value = raw;
    sourceInput.value = raw.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function showSuccessMessage(message) {
    showSuccessModal('Thành công', message);
}

function showErrorMessage(message) {
    showErrorModal('Lỗi', message);
}
</script>
{% endblock %}