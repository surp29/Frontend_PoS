{% extends "base.html" %}

{% block title %}Qu·∫£n l√Ω kho h√†ng - PhanMemKeToan{% endblock %}

{% block page_title %}
<i class="fas fa-warehouse"></i> Qu·∫£n l√Ω kho h√†ng
{% endblock %}

{% block page_description %}
T·∫°o v√† qu·∫£n l√Ω c√°c kho h√†ng, theo d√µi th√¥ng tin chi ti·∫øt t·ª´ng kho
{% endblock %}

{% block content %}
<!-- Statistics Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-warehouse"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="totalWarehouses">0</div>
            <div class="stat-label">T·ªïng kho</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-boxes"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="totalProducts">0</div>
            <div class="stat-label">T·ªïng s·∫£n ph·∫©m</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="inStockProducts">0</div>
            <div class="stat-label">C√≤n h√†ng</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="outOfStockProducts">0</div>
            <div class="stat-label">H·∫øt h√†ng</div>
        </div>
    </div>
</div>

<!-- Create Warehouse Form -->
<div class="card">
    <div class="card-header">
        <h3><i class="fas fa-plus-circle"></i> T·∫°o kho h√†ng m·ªõi</h3>
    </div>
    <div class="card-body">
        <form id="createWarehouseForm">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">M√£ kho *</label>
                    <input type="text" class="form-input" name="ma_kho" required placeholder="Nh·∫≠p m√£ kho">
                </div>
                <div class="form-group">
                    <label class="form-label">T√™n kho *</label>
                    <input type="text" class="form-input" name="ten_kho" required placeholder="Nh·∫≠p t√™n kho">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group form-half">
                    <label class="form-label">M√£ s·∫£n ph·∫©m *</label>
                    <input type="text" class="form-input" name="ma_sp" required placeholder="Nh·∫≠p m√£ s·∫£n ph·∫©m">
                </div>
                <div class="form-group form-half">
                    <div class="inline-fields">
                        <div class="form-group form-flex">
                            <label class="form-label">Gi√° nh·∫≠p</label>
                            <div class="money-input-container">
                                <input type="text" id="create_gia_nhap_display" class="form-input" placeholder="0" oninput="formatMoneyTyping(this, document.getElementById('create_gia_nhap'))">
                                <input type="hidden" name="gia_nhap" id="create_gia_nhap">
                                <span class="currency-unit">VNƒê</span>
                            </div>
                        </div>
                        <div class="form-group form-qty-small">
                            <label class="form-label">S·ªë l∆∞·ª£ng *</label>
                            <input type="number" class="form-input" name="so_luong" min="0" required placeholder="0">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                    <div class="phone-input-container">
                        <select id="phoneCountry" class="form-select" aria-label="Qu·ªëc gia">
                            <option value="+84" selected>üáªüá≥ (+84)</option>
                            <option value="+1">üá∫üá∏ (+1)</option>
                            <option value="+61">üá¶üá∫ (+61)</option>
                            <option value="+81">üáØüáµ (+81)</option>
                            <option value="+82">üá∞üá∑ (+82)</option>
                            <option value="+65">üá∏üá¨ (+65)</option>
                        </select>
                        <input type="tel" id="phoneNumber" class="form-input" name="dien_thoai_local" placeholder="Nh·∫≠p s·ªë (ch·ªâ s·ªë)" autocomplete="off">
                    </div>
                </div>
                <div class="form-group form-address">
                    <label class="form-label">ƒê·ªãa ch·ªâ *</label>
                    <textarea class="form-textarea" name="dia_chi" rows="3" required placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ kho"></textarea>
                </div>
            </div>
            
            
            
            <div class="form-group">
                <label class="form-label">Ghi ch√∫</label>
                <textarea class="form-textarea" name="ghi_chu" rows="3" placeholder="Nh·∫≠p ghi ch√∫"></textarea>
            </div>
            
            <div class="form-group">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-plus"></i>
                    T·∫°o kho h√†ng
                </button>
                <button type="button" class="btn btn-secondary" onclick="resetForm()">
                    <i class="fas fa-undo"></i>
                    L√†m m·ªõi
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Filter Bar -->
<div class="filter-bar">
    <div class="filter-row">
        <div class="form-group">
            <label class="form-label">T√¨m ki·∫øm</label>
            <div class="search-input">
                <i class="fas fa-search"></i>
                <input type="text" class="form-input" id="searchWarehouse" placeholder="T√¨m theo m√£ kho, t√™n kho, s·∫£n ph·∫©m...">
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">M√£ kho</label>
            <select class="form-select" id="warehouseCodeFilter">
                <option value="">T·∫•t c·∫£ m√£ kho</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">T√™n kho</label>
            <select class="form-select" id="warehouseNameFilter">
                <option value="">T·∫•t c·∫£ t√™n kho</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">Nh√≥m s·∫£n ph·∫©m</label>
            <select class="form-select" id="groupFilter">
                <option value="">T·∫•t c·∫£ nh√≥m</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">Tr·∫°ng th√°i</label>
            <select class="form-select" id="statusFilter">
                <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                <option value="C√≤n h√†ng">C√≤n h√†ng</option>
                <option value="H·∫øt h√†ng">H·∫øt h√†ng</option>
            </select>
        </div>
        
        <div class="form-group">
            <button class="btn btn-secondary" onclick="clearFilters()">
                <i class="fas fa-times"></i>
                X√≥a b·ªô l·ªçc
            </button>
        </div>
    </div>
</div>

<!-- Warehouse Table -->
<div class="table-container">
    <div class="card">
        <div class="card-header">
            <h3>Danh s√°ch kho h√†ng</h3>
        </div>
        <div class="card-body p-0">
            <table class="table" id="warehouseTable">
  <thead>
    <tr>
                        <th>STT</th>
                        <th>M√£ kho</th>
                        <th>T√™n kho</th>
                        <th>M√£ SP</th>
                        <th>Gi√° nh·∫≠p</th>
                        <th>S·ªë l∆∞·ª£ng</th>
                        <th>ƒê·ªãa ch·ªâ</th>
                        <th>S·ªë ƒëi·ªán tho·∫°i</th>
                        <th>Ghi ch√∫</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>Thao t√°c</th>
    </tr>
  </thead>
                <tbody id="warehouseTableBody">
                    <!-- Data will be loaded here -->
  </tbody>
</table>
    </div>
    </div>
</div>

<!-- Pagination -->
<div class="pagination" id="pagination">
    <!-- Pagination will be generated here -->
</div>

<!-- View Warehouse Modal -->
<div class="modal-overlay" id="viewWarehouseModal" style="display: none;">
    <div class="modal modal-large">
        <div class="modal-header">
            <h3><i class="fas fa-eye"></i> Chi ti·∫øt kho h√†ng</h3>
            <button class="modal-close" onclick="closeViewWarehouseModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div id="warehouseDetails">
                <!-- Warehouse details will be loaded here -->
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeViewWarehouseModal()">ƒê√≥ng</button>
        </div>
    </div>
</div>

<!-- Edit Warehouse Modal -->
<div class="modal-overlay" id="editWarehouseModal" style="display: none;">
<div class="modal modal-horizontal">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Ch·ªânh s·ª≠a kho h√†ng</h3>
            <button class="modal-close" onclick="closeEditWarehouseModal()">
                <i class="fas fa-times"></i>
            </button>
</div>
        <div class="modal-body">
            <form id="editWarehouseForm">
                <input type="hidden" name="id">
                
      <div class="form-row">
        <div class="form-group">
                        <label class="form-label">M√£ kho</label>
                        <input type="text" class="form-input" name="ma_kho" readonly>
        </div>
        <div class="form-group">
                        <label class="form-label">T√™n kho</label>
                        <input type="text" class="form-input" name="ten_kho" readonly>
        </div>
      </div>
                
      <div class="form-row">
        <div class="form-group">
                        <label class="form-label">M√£ s·∫£n ph·∫©m</label>
                        <input type="text" class="form-input" name="ma_sp" readonly>
        </div>
      </div>
                
      <div class="form-row">
        <div class="form-group">
                        <label class="form-label">S·ªë l∆∞·ª£ng *</label>
                        <input type="number" class="form-input" name="so_luong" min="0" required>
        </div>
        <div class="form-group">
                        <label class="form-label">Tr·∫°ng th√°i</label>
                        <select class="form-select" name="trang_thai">
                            <option value="C√≤n h√†ng">C√≤n h√†ng</option>
                            <option value="H·∫øt h√†ng">H·∫øt h√†ng</option>
                        </select>
        </div>
      </div>
                
      <div class="form-row">
        <div class="form-group">
                        <label class="form-label">Gi√° nh·∫≠p</label>
                        <div class="money-input-container">
                            <input type="text" id="edit_gia_nhap_display" class="form-input" oninput="formatMoneyTyping(this, document.getElementById('edit_gia_nhap'))">
                            <input type="hidden" name="gia_nhap" id="edit_gia_nhap">
                            <span class="currency-unit">VNƒê</span>
        </div>
      </div>
      
</div>

                <div class="form-group">
                    <label class="form-label">Ghi ch√∫</label>
                    <textarea class="form-textarea" name="ghi_chu" rows="3" placeholder="Nh·∫≠p ghi ch√∫"></textarea>
    </div>
            </form>
    </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeEditWarehouseModal()">H·ªßy</button>
            <button type="button" class="btn btn-primary" onclick="updateWarehouse()">C·∫≠p nh·∫≠t</button>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" id="deleteWarehouseModal" style="display: none;">
    <div class="modal modal-small">
        <div class="modal-header">
            <h3><i class="fas fa-exclamation-triangle"></i> X√°c nh·∫≠n x√≥a</h3>
            <button class="modal-close" onclick="closeDeleteWarehouseModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kho h√†ng n√†y kh√¥ng?</p>
            <p class="text-gray-600">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeDeleteWarehouseModal()">H·ªßy</button>
            <button type="button" class="btn btn-danger" onclick="confirmDeleteWarehouse()">X√≥a</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let warehouseData = [];
let filteredWarehouse = [];
let currentPage = 1;
const itemsPerPage = 10;
let deleteWarehouseId = null;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadWarehouseData();
    setupEventListeners();
    setupPhoneValidation();
});

// Setup event listeners
function setupEventListeners() {
    // Form submission
    document.getElementById('createWarehouseForm').addEventListener('submit', createWarehouse);
    
    // Store initial state for create form
    const createForm = document.getElementById('createWarehouseForm');
    storeModalState('createWarehouseForm', createForm);
    
    // Filter inputs
    document.getElementById('searchWarehouse').addEventListener('input', debounce(filterWarehouse, 300));
    document.getElementById('warehouseCodeFilter').addEventListener('change', filterWarehouse);
    document.getElementById('warehouseNameFilter').addEventListener('change', filterWarehouse);
    document.getElementById('groupFilter').addEventListener('change', filterWarehouse);
    document.getElementById('statusFilter').addEventListener('change', filterWarehouse);
}

// Ensure phone number accepts digits only
function setupPhoneValidation() {
    const phoneInput = document.getElementById('phoneNumber');
    const countrySelect = document.getElementById('phoneCountry');

    const phoneRules = {
        '+84': { abbr: 'VN', flag: 'üáªüá≥', maxLength: 10, ensureLeadingZero: true, placeholder: '0XXXXXXXXX' },
        '+1':  { abbr: 'US', flag: 'üá∫üá∏', maxLength: 10, ensureLeadingZero: false, placeholder: 'XXXXXXXXXX' },
        '+61': { abbr: 'AU', flag: 'üá¶üá∫', maxLength: 9,  ensureLeadingZero: false, placeholder: 'XXXXXXXXX' },
        '+81': { abbr: 'JP', flag: 'üáØüáµ', maxLength: 10, ensureLeadingZero: false, placeholder: 'XXXXXXXXXX' },
        '+82': { abbr: 'KR', flag: 'üá∞üá∑', maxLength: 10, ensureLeadingZero: false, placeholder: 'XXXXXXXXXX' },
        '+65': { abbr: 'SG', flag: 'üá∏üá¨', maxLength: 8,  ensureLeadingZero: false, placeholder: 'XXXXXXXX' }
    };

    function applyRule() {
        const code = countrySelect?.value || '+84';
        const rule = phoneRules[code] || phoneRules['+84'];
        if (phoneInput) {
            phoneInput.placeholder = rule.placeholder;
            let digits = (phoneInput.value || '').replace(/[^0-9]/g, '');
            if (rule.ensureLeadingZero && digits && digits[0] !== '0') {
                digits = '0' + digits;
            }
            if (digits.length > rule.maxLength) {
                digits = digits.slice(0, rule.maxLength);
            }
            phoneInput.value = digits;
        }
    }

    if (phoneInput) {
        phoneInput.addEventListener('input', function() {
            let digits = (phoneInput.value || '').replace(/[^0-9]/g, '');
            const code = countrySelect?.value || '+84';
            const rule = phoneRules[code] || phoneRules['+84'];
            if (rule.ensureLeadingZero) {
                if (digits.length > 0 && digits[0] !== '0') {
                    digits = '0' + digits;
                }
            }
            if (digits.length > rule.maxLength) {
                digits = digits.slice(0, rule.maxLength);
            }
            phoneInput.value = digits;
        });
    }

    if (countrySelect) {
        countrySelect.addEventListener('change', applyRule);
    }

    applyRule();
}

// Load warehouse data
async function loadWarehouseData() {
    try {
        const response = await fetch('{{ BACKEND_URL }}/api/warehouse/');
        if (response.ok) {
            warehouseData = await response.json();
            filteredWarehouse = [...warehouseData];
            updateStatistics();
            updateFilterOptions();
            updateWarehouseTable();
            updatePagination();
            } else {
            console.error('Failed to load warehouse data');
        }
    } catch (error) {
        console.error('Error loading warehouse data:', error);
    }
}

// Update statistics
function updateStatistics() {
    const totalWarehouses = new Set(warehouseData.map(w => w.ma_kho)).size;
    const totalProducts = warehouseData.length;
    const inStockProducts = warehouseData.filter(w => w.so_luong > 0).length;
    const outOfStockProducts = warehouseData.filter(w => w.so_luong <= 0).length;
    
    document.getElementById('totalWarehouses').textContent = totalWarehouses;
    document.getElementById('totalProducts').textContent = totalProducts;
    document.getElementById('inStockProducts').textContent = inStockProducts;
    document.getElementById('outOfStockProducts').textContent = outOfStockProducts;
}

// Create warehouse
async function createWarehouse(e) {
    e.preventDefault();
    
    const form = document.getElementById('createWarehouseForm');
    const formData = new FormData(form);
    const raw = Object.fromEntries(formData);
    
    // Build payload per backend schema WarehouseCreate
    const payload = {
        ma_kho: raw.ma_kho,
        ten_kho: raw.ten_kho,
        ma_sp: raw.ma_sp,
        gia_nhap: parseInt(document.getElementById('create_gia_nhap').value || '0'),
        so_luong: parseInt(raw.so_luong || '0'),
        dia_chi: (raw.dia_chi || '').toString(),
        dien_thoai: (function(){
            const code = (document.getElementById('phoneCountry')?.value || '+84');
            const local = (raw.dien_thoai_local || '').replace(/[^0-9]/g, '');
            return local ? `${code}${local}` : undefined;
        })(),
        ghi_chu: raw.ghi_chu || undefined,
        trang_thai: 'active',
    };

    try {
        const response = await fetch('{{ BACKEND_URL }}/api/warehouse/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`
            },
            body: JSON.stringify(payload)
        });
        
        if (response.ok) {
            document.getElementById('createWarehouseForm').reset();
            clearModalState('createWarehouseForm');
            storeModalState('createWarehouseForm', document.getElementById('createWarehouseForm'));
            loadWarehouseData();
            showSuccessMessage('T·∫°o kho h√†ng th√†nh c√¥ng!');
        } else {
            const error = await response.json();
            showErrorMessage(error.detail || 'C√≥ l·ªói x·∫£y ra khi t·∫°o kho h√†ng');
        }
    } catch (error) {
        showErrorMessage('C√≥ l·ªói x·∫£y ra khi t·∫°o kho h√†ng');
    }
}

// Reset form
function resetForm() {
    const form = document.getElementById('createWarehouseForm');
    form.reset();
    clearModalState('createWarehouseForm');
    storeModalState('createWarehouseForm', form);
}

// Update filter options
function updateFilterOptions() {
    // Warehouse codes
    const warehouseCodes = [...new Set(warehouseData.map(w => w.ma_kho))];
    const codeSelect = document.getElementById('warehouseCodeFilter');
    codeSelect.innerHTML = '<option value="">T·∫•t c·∫£ m√£ kho</option>';
    warehouseCodes.forEach(code => {
        const option = document.createElement('option');
        option.value = code;
        option.textContent = code;
        codeSelect.appendChild(option);
    });
    
    // Warehouse names
    const warehouseNames = [...new Set(warehouseData.map(w => w.ten_kho))];
    const nameSelect = document.getElementById('warehouseNameFilter');
    nameSelect.innerHTML = '<option value="">T·∫•t c·∫£ t√™n kho</option>';
    warehouseNames.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        nameSelect.appendChild(option);
    });
    
    // Product groups
    const groups = [...new Set(warehouseData.map(w => w.nhom_san_pham).filter(Boolean))];
    const groupSelect = document.getElementById('groupFilter');
    groupSelect.innerHTML = '<option value="">T·∫•t c·∫£ nh√≥m</option>';
    groups.forEach(group => {
        const option = document.createElement('option');
        option.value = group;
        option.textContent = group;
        groupSelect.appendChild(option);
    });
}

// Filter warehouse
function filterWarehouse() {
    const searchTerm = document.getElementById('searchWarehouse').value.toLowerCase();
    const codeFilter = document.getElementById('warehouseCodeFilter').value;
    const nameFilter = document.getElementById('warehouseNameFilter').value;
    const groupFilter = document.getElementById('groupFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    
    filteredWarehouse = warehouseData.filter(item => {
        const matchesSearch = !searchTerm || 
                             (item.ma_kho && item.ma_kho.toLowerCase().includes(searchTerm)) ||
                             (item.ten_kho && item.ten_kho.toLowerCase().includes(searchTerm)) ||
                             (item.ma_sp && item.ma_sp.toLowerCase().includes(searchTerm)) ||
                             (item.ten_sp && item.ten_sp.toLowerCase().includes(searchTerm));
        
        const matchesCode = !codeFilter || item.ma_kho === codeFilter;
        const matchesName = !nameFilter || item.ten_kho === nameFilter;
        const matchesGroup = !groupFilter || item.nhom_san_pham === groupFilter;
        const matchesStatus = !statusFilter || item.trang_thai === statusFilter;
        
        return matchesSearch && matchesCode && matchesName && matchesGroup && matchesStatus;
    });
    
    currentPage = 1;
    updateWarehouseTable();
    updatePagination();
}

// Clear filters
function clearFilters() {
    document.getElementById('searchWarehouse').value = '';
    document.getElementById('warehouseCodeFilter').value = '';
    document.getElementById('warehouseNameFilter').value = '';
    document.getElementById('groupFilter').value = '';
    document.getElementById('statusFilter').value = '';
    
    filteredWarehouse = [...warehouseData];
    currentPage = 1;
    updateWarehouseTable();
    updatePagination();
}

// Update warehouse table
function updateWarehouseTable() {
    const tbody = document.getElementById('warehouseTableBody');
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageItems = filteredWarehouse.slice(startIndex, endIndex);
    
    tbody.innerHTML = pageItems.map((item, index) => {
        // Determine actual status based on quantity
        let status = item.so_luong > 0 ? 'C√≤n h√†ng' : 'H·∫øt h√†ng';
        return `
        <tr>
            <td>${startIndex + index + 1}</td>
            <td><strong>${item.ma_kho || '-'}</strong></td>
            <td>${item.ten_kho || '-'}</td>
            <td><strong>${item.ma_sp || '-'}</strong></td>
            <td>${(item.gia_nhap || 0).toLocaleString()} VNƒê</td>
            <td><span class="badge badge-secondary">${(item.so_luong || 0).toLocaleString()}</span></td>
            <td>${item.dia_chi || '-'}</td>
            <td>${item.dien_thoai || '-'}</td>
            <td>${item.ghi_chu || '-'}</td>
            <td>${getStatusBadge(status)}</td>
            <td>
                <div class="table-actions">
                    <button class="btn btn-sm btn-secondary" onclick="viewWarehouse(${item.id})">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="editWarehouse(${item.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteWarehouse(${item.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
        `;
    }).join('');
}

// Update pagination
function updatePagination() {
    const totalPages = Math.ceil(filteredWarehouse.length / itemsPerPage);
    const pagination = document.getElementById('pagination');
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let paginationHTML = '';
    
    // Previous button
    paginationHTML += `
        <button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">
            <i class="fas fa-chevron-left"></i>
        </button>
    `;
    
    // Page numbers
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        paginationHTML += `<button class="pagination-btn" onclick="goToPage(1)">1</button>`;
        if (startPage > 2) {
            paginationHTML += `<span class="text-gray-500">...</span>`;
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
            <button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">
                ${i}
            </button>
        `;
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            paginationHTML += `<span class="text-gray-500">...</span>`;
        }
        paginationHTML += `<button class="pagination-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
    }
    
    // Next button
    paginationHTML += `
        <button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">
            <i class="fas fa-chevron-right"></i>
        </button>
    `;
    
    pagination.innerHTML = paginationHTML;
}

// Go to page
function goToPage(page) {
    const totalPages = Math.ceil(filteredWarehouse.length / itemsPerPage);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        updateWarehouseTable();
        updatePagination();
    }
}

// Modal functions
function viewWarehouse(id) {
    const item = warehouseData.find(w => w.id === id);
    if (item) {
        const details = document.getElementById('warehouseDetails');
        details.innerHTML = `
            <div class="warehouse-details">
                <div class="detail-row">
                    <span class="detail-label">M√£ kho:</span>
                    <span class="detail-value">${item.ma_kho}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">T√™n kho:</span>
                    <span class="detail-value">${item.ten_kho}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">M√£ s·∫£n ph·∫©m:</span>
                    <span class="detail-value">${item.ma_sp || '-'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">ƒê·ªãa ch·ªâ:</span>
                    <span class="detail-value">${item.dia_chi || '-'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">S·ªë l∆∞·ª£ng:</span>
                    <span class="detail-value">${(item.so_luong || 0).toLocaleString()}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Gi√° nh·∫≠p:</span>
                    <span class="detail-value">${(item.gia_nhap || 0).toLocaleString()} VNƒê</span>
                </div>
                
                <div class="detail-row">
                    <span class="detail-label">Tr·∫°ng th√°i:</span>
                    <span class="detail-value">${getStatusBadge(item.trang_thai)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Ghi ch√∫:</span>
                    <span class="detail-value">${item.ghi_chu || '-'}</span>
                </div>
            </div>
        `;
        
        document.getElementById('viewWarehouseModal').style.display = 'flex';
    }
}

function closeViewWarehouseModal() {
    document.getElementById('viewWarehouseModal').style.display = 'none';
}

function editWarehouse(id) {
    const item = warehouseData.find(w => w.id === id);
    if (item) {
        const form = document.getElementById('editWarehouseForm');
        form.querySelector('input[name="id"]').value = item.id;
        form.querySelector('input[name="ma_kho"]').value = item.ma_kho || '';
        form.querySelector('input[name="ten_kho"]').value = item.ten_kho || '';
        form.querySelector('input[name="nhom_san_pham"]').value = item.nhom_san_pham || '';
        form.querySelector('input[name="ma_sp"]').value = item.ma_sp || '';
        form.querySelector('input[name="ten_sp"]').value = item.ten_sp || '';
        form.querySelector('input[name="so_luong"]').value = item.so_luong || 0;
        form.querySelector('select[name="trang_thai"]').value = item.trang_thai || '';
        form.querySelector('textarea[name="ghi_chu"]').value = item.ghi_chu || '';
        
        const giaNhap = item.gia_nhap || 0;
        document.getElementById('edit_gia_nhap').value = giaNhap;
        document.getElementById('edit_gia_nhap_display').value = giaNhap.toLocaleString();
        
        // Store initial state for edit modal
        storeModalState('editWarehouseModal', form);
        
        // Store initial state for edit modal
        storeModalState('editWarehouseModal', form);
        
        document.getElementById('editWarehouseModal').style.display = 'flex';
    }
}

function closeEditWarehouseModal() {
    closeModalWithConfirmation('editWarehouseModal');
}

async function updateWarehouse() {
    const form = document.getElementById('editWarehouseForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    const id = data.id;
    delete data.id;
    
    // Convert numeric fields
    data.so_luong = parseInt(data.so_luong || '0');
    data.gia_nhap = parseInt(document.getElementById('edit_gia_nhap').value || '0');
    
    // Update status based on quantity
    if (data.so_luong > 0) {
        data.trang_thai = 'C√≤n h√†ng';
    } else {
        data.trang_thai = 'H·∫øt h√†ng';
    }
    
    try {
        const response = await fetch(`{{ BACKEND_URL }}/api/warehouse/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            document.getElementById('editWarehouseModal').style.display = 'none';
            clearModalState('editWarehouseModal');
            loadWarehouseData();
            showSuccessMessage('C·∫≠p nh·∫≠t th√†nh c√¥ng!');
        } else {
            const error = await response.json();
            showErrorMessage(error.detail || 'C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t kho h√†ng');
        }
    } catch (error) {
        showErrorMessage('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t kho h√†ng');
    }
}

// Utility functions
function getStatusBadge(status) {
    const badges = {
        'C√≤n h√†ng': '<span class="badge badge-success">C√≤n h√†ng</span>',
        'H·∫øt h√†ng': '<span class="badge badge-danger">H·∫øt h√†ng</span>'
    };
    return badges[status] || '<span class="badge badge-secondary">Kh√¥ng x√°c ƒë·ªãnh</span>';
}

function formatMoneyTyping(sourceInput, hiddenInput) {
    const raw = (sourceInput.value || '').replace(/[^0-9]/g, '');
    if (!raw) {
        sourceInput.value = '';
        if (hiddenInput) hiddenInput.value = '';
    return;
  }
    if (hiddenInput) hiddenInput.value = raw;
    sourceInput.value = raw.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function deleteWarehouse(id) {
    deleteWarehouseId = id;
    document.getElementById('deleteWarehouseModal').style.display = 'flex';
}

function closeDeleteWarehouseModal() {
    document.getElementById('deleteWarehouseModal').style.display = 'none';
    deleteWarehouseId = null;
}

async function confirmDeleteWarehouse() {
    if (!deleteWarehouseId) return;
    
    try {
        const response = await fetch(`{{ BACKEND_URL }}/api/warehouse/${deleteWarehouseId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`
            }
        });
        
        if (response.ok) {
            closeDeleteWarehouseModal();
            loadWarehouseData();
            showSuccessMessage('X√≥a kho h√†ng th√†nh c√¥ng!');
        } else {
            const error = await response.json();
            showErrorMessage(error.detail || 'C√≥ l·ªói x·∫£y ra khi x√≥a kho h√†ng');
        }
    } catch (error) {
        showErrorMessage('C√≥ l·ªói x·∫£y ra khi x√≥a kho h√†ng');
    }
}

function showSuccessMessage(message) {
    showSuccessModal('Th√†nh c√¥ng', message);
}

function showErrorMessage(message) {
    showErrorModal('L·ªói', message);
}
</script>
{% endblock %}