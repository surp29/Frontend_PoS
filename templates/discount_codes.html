{% extends "base.html" %}

{% block title %}Mã giảm giá - PhanMemKeToan{% endblock %}

{% block page_title %}
<i class="fas fa-tags"></i> Mã giảm giá
{% endblock %}

{% block page_description %}
Quản lý mã giảm giá, khuyến mãi và chương trình ưu đãi
{% endblock %}

{% block content %}
<!-- Statistics Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-tags"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="totalCodes">0</div>
            <div class="stat-label">Tổng mã giảm giá</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="activeCodes">0</div>
            <div class="stat-label">Đang hoạt động</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-ban"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="expiredCodes">0</div>
            <div class="stat-label">Hết hạn</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-money-bill-wave"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="totalSavings">0 VNĐ</div>
            <div class="stat-label">Tổng tiết kiệm</div>
        </div>
    </div>
</div>

<!-- Filter Bar -->
<div class="filter-bar">
    <div class="filter-row">
        <div class="form-group">
            <label class="form-label">Tìm kiếm</label>
            <div class="search-input">
                <i class="fas fa-search"></i>
                <input type="text" class="form-input" id="searchCode" placeholder="Tìm theo mã, tên, mô tả...">
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Trạng thái</label>
            <select class="form-select" id="statusFilter">
                <option value="">Tất cả trạng thái</option>
                <option value="active">Đang hoạt động</option>
                <option value="expired">Hết hạn</option>
                <option value="inactive">Không hoạt động</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">Loại giảm giá</label>
            <select class="form-select" id="typeFilter">
                <option value="">Tất cả loại</option>
                <option value="percentage">Phần trăm</option>
                <option value="fixed">Số tiền cố định</option>
            </select>
        </div>
        
        <div class="form-group">
            <button class="btn btn-secondary" onclick="clearFilters()">
                <i class="fas fa-times"></i>
                Xóa bộ lọc
            </button>
        </div>
    </div>
</div>

<!-- Discount Codes Table -->
<div class="table-container">
    <div class="card">
        <div class="card-header">
            <h3>Danh sách mã giảm giá</h3>
            <button class="btn btn-primary" onclick="openAddCodeModal()">
                <i class="fas fa-plus"></i>
                Thêm mã giảm giá
            </button>
        </div>
        <div class="card-body p-0">
            <table class="table" id="codesTable">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Mã giảm giá</th>
                        <th>Tên</th>
                        <th>Loại</th>
                        <th>Giá trị</th>
                        <th>Ngày bắt đầu</th>
                        <th>Ngày kết thúc</th>
                        <th>Số lần sử dụng</th>
                        <th>Trạng thái</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody id="codesTableBody">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Pagination -->
<div class="pagination" id="pagination">
    <!-- Pagination will be generated here -->
</div>

<!-- Add Discount Code Modal -->
<div class="modal-overlay" id="addCodeModal" style="display: none;">
    <div class="modal modal-horizontal">
        <div class="modal-header">
            <h3><i class="fas fa-plus"></i> Thêm mã giảm giá mới</h3>
            <button class="modal-close" onclick="closeAddCodeModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="addCodeForm">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Mã giảm giá *</label>
                        <input type="text" class="form-input" name="code" required placeholder="Nhập mã giảm giá">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tên mã *</label>
                        <input type="text" class="form-input" name="name" required placeholder="Nhập tên mã">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Loại giảm giá *</label>
                        <select class="form-select" name="discount_type" required>
                            <option value="">Chọn loại</option>
                            <option value="percentage">Phần trăm (%)</option>
                            <option value="fixed">Số tiền cố định (VNĐ)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Giá trị *</label>
                        <input type="text" class="form-input" name="discount_value" required placeholder="Nhập giá trị" oninput="formatNumberInput(this)" onkeypress="return isNumberKey(event)">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Ngày bắt đầu *</label>
                        <input type="datetime-local" class="form-input" name="start_date" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ngày kết thúc *</label>
                        <input type="datetime-local" class="form-input" name="end_date" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Số lần sử dụng tối đa</label>
                        <input type="text" class="form-input" name="max_uses" placeholder="Không giới hạn" oninput="formatNumberInput(this)" onkeypress="return isNumberKey(event)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Giá trị đơn hàng tối thiểu</label>
                        <input type="text" class="form-input" name="min_order_value" placeholder="Không giới hạn" oninput="formatNumberInput(this)" onkeypress="return isNumberKey(event)">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Mô tả</label>
                    <textarea class="form-textarea" name="description" rows="3" placeholder="Nhập mô tả mã giảm giá"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeAddCodeModal()">Hủy</button>
            <button type="button" class="btn btn-primary" onclick="createCode()">Tạo mã</button>
        </div>
    </div>
</div>

<!-- Edit Discount Code Modal -->
<div class="modal-overlay" id="editCodeModal" style="display: none;">
    <div class="modal modal-horizontal">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Chỉnh sửa mã giảm giá</h3>
            <button class="modal-close" onclick="closeEditCodeModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="editCodeForm">
                <input type="hidden" name="id">
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Mã giảm giá *</label>
                        <input type="text" class="form-input" name="code" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tên mã *</label>
                        <input type="text" class="form-input" name="name" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Loại giảm giá *</label>
                        <select class="form-select" name="discount_type" required>
                            <option value="percentage">Phần trăm (%)</option>
                            <option value="fixed">Số tiền cố định (VNĐ)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Giá trị *</label>
                        <input type="text" class="form-input" name="discount_value" required oninput="formatNumberInput(this)" onkeypress="return isNumberKey(event)">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Ngày bắt đầu *</label>
                        <input type="datetime-local" class="form-input" name="start_date" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ngày kết thúc *</label>
                        <input type="datetime-local" class="form-input" name="end_date" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Số lần sử dụng tối đa</label>
                        <input type="text" class="form-input" name="max_uses" oninput="formatNumberInput(this)" onkeypress="return isNumberKey(event)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Giá trị đơn hàng tối thiểu</label>
                        <input type="text" class="form-input" name="min_order_value" oninput="formatNumberInput(this)" onkeypress="return isNumberKey(event)">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Mô tả</label>
                    <textarea class="form-textarea" name="description" rows="3"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeEditCodeModal()">Hủy</button>
            <button type="button" class="btn btn-primary" onclick="updateCode()">Cập nhật</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" id="deleteCodeModal" style="display: none;">
    <div class="modal modal-small">
        <div class="modal-header">
            <h3><i class="fas fa-exclamation-triangle"></i> Xác nhận xóa</h3>
            <button class="modal-close" onclick="closeDeleteCodeModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p>Bạn có chắc chắn muốn xóa mã giảm giá này không?</p>
            <p class="text-gray-600">Hành động này không thể hoàn tác.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeDeleteCodeModal()">Hủy</button>
            <button type="button" class="btn btn-danger" onclick="confirmDeleteCode()">Xóa</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let codesData = [];
let filteredCodes = [];
let currentPage = 1;
const itemsPerPage = 20; // Popup modal: 20 items per page
let deleteCodeId = null;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadCodesData();
    setupEventListeners();
});

// Setup event listeners
function setupEventListeners() {
    document.getElementById('searchCode').addEventListener('input', debounce(filterCodes, 300));
    document.getElementById('statusFilter').addEventListener('change', filterCodes);
    document.getElementById('typeFilter').addEventListener('change', filterCodes);
}

// Load codes data
async function loadCodesData() {
    try {
        const response = await fetch('{{ BACKEND_URL }}/api/discount-codes/');
        if (response.ok) {
            codesData = await response.json();
            filteredCodes = [...codesData];
            updateStatistics();
            updateCodesTable();
            updatePagination();
        } else {
            console.error('Failed to load discount codes');
        }
    } catch (error) {
        console.error('Error loading discount codes:', error);
    }
}

// Update statistics
function updateStatistics() {
    const totalCodes = codesData.length;
    const activeCodes = codesData.filter(c => c.status === 'active').length;
    const expiredCodes = codesData.filter(c => c.status === 'expired').length;
    const totalSavings = codesData.reduce((sum, code) => sum + (code.total_savings || 0), 0);
    
    document.getElementById('totalCodes').textContent = totalCodes;
    document.getElementById('activeCodes').textContent = activeCodes;
    document.getElementById('expiredCodes').textContent = expiredCodes;
    document.getElementById('totalSavings').textContent = totalSavings.toLocaleString() + ' VNĐ';
}

// Filter codes
function filterCodes() {
    const searchTerm = document.getElementById('searchCode').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const typeFilter = document.getElementById('typeFilter').value;
    
    filteredCodes = codesData.filter(code => {
        const matchesSearch = !searchTerm || 
                             (code.code && code.code.toLowerCase().includes(searchTerm)) ||
                             (code.name && code.name.toLowerCase().includes(searchTerm)) ||
                             (code.description && code.description.toLowerCase().includes(searchTerm));
        
        const matchesStatus = !statusFilter || code.status === statusFilter;
        const matchesType = !typeFilter || code.discount_type === typeFilter;
        
        return matchesSearch && matchesStatus && matchesType;
    });
    
    currentPage = 1;
    updateCodesTable();
    updatePagination();
}

// Clear filters
function clearFilters() {
    document.getElementById('searchCode').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('typeFilter').value = '';
    
    filteredCodes = [...codesData];
    currentPage = 1;
    updateCodesTable();
    updatePagination();
}

// Update codes table
function updateCodesTable() {
    const tbody = document.getElementById('codesTableBody');
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageCodes = filteredCodes.slice(startIndex, endIndex);
    
    if (pageCodes.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="10" class="text-center text-gray-500 py-8">
                    <i class="fas fa-tags text-4xl mb-4 block"></i>
                    <p class="text-lg font-medium">Không có mã giảm giá nào</p>
                    <p class="text-sm">Hãy tạo mã giảm giá đầu tiên của bạn</p>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = pageCodes.map((code, index) => `
        <tr class="hover:bg-gray-50 transition-colors">
            <td class="text-center text-gray-600 font-medium">${startIndex + index + 1}</td>
            <td>
                <div class="flex items-center gap-2">
                    <span class="inline-flex items-center px-2-5 py-0-5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        <i class="fas fa-tag mr-1"></i>
                        ${code.code || '-'}
                    </span>
                </div>
            </td>
            <td>
                <div class="font-medium text-gray-900">${code.name || '-'}</div>
                ${code.description ? `<div class="text-sm text-gray-500 mt-1">${code.description}</div>` : ''}
            </td>
            <td>${getTypeBadge(code.discount_type)}</td>
            <td>
                <div class="text-right">
                    <div class="font-semibold text-lg ${code.discount_type === 'percentage' ? 'text-green-600' : 'text-orange-600'}">
                        ${formatDiscountValue(code.discount_type, code.discount_value)}
                    </div>
                    ${code.min_order_value > 0 ? `<div class="text-xs text-gray-500">Từ ${code.min_order_value.toLocaleString()} VNĐ</div>` : ''}
                </div>
            </td>
            <td>
                <div class="text-sm">
                    <div class="font-medium text-gray-900">${formatDate(code.start_date)}</div>
                    <div class="text-gray-500">${formatTime(code.start_date)}</div>
                </div>
            </td>
            <td>
                <div class="text-sm">
                    <div class="font-medium text-gray-900">${formatDate(code.end_date)}</div>
                    <div class="text-gray-500">${formatTime(code.end_date)}</div>
                </div>
            </td>
            <td>
                <div class="text-center">
                    <div class="font-semibold text-gray-900">${code.used_count || 0}</div>
                    <div class="text-xs text-gray-500">/${code.max_uses || '∞'}</div>
                    ${code.max_uses ? `<div class="w-full bg-gray-200 rounded-full h-1-5 mt-1">
                        <div class="bg-blue-600 h-1-5 rounded-full" style="width: ${Math.min(100, ((code.used_count || 0) / code.max_uses) * 100)}%"></div>
                    </div>` : ''}
                </div>
            </td>
            <td>${getStatusBadge(code.status)}</td>
            <td>
                <div class="flex items-center justify-center gap-2">
                    <button class="btn btn-sm btn-primary hover:bg-blue-700 transition-colors" onclick="editCode(${code.id})" title="Chỉnh sửa">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger hover:bg-red-700 transition-colors" onclick="deleteCode(${code.id})" title="Xóa">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

// Update pagination
function updatePagination() {
    const totalPages = Math.ceil(filteredCodes.length / itemsPerPage);
    const pagination = document.getElementById('pagination');
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    pagination.innerHTML = generatePaginationHTML(currentPage, totalPages);
}

// Generate pagination HTML
function generatePaginationHTML(currentPage, totalPages) {
    let paginationHTML = '';
    
    // Previous button
    paginationHTML += `
        <button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">
            <i class="fas fa-chevron-left"></i>
        </button>
    `;
    
    // Page numbers
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        paginationHTML += `<button class="pagination-btn" onclick="goToPage(1)">1</button>`;
        if (startPage > 2) {
            paginationHTML += `<span class="text-gray-500">...</span>`;
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
            <button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">
                ${i}
            </button>
        `;
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            paginationHTML += `<span class="text-gray-500">...</span>`;
        }
        paginationHTML += `<button class="pagination-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
    }
    
    // Next button
    paginationHTML += `
        <button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">
            <i class="fas fa-chevron-right"></i>
        </button>
    `;
    
    return paginationHTML;
}

// Go to page
function goToPage(page) {
    const totalPages = Math.ceil(filteredCodes.length / itemsPerPage);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        updateCodesTable();
        updatePagination();
    }
}

// Modal functions
function openAddCodeModal() {
    const modal = document.getElementById('addCodeModal');
    const form = document.getElementById('addCodeForm');
    
    modal.style.display = 'flex';
    form.reset();
    
    // Set default start date to now
    const now = new Date();
    const startDate = now.toISOString().slice(0, 16);
    form.querySelector('input[name="start_date"]').value = startDate;
    
    // Set default end date to 30 days from now
    const endDate = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);
    form.querySelector('input[name="end_date"]').value = endDate.toISOString().slice(0, 16);
    
    // Store initial state
    storeModalState('addCodeModal', form);
}

function closeAddCodeModal() {
    document.getElementById('addCodeModal').style.display = 'none';
    clearModalState('addCodeModal');
}

function editCode(id) {
    const code = codesData.find(c => c.id === id);
    if (code) {
        const form = document.getElementById('editCodeForm');
        form.querySelector('input[name="id"]').value = code.id;
        form.querySelector('input[name="code"]').value = code.code || '';
        form.querySelector('input[name="name"]').value = code.name || '';
        form.querySelector('select[name="discount_type"]').value = code.discount_type || '';
        
        // Format numbers with commas
        const discountValueInput = form.querySelector('input[name="discount_value"]');
        discountValueInput.value = code.discount_value ? code.discount_value.toLocaleString() : '';
        
        const maxUsesInput = form.querySelector('input[name="max_uses"]');
        maxUsesInput.value = code.max_uses ? code.max_uses.toLocaleString() : '';
        
        const minOrderValueInput = form.querySelector('input[name="min_order_value"]');
        minOrderValueInput.value = code.min_order_value ? code.min_order_value.toLocaleString() : '';
        
        form.querySelector('input[name="start_date"]').value = formatDateTimeForInput(code.start_date);
        form.querySelector('input[name="end_date"]').value = formatDateTimeForInput(code.end_date);
        form.querySelector('textarea[name="description"]').value = code.description || '';
        
        // Store initial state for edit modal
        storeModalState('editCodeModal', form);
        
        document.getElementById('editCodeModal').style.display = 'flex';
    }
}

function closeEditCodeModal() {
    closeModalWithConfirmation('editCodeModal');
}

function deleteCode(id) {
    deleteCodeId = id;
    document.getElementById('deleteCodeModal').style.display = 'flex';
}

function closeDeleteCodeModal() {
    document.getElementById('deleteCodeModal').style.display = 'none';
    deleteCodeId = null;
}

// CRUD operations
async function createCode() {
    const form = document.getElementById('addCodeForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    // Convert formatted numbers back to numeric values
    data.discount_value = getNumericValue(data.discount_value);
    data.max_uses = data.max_uses ? getNumericValue(data.max_uses) : null;
    data.min_order_value = getNumericValue(data.min_order_value);
    
    try {
        const response = await fetch('{{ BACKEND_URL }}/api/discount-codes/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            document.getElementById('addCodeModal').style.display = 'none';
            clearModalState('addCodeModal');
            loadCodesData();
            showSuccessMessage('Tạo mã giảm giá thành công!');
        } else {
            const error = await response.json();
            showErrorMessage(error.detail || 'Có lỗi xảy ra khi tạo mã giảm giá');
        }
    } catch (error) {
        showErrorMessage('Có lỗi xảy ra khi tạo mã giảm giá');
    }
}

async function updateCode() {
    const form = document.getElementById('editCodeForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    const id = data.id;
    delete data.id;
    
    // Convert formatted numbers back to numeric values
    data.discount_value = getNumericValue(data.discount_value);
    data.max_uses = data.max_uses ? getNumericValue(data.max_uses) : null;
    data.min_order_value = getNumericValue(data.min_order_value);
    
    try {
        const response = await fetch(`{{ BACKEND_URL }}/api/discount-codes/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            document.getElementById('editCodeModal').style.display = 'none';
            clearModalState('editCodeModal');
            loadCodesData();
            showSuccessMessage('Cập nhật mã giảm giá thành công!');
        } else {
            const error = await response.json();
            showErrorMessage(error.detail || 'Có lỗi xảy ra khi cập nhật mã giảm giá');
        }
    } catch (error) {
        showErrorMessage('Có lỗi xảy ra khi cập nhật mã giảm giá');
    }
}

async function confirmDeleteCode() {
    if (!deleteCodeId) return;
    
    try {
        const response = await fetch(`{{ BACKEND_URL }}/api/discount-codes/${deleteCodeId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`
            }
        });
        
        if (response.ok) {
            closeDeleteCodeModal();
            loadCodesData();
            showSuccessMessage('Xóa mã giảm giá thành công!');
        } else {
            const error = await response.json();
            showErrorMessage(error.detail || 'Có lỗi xảy ra khi xóa mã giảm giá');
        }
    } catch (error) {
        showErrorMessage('Có lỗi xảy ra khi xóa mã giảm giá');
    }
}

// Utility functions
function getTypeBadge(type) {
    const badges = {
        'percentage': '<span class="badge badge-success">Phần trăm</span>',
        'fixed': '<span class="badge badge-warning">Số tiền cố định</span>'
    };
    return badges[type] || '<span class="badge badge-secondary">Không xác định</span>';
}

function getStatusBadge(status) {
    const badges = {
        'active': '<span class="badge badge-success">Đang hoạt động</span>',
        'expired': '<span class="badge badge-danger">Hết hạn</span>',
        'inactive': '<span class="badge badge-secondary">Không hoạt động</span>'
    };
    return badges[status] || '<span class="badge badge-secondary">Không xác định</span>';
}

function formatDiscountValue(type, value) {
    if (type === 'percentage') {
        return `${value}%`;
    } else {
        return `${value.toLocaleString()} VNĐ`;
    }
}

function formatDateTime(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleString('vi-VN');
}

function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('vi-VN');
}

function formatTime(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
}

function formatDateTimeForInput(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toISOString().slice(0, 16);
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function showSuccessMessage(message) {
    showSuccessModal('Thành công', message);
}

function showErrorMessage(message) {
    showErrorModal('Lỗi', message);
}

// Format number input with commas
function formatNumberInput(input) {
    // Remove all non-numeric characters except decimal point
    let value = input.value.replace(/[^0-9.]/g, '');
    
    // Handle decimal point (only allow one)
    const parts = value.split('.');
    if (parts.length > 2) {
        value = parts[0] + '.' + parts.slice(1).join('');
    }
    
    // Format integer part with commas
    if (parts[0]) {
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        value = parts.join('.');
    }
    
    input.value = value;
}

// Only allow numbers and decimal point
function isNumberKey(evt) {
    const charCode = (evt.which) ? evt.which : evt.keyCode;
    // Allow: backspace, delete, tab, escape, enter, decimal point
    if ([8, 9, 27, 13, 46, 110, 190].indexOf(charCode) !== -1 ||
        // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
        (charCode === 65 && evt.ctrlKey === true) ||
        (charCode === 67 && evt.ctrlKey === true) ||
        (charCode === 86 && evt.ctrlKey === true) ||
        (charCode === 88 && evt.ctrlKey === true)) {
        return true;
    }
    // Ensure that it is a number and stop the keypress
    if ((charCode < 48 || charCode > 57)) {
        evt.preventDefault();
        return false;
    }
    return true;
}

// Get numeric value from formatted input
function getNumericValue(formattedValue) {
    return parseFloat(formattedValue.replace(/,/g, '')) || 0;
}
</script>
{% endblock %}
