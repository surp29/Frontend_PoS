{% extends "base.html" %}

{% block title %}Quản lý tài khoản - PhanMemKeToan{% endblock %}

{% block page_title %}
<i class="fas fa-users"></i> Quản lý tài khoản
{% endblock %}

{% block page_description %}
Quản lý thông tin khách hàng và nhân viên, theo dõi tài khoản và trạng thái hoạt động
{% endblock %}

{% block content %}
<!-- Statistics Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-users"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="totalCustomers">0</div>
            <div class="stat-label">Tổng khách hàng</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-user-tie"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="totalEmployees">0</div>
            <div class="stat-label">Tổng nhân viên</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="activeAccounts">0</div>
            <div class="stat-label">Tài khoản hoạt động</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-envelope"></i>
        </div>
        <div class="stat-content">
            <div class="stat-number" id="accountsWithEmail">0</div>
            <div class="stat-label">Có email</div>
        </div>
    </div>
</div>

<!-- Account Tabs -->
<div class="tabs-container">
    <div class="tabs">
        <button class="tab active" data-tab="customers">Khách hàng</button>
        <button class="tab" data-tab="employees">Nhân viên</button>
    </div>
    </div>

    <!-- Customer Tab Content -->
<div id="customersSection" class="tab-section">
    <!-- Filter Bar -->
        <div class="filter-bar">
        <div class="filter-row">
            <div class="form-group">
                <label class="form-label">Tìm kiếm</label>
                <div class="search-input">
                    <i class="fas fa-search"></i>
                    <input type="text" class="form-input" id="searchCustomer" placeholder="Tìm theo tên, email, số điện thoại...">
            </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Trạng thái</label>
                <select class="form-select" id="customerStatusFilter">
                    <option value="">Tất cả trạng thái</option>
                    <option value="true">Hoạt động</option>
                    <option value="false">Không hoạt động</option>
                </select>
            </div>
            
            <div class="form-group">
                <button class="btn btn-secondary" onclick="clearCustomerFilters()">
                    <i class="fas fa-times"></i>
                    Xóa bộ lọc
                </button>
            </div>
        </div>
        </div>

        <!-- Customer Table -->
        <div class="table-container">
        <div class="card">
            <div class="card-header">
                <h3>Danh sách khách hàng</h3>
                <button class="btn btn-primary" onclick="openAddCustomerModal()">
                    <i class="fas fa-plus"></i>
                    Thêm khách hàng
                </button>
            </div>
            <div class="card-body p-0">
                <table class="table" id="customersTable">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Tên khách hàng</th>
                        <th>Tk nợ</th>
                        <th>Tk có</th>
                        <th>Email</th>
                        <th>Số điện thoại</th>
                        <th>Địa chỉ</th>
                        <th>Trạng thái</th>
                            <th>Thao tác</th>
                    </tr>
                </thead>
                    <tbody id="customersTableBody">
                        <!-- Data will be loaded here -->
                </tbody>
            </table>
            </div>
        </div>
    </div>
    
    <!-- Pagination -->
    <div class="pagination" id="customersPagination">
        <!-- Pagination will be generated here -->
        </div>
    </div>

    <!-- Employee Tab Content -->
<div id="employeesSection" class="tab-section" style="display: none;">
    <!-- Filter Bar -->
        <div class="filter-bar">
        <div class="filter-row">
            <div class="form-group">
                <label class="form-label">Tìm kiếm</label>
                <div class="search-input">
                    <i class="fas fa-search"></i>
                    <input type="text" class="form-input" id="searchEmployee" placeholder="Tìm theo tên, email, chức vụ...">
            </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Phòng ban</label>
                <select class="form-select" id="employeeDepartmentFilter">
                    <option value="">Tất cả phòng ban</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Trạng thái</label>
                <select class="form-select" id="employeeStatusFilter">
                    <option value="">Tất cả trạng thái</option>
                    <option value="true">Hoạt động</option>
                    <option value="false">Không hoạt động</option>
                </select>
            </div>
            
            <div class="form-group">
                <button class="btn btn-secondary" onclick="clearEmployeeFilters()">
                    <i class="fas fa-times"></i>
                    Xóa bộ lọc
                </button>
            </div>
        </div>
        </div>

        <!-- Employee Table -->
        <div class="table-container">
        <div class="card">
            <div class="card-header">
                <h3>Danh sách nhân viên</h3>
                <button class="btn btn-primary" onclick="openAddEmployeeModal()">
                    <i class="fas fa-plus"></i>
                    Thêm nhân viên
                </button>
            </div>
            <div class="card-body p-0">
                <table class="table" id="employeesTable">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Tên nhân viên</th>
                            <th>Chức vụ</th>
                            <th>Phòng ban</th>
                        <th>Email</th>
                        <th>Số điện thoại</th>
                            <th>Địa chỉ</th>
                        <th>Trạng thái</th>
                            <th>Thao tác</th>
                    </tr>
                </thead>
                    <tbody id="employeesTableBody">
                        <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

    <!-- Pagination -->
    <div class="pagination" id="employeesPagination">
        <!-- Pagination will be generated here -->
    </div>
</div>

<!-- Add Customer Modal -->
<div class="modal-overlay" id="addCustomerModal" style="display: none;">
    <div class="modal modal-horizontal">
		<div class="modal-header">
            <h3><i class="fas fa-user-plus"></i> Thêm khách hàng mới</h3>
            <button class="modal-close" onclick="closeAddCustomerModal()">
                <i class="fas fa-times"></i>
            </button>
		</div>
        <div class="modal-body">
		<form id="addCustomerForm">
			<div class="form-row">
				<div class="form-group">
                        <label class="form-label">Tên khách hàng *</label>
                        <input type="text" class="form-input" name="ten_tk" required placeholder="Nhập tên khách hàng">
				</div>
				<div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" name="email" placeholder="Nhập email">
				</div>
				<div class="form-group">
                        <label class="form-label">Số điện thoại</label>
                        <input type="tel" class="form-input" name="so_dt" placeholder="Nhập số điện thoại">
				</div>
			</div>

			<div class="form-row">
				<div class="form-group">
                        <label class="form-label">Trạng thái</label>
                        <select class="form-select" name="trang_thai">
                            <option value="true">Hoạt động</option>
                            <option value="false">Không hoạt động</option>
                        </select>
				</div>
				<div class="form-group">
                        <label class="form-label">Tk nợ</label>
                        <input type="text" class="form-input" name="tk_no" placeholder="Nhập tài khoản nợ">
				</div>
				<div class="form-group">
                        <label class="form-label">Tk có</label>
                        <input type="text" class="form-input" name="tk_co" placeholder="Nhập tài khoản có">
				</div>
				</div>
                
				<div class="form-group">
                    <label class="form-label">Địa chỉ</label>
                    <textarea class="form-textarea" name="dia_chi" rows="3" placeholder="Nhập địa chỉ"></textarea>
				</div>
            </form>
				</div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeAddCustomerModal()">Hủy</button>
            <button type="button" class="btn btn-primary" onclick="createCustomer()">Tạo khách hàng</button>
			</div>
	</div>
</div>

<!-- Add Employee Modal -->
<div class="modal-overlay" id="addEmployeeModal" style="display: none;">
    <div class="modal modal-horizontal">
                    <div class="modal-header">
            <h3><i class="fas fa-user-plus"></i> Thêm nhân viên mới</h3>
            <button class="modal-close" onclick="closeAddEmployeeModal()">
                <i class="fas fa-times"></i>
            </button>
           </div>
         <div class="modal-body">
            <form id="addEmployeeForm">
                                                  <div class="form-row">
                     <div class="form-group">
                        <label class="form-label">Tên nhân viên *</label>
                        <input type="text" class="form-input" name="ten_tk" required placeholder="Nhập tên nhân viên">
                     </div>
                     <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" name="email" placeholder="Nhập email">
                     </div>
                     <div class="form-group">
                        <label class="form-label">Số điện thoại</label>
                        <input type="tel" class="form-input" name="so_dt" placeholder="Nhập số điện thoại">
                     </div>
                 </div>
                
                 <div class="form-row">
                     <div class="form-group">
                        <label class="form-label">Chức vụ</label>
                        <input type="text" class="form-input" name="position" placeholder="Nhập chức vụ">
                     </div>
                     <div class="form-group">
                        <label class="form-label">Phòng ban</label>
                        <input type="text" class="form-input" name="department" placeholder="Nhập phòng ban">
                 </div>
                 <div class="form-group">
                        <label class="form-label">Trạng thái</label>
                        <select class="form-select" name="trang_thai">
                        <option value="true">Hoạt động</option>
                        <option value="false">Không hoạt động</option>
                    </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Địa chỉ</label>
                    <textarea class="form-textarea" name="dia_chi" rows="3" placeholder="Nhập địa chỉ"></textarea>
                </div>
             </form>
         </div>
         <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeAddEmployeeModal()">Hủy</button>
            <button type="button" class="btn btn-primary" onclick="createEmployee()">Tạo nhân viên</button>
         </div>
     </div>
 </div>

<!-- Edit Account Modal -->
<div class="modal-overlay" id="editAccountModal" style="display: none;">
    <div class="modal modal-horizontal">
                     <div class="modal-header">
            <h3><i class="fas fa-user-edit"></i> Chỉnh sửa tài khoản</h3>
            <button class="modal-close" onclick="closeEditAccountModal()">
                <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body">
            <form id="editAccountForm">
                <input type="hidden" name="id">
                <input type="hidden" name="type">
                
                  <div class="form-row">
                      <div class="form-group">
                        <label class="form-label">Tên *</label>
                        <input type="text" class="form-input" name="ten_tk" required>
                      </div>
                      <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" name="email">
                      </div>
                      <div class="form-group">
                        <label class="form-label">Số điện thoại</label>
                        <input type="tel" class="form-input" name="so_dt">
                      </div>
                  </div>
                
                  <div class="form-row">
                      <div class="form-group">
                        <label class="form-label">Trạng thái</label>
                        <select class="form-select" name="trang_thai">
                          <option value="true">Hoạt động</option>
                          <option value="false">Không hoạt động</option>
                      </select>
                  </div>
                    <div class="form-group" id="employeeFields" style="display: none;">
                        <label class="form-label">Chức vụ</label>
                        <input type="text" class="form-input" name="position">
          </div>
                    <div class="form-group" id="employeeFields2" style="display: none;">
                        <label class="form-label">Phòng ban</label>
                        <input type="text" class="form-input" name="department">
      </div>
  </div>

                <div class="form-row" id="customerFields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Tk nợ</label>
                        <input type="text" class="form-input" name="tk_no">
           </div>
                    <div class="form-group">
                        <label class="form-label">Tk có</label>
                        <input type="text" class="form-input" name="tk_co">
       </div>
   </div>

                <div class="form-group">
                    <label class="form-label">Địa chỉ</label>
                    <textarea class="form-textarea" name="dia_chi" rows="3"></textarea>
            </div>
            </form>
                </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeEditAccountModal()">Hủy</button>
            <button type="button" class="btn btn-primary" onclick="updateAccount()">Cập nhật</button>
            </div>
        </div>
    </div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" id="deleteAccountModal" style="display: none;">
    <div class="modal modal-small">
            <div class="modal-header">
            <h3><i class="fas fa-exclamation-triangle"></i> Xác nhận xóa</h3>
            <button class="modal-close" onclick="closeDeleteAccountModal()">
                <i class="fas fa-times"></i>
            </button>
            </div>
            <div class="modal-body">
            <p>Bạn có chắc chắn muốn xóa tài khoản này không?</p>
            <p class="text-gray-600">Hành động này không thể hoàn tác.</p>
            </div>
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeDeleteAccountModal()">Hủy</button>
            <button type="button" class="btn btn-danger" onclick="confirmDeleteAccount()">Xóa</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_css %}
<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--spacing-4);
    margin-bottom: var(--spacing-6);
}

.stat-card {
    background: white;
    border-radius: var(--radius-lg);
    padding: var(--spacing-6);
    box-shadow: var(--shadow-md);
    border: 1px solid var(--gray-200);
    display: flex;
    align-items: center;
    transition: all var(--transition-normal);
}

.stat-card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-2px);
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: var(--radius-lg);
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: var(--spacing-4);
}

.stat-icon i {
    font-size: var(--font-size-xl);
    color: white;
}

.stat-content {
    flex: 1;
}

.stat-number {
    font-size: var(--font-size-2xl);
    font-weight: 700;
    color: var(--gray-900);
    margin-bottom: var(--spacing-1);
}

.stat-label {
    font-size: var(--font-size-sm);
    color: var(--gray-600);
    font-weight: 500;
}

.tabs-container {
    margin-bottom: var(--spacing-6);
}

.tabs {
    display: flex;
    background: white;
    border-radius: var(--radius-lg);
    padding: var(--spacing-1);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--gray-200);
    overflow-x: auto;
}

.tab {
    flex: 1;
    padding: var(--spacing-3) var(--spacing-4);
    border: none;
    background: transparent;
    color: var(--gray-600);
    font-weight: 500;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-normal);
    white-space: nowrap;
}

.tab:hover {
    background: var(--gray-50);
    color: var(--gray-700);
}

.tab.active {
    background: var(--primary-color);
    color: white;
    box-shadow: var(--shadow-sm);
}

.tab-section {
    margin-bottom: var(--spacing-6);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let customersData = [];
let employeesData = [];
let filteredCustomers = [];
let filteredEmployees = [];
let currentCustomerPage = 1;
let currentEmployeePage = 1;
const itemsPerPage = 10;
let deleteAccountId = null;
let currentTab = 'customers';

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    setupEventListeners();
    loadCustomersData();
    loadEmployeesData();
});

// Setup event listeners
function setupEventListeners() {
    // Tab clicks
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const tabType = this.getAttribute('data-tab');
            switchTab(tabType);
        });
    });
    
    // Customer filters
    document.getElementById('searchCustomer').addEventListener('input', debounce(filterCustomers, 300));
    document.getElementById('customerStatusFilter').addEventListener('change', filterCustomers);
    
    // Employee filters
    document.getElementById('searchEmployee').addEventListener('input', debounce(filterEmployees, 300));
    document.getElementById('employeeDepartmentFilter').addEventListener('change', filterEmployees);
    document.getElementById('employeeStatusFilter').addEventListener('change', filterEmployees);
}

// Switch tab
function switchTab(tab) {
    currentTab = tab;
    
    // Update tab buttons
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`.tab[data-tab="${tab}"]`).classList.add('active');
    
    // Show/hide sections
    document.getElementById('customersSection').style.display = tab === 'customers' ? 'block' : 'none';
    document.getElementById('employeesSection').style.display = tab === 'employees' ? 'block' : 'none';
}

// Load customers data
async function loadCustomersData() {
    try {
        const response = await fetch('{{ BACKEND_URL }}/api/accounts/');
        if (response.ok) {
            customersData = await response.json();
            filteredCustomers = [...customersData];
            updateStatistics();
            updateCustomerTable();
            updateCustomerPagination();
        } else {
            console.error('Failed to load customers');
        }
    } catch (error) {
        console.error('Error loading customers:', error);
    }
}

// Load employees data
async function loadEmployeesData() {
    try {
        const response = await fetch('{{ BACKEND_URL }}/api/users/');
        if (response.ok) {
            employeesData = await response.json();
            filteredEmployees = [...employeesData];
            updateStatistics();
            updateEmployeeTable();
            updateEmployeePagination();
            updateDepartmentFilter();
            } else {
            console.error('Failed to load employees');
        }
    } catch (error) {
        console.error('Error loading employees:', error);
    }
}

// Update statistics
function updateStatistics() {
    const totalCustomers = customersData.length;
    const totalEmployees = employeesData.length;
    const activeCustomers = customersData.filter(c => c.trang_thai === true).length;
    const activeEmployees = employeesData.filter(e => e.status === true).length;
    const accountsWithEmail = [...customersData, ...employeesData].filter(a => a.email).length;
    
    document.getElementById('totalCustomers').textContent = totalCustomers;
    document.getElementById('totalEmployees').textContent = totalEmployees;
    document.getElementById('activeAccounts').textContent = activeCustomers + activeEmployees;
    document.getElementById('accountsWithEmail').textContent = accountsWithEmail;
}

// Update department filter
function updateDepartmentFilter() {
    const departments = [...new Set(employeesData.map(e => e.department).filter(Boolean))];
    const select = document.getElementById('employeeDepartmentFilter');
    select.innerHTML = '<option value="">Tất cả phòng ban</option>';
    departments.forEach(dept => {
        const option = document.createElement('option');
        option.value = dept;
        option.textContent = dept;
        select.appendChild(option);
    });
}

// Filter customers
function filterCustomers() {
    const searchTerm = document.getElementById('searchCustomer').value.toLowerCase();
    const statusFilter = document.getElementById('customerStatusFilter').value;
    
    filteredCustomers = customersData.filter(customer => {
        const matchesSearch = !searchTerm || 
                             (customer.ten_tk && customer.ten_tk.toLowerCase().includes(searchTerm)) ||
                             (customer.email && customer.email.toLowerCase().includes(searchTerm)) ||
                             (customer.so_dt && customer.so_dt.toLowerCase().includes(searchTerm));
        
        const matchesStatus = !statusFilter || customer.trang_thai.toString() === statusFilter;
        
        return matchesSearch && matchesStatus;
    });
    
    currentCustomerPage = 1;
    updateCustomerTable();
    updateCustomerPagination();
}

// Filter employees
function filterEmployees() {
    const searchTerm = document.getElementById('searchEmployee').value.toLowerCase();
    const departmentFilter = document.getElementById('employeeDepartmentFilter').value;
    const statusFilter = document.getElementById('employeeStatusFilter').value;
    
    filteredEmployees = employeesData.filter(employee => {
        const matchesSearch = !searchTerm || 
                             (employee.name && employee.name.toLowerCase().includes(searchTerm)) ||
                             (employee.email && employee.email.toLowerCase().includes(searchTerm)) ||
                             (employee.position && employee.position.toLowerCase().includes(searchTerm));
        
        const matchesDepartment = !departmentFilter || employee.department === departmentFilter;
        const matchesStatus = !statusFilter || employee.status.toString() === statusFilter;
        
        return matchesSearch && matchesDepartment && matchesStatus;
    });
    
    currentEmployeePage = 1;
    updateEmployeeTable();
    updateEmployeePagination();
}

// Clear customer filters
function clearCustomerFilters() {
    document.getElementById('searchCustomer').value = '';
    document.getElementById('customerStatusFilter').value = '';
    
    filteredCustomers = [...customersData];
    currentCustomerPage = 1;
    updateCustomerTable();
    updateCustomerPagination();
}

// Clear employee filters
function clearEmployeeFilters() {
    document.getElementById('searchEmployee').value = '';
    document.getElementById('employeeDepartmentFilter').value = '';
    document.getElementById('employeeStatusFilter').value = '';
    
    filteredEmployees = [...employeesData];
    currentEmployeePage = 1;
    updateEmployeeTable();
    updateEmployeePagination();
}

// Update customer table
function updateCustomerTable() {
    const tbody = document.getElementById('customersTableBody');
    const startIndex = (currentCustomerPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageCustomers = filteredCustomers.slice(startIndex, endIndex);
    
    tbody.innerHTML = pageCustomers.map((customer, index) => `
        <tr>
            <td>${startIndex + index + 1}</td>
            <td><strong>${customer.ten_tk || '-'}</strong></td>
            <td>${customer.tk_no || '-'}</td>
            <td>${customer.tk_co || '-'}</td>
            <td>${customer.email || '-'}</td>
            <td>${customer.so_dt || '-'}</td>
            <td>${customer.dia_chi || '-'}</td>
            <td>${getStatusBadge(customer.trang_thai)}</td>
            <td>
                <div class="table-actions">
                    <button class="btn btn-sm btn-primary" onclick="editAccount(${customer.id}, 'customer')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteAccount(${customer.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

// Update employee table
function updateEmployeeTable() {
    const tbody = document.getElementById('employeesTableBody');
    const startIndex = (currentEmployeePage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageEmployees = filteredEmployees.slice(startIndex, endIndex);
    
    tbody.innerHTML = pageEmployees.map((employee, index) => `
        <tr>
            <td>${startIndex + index + 1}</td>
            <td><strong>${employee.name || '-'}</strong></td>
            <td>${employee.position || '-'}</td>
            <td><span class="badge badge-info">${employee.department || '-'}</span></td>
            <td>${employee.email || '-'}</td>
            <td>${employee.phone || '-'}</td>
            <td>${employee.address || '-'}</td>
            <td>${getStatusBadge(employee.status)}</td>
            <td>
                <div class="table-actions">
                    <button class="btn btn-sm btn-primary" onclick="editAccount(${employee.id}, 'employee')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteAccount(${employee.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

// Update customer pagination
function updateCustomerPagination() {
    const totalPages = Math.ceil(filteredCustomers.length / itemsPerPage);
    const pagination = document.getElementById('customersPagination');
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    pagination.innerHTML = generatePaginationHTML(currentCustomerPage, totalPages, 'customers');
}

// Update employee pagination
function updateEmployeePagination() {
    const totalPages = Math.ceil(filteredEmployees.length / itemsPerPage);
    const pagination = document.getElementById('employeesPagination');
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    pagination.innerHTML = generatePaginationHTML(currentEmployeePage, totalPages, 'employees');
}

// Generate pagination HTML
function generatePaginationHTML(currentPage, totalPages, type) {
    let paginationHTML = '';
    
    // Previous button
    paginationHTML += `
        <button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1}, '${type}')">
            <i class="fas fa-chevron-left"></i>
        </button>
    `;
    
    // Page numbers
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        paginationHTML += `<button class="pagination-btn" onclick="goToPage(1, '${type}')">1</button>`;
        if (startPage > 2) {
            paginationHTML += `<span class="text-gray-500">...</span>`;
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
            <button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i}, '${type}')">
                ${i}
            </button>
        `;
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            paginationHTML += `<span class="text-gray-500">...</span>`;
        }
        paginationHTML += `<button class="pagination-btn" onclick="goToPage(${totalPages}, '${type}')">${totalPages}</button>`;
    }
    
    // Next button
    paginationHTML += `
        <button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${currentPage + 1}, '${type}')">
            <i class="fas fa-chevron-right"></i>
        </button>
    `;
    
    return paginationHTML;
}

// Go to page
function goToPage(page, type) {
    if (type === 'customers') {
        const totalPages = Math.ceil(filteredCustomers.length / itemsPerPage);
        if (page >= 1 && page <= totalPages) {
            currentCustomerPage = page;
            updateCustomerTable();
            updateCustomerPagination();
        }
    } else if (type === 'employees') {
        const totalPages = Math.ceil(filteredEmployees.length / itemsPerPage);
        if (page >= 1 && page <= totalPages) {
            currentEmployeePage = page;
            updateEmployeeTable();
            updateEmployeePagination();
        }
    }
}

// Modal functions
function openAddCustomerModal() {
    const modal = document.getElementById('addCustomerModal');
    const form = document.getElementById('addCustomerForm');
    
    modal.style.display = 'flex';
    form.reset();
    
    // Store initial state
    storeModalState('addCustomerModal', form);
}

function closeAddCustomerModal() {
    document.getElementById('addCustomerModal').style.display = 'none';
    clearModalState('addCustomerModal');
    loadCustomersData();
    showSuccessMessage('Thêm thành công!');
}

function openAddEmployeeModal() {
    const modal = document.getElementById('addEmployeeModal');
    const form = document.getElementById('addEmployeeForm');
    
    modal.style.display = 'flex';
    form.reset();
    
    // Store initial state
    storeModalState('addEmployeeModal', form);
}

function closeAddEmployeeModal() {
    document.getElementById('addEmployeeModal').style.display = 'none';
    clearModalState('addEmployeeModal');
    loadEmployeesData();
    showSuccessMessage('Thêm thành công!');
}

function editAccount(id, type) {
    let account;
    if (type === 'customer') {
        account = customersData.find(c => c.id === id);
    } else {
        account = employeesData.find(e => e.id === id);
    }
    
    if (account) {
        const form = document.getElementById('editAccountForm');
        form.querySelector('input[name="id"]').value = account.id;
        form.querySelector('input[name="type"]').value = type;
        form.querySelector('input[name="ten_tk"]').value = account.ten_tk || account.name || '';
        form.querySelector('input[name="email"]').value = account.email || '';
        form.querySelector('input[name="so_dt"]').value = account.so_dt || account.phone || '';
        form.querySelector('select[name="trang_thai"]').value = (account.trang_thai || account.status || false).toString();
        form.querySelector('textarea[name="dia_chi"]').value = account.dia_chi || account.address || '';
        
        if (type === 'employee') {
            document.getElementById('employeeFields').style.display = 'block';
            document.getElementById('employeeFields2').style.display = 'block';
            document.getElementById('customerFields').style.display = 'none';
            form.querySelector('input[name="position"]').value = account.position || '';
            form.querySelector('input[name="department"]').value = account.department || '';
        } else {
            document.getElementById('employeeFields').style.display = 'none';
            document.getElementById('employeeFields2').style.display = 'none';
            document.getElementById('customerFields').style.display = 'block';
            form.querySelector('input[name="tk_no"]').value = account.tk_no || '';
            form.querySelector('input[name="tk_co"]').value = account.tk_co || '';
        }
        
        // Store initial state for edit modal
        storeModalState('editAccountModal', form);
        
        document.getElementById('editAccountModal').style.display = 'flex';
    }
}

function closeEditAccountModal() {
    closeModalWithConfirmation('editAccountModal');
}

function deleteAccount(id) {
    deleteAccountId = id;
    document.getElementById('deleteAccountModal').style.display = 'flex';
}

function closeDeleteAccountModal() {
    document.getElementById('deleteAccountModal').style.display = 'none';
    deleteAccountId = null;
}

async function createCustomer() {
    const form = document.getElementById('addCustomerForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    // Convert boolean
    data.trang_thai = data.trang_thai === 'true';
    
    try {
        const response = await fetch('{{ BACKEND_URL }}/api/accounts/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
                'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            document.getElementById('addCustomerModal').style.display = 'none';
            clearModalState('addCustomerModal');
            loadCustomersData();
            showSuccessMessage('Tạo khách hàng thành công!');
        } else {
            const error = await response.json();
            showErrorMessage(error.detail || 'Có lỗi xảy ra khi tạo khách hàng');
        }
    } catch (error) {
        showErrorMessage('Có lỗi xảy ra khi tạo khách hàng');
    }
}

async function createEmployee() {
    const form = document.getElementById('addEmployeeForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    // Convert boolean
    data.trang_thai = data.trang_thai === 'true';
    
    try {
        const response = await fetch('{{ BACKEND_URL }}/api/users/', {
            method: 'POST',
          headers: {
              'Content-Type': 'application/json',
                'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            document.getElementById('addEmployeeModal').style.display = 'none';
            clearModalState('addEmployeeModal');
            loadEmployeesData();
            showSuccessMessage('Tạo nhân viên thành công!');
            } else {
            const error = await response.json();
            showErrorMessage(error.detail || 'Có lỗi xảy ra khi tạo nhân viên');
        }
    } catch (error) {
        showErrorMessage('Có lỗi xảy ra khi tạo nhân viên');
    }
}

async function updateAccount() {
    const form = document.getElementById('editAccountForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    const id = data.id;
    const type = data.type;
    delete data.id;
    delete data.type;
    
    // Convert boolean
    data.trang_thai = data.trang_thai === 'true';
    
    try {
        const endpoint = type === 'customer' ? 'accounts' : 'users';
        const response = await fetch(`{{ BACKEND_URL }}/api/${endpoint}/${id}`, {
          method: 'PUT',
          headers: {
              'Content-Type': 'application/json',
                'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            document.getElementById('editAccountModal').style.display = 'none';
            clearModalState('editAccountModal');
            if (type === 'customer') {
                loadCustomersData();
            } else {
                loadEmployeesData();
            }
            showSuccessMessage('Cập nhật tài khoản thành công!');
        } else {
            const error = await response.json();
            showErrorMessage(error.detail || 'Có lỗi xảy ra khi cập nhật tài khoản');
        }
    } catch (error) {
        showErrorMessage('Có lỗi xảy ra khi cập nhật tài khoản');
    }
}

async function confirmDeleteAccount() {
    if (!deleteAccountId) return;
    
    try {
        // Try both endpoints
        let response = await fetch(`{{ BACKEND_URL }}/api/accounts/${deleteAccountId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`
            }
        });
        
        if (!response.ok) {
            response = await fetch(`{{ BACKEND_URL }}/api/users/${deleteAccountId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${sessionStorage.getItem('access_token')}`
                }
            });
        }
        
        if (response.ok) {
            closeDeleteAccountModal();
            loadCustomersData();
            loadEmployeesData();
            showSuccessMessage('Xóa tài khoản thành công!');
                 } else {
            const error = await response.json();
            showErrorMessage(error.detail || 'Có lỗi xảy ra khi xóa tài khoản');
        }
    } catch (error) {
        showErrorMessage('Có lỗi xảy ra khi xóa tài khoản');
    }
}

// Utility functions
function getStatusBadge(status) {
    if (status === true || status === 'true') {
        return '<span class="badge badge-success">Hoạt động</span>';
    } else {
        return '<span class="badge badge-danger">Không hoạt động</span>';
    }
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function showSuccessMessage(message) {
    showSuccessModal('Thành công', message);
}

function showErrorMessage(message) {
    showErrorModal('Lỗi', message);
}
</script>
{% endblock %}